<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>MÃ¼vekkil PortalÄ± - Anasayfa</title>
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet"/>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

    /* === GENEL STÄ°LLER === */
    body { font-family: 'Poppins', sans-serif; transition: background-color 0.3s, color 0.3s; }
    
    /* Sidebar & Layout */
    #sidebar { height: 100vh; width: 250px; position: fixed; top: 0; left: 0; padding-top: 20px; z-index: 1001; transition: all 0.3s; }
    #sidebar .nav-link { font-weight: 500; padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; transition: all 0.3s; transform-origin: left; }
    #sidebar .nav-link:hover, #sidebar .nav-link.active { transform: translateX(5px); }
    .content { margin-left: 250px; padding: 40px; transition: margin-left 0.3s; }
    .content-with-topbar { margin-top: 60px; }

    /* Top Header */
    .top-header { position: fixed; top: 0; right: 0; left: 250px; z-index: 1000; display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; height: 60px; transition: all 0.3s; }
    .user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: #1e3c72; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; }
    .logout-btn { background-color: #d9534f; color: #fff; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; }
    .logout-btn:hover { background-color: #c9302c; }

    /* ðŸ”¥ Ã‡Ã–ZÃœM: KullanÄ±cÄ± AlanÄ± HizalamasÄ± */
    .user-section { 
        display: flex; 
        align-items: center; 
        gap: 12px; /* Elemanlar arasÄ± boÅŸluk */
    }
    .user-info { 
        display: flex; 
        flex-direction: column; 
        justify-content: center; 
    }
    .user-name { 
        font-weight: 600; 
        font-size: 0.9rem; 
        line-height: 1.2; 
    }
    .user-role { 
        font-size: 0.75rem; 
        opacity: 0.8; 
    }

    /* Kartlar & Ä°statistikler */
    .card { border-radius: 12px; border: none; transition: transform 0.3s, box-shadow 0.3s; overflow: hidden; }
    .card:hover { transform: translateY(-5px); }
    .card-header { font-weight: 600; border-bottom: 1px solid rgba(0,0,0,0.1); }
    .stat-value { font-size: 2.2em; font-weight: 700; line-height: 1; }
    .stat-icon { font-size: 3rem !important; display: inline-block !important; } /* Ä°kon gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ iÃ§in Ã¶nemli */
    
    /* Tablolar */
    .table-responsive { border-radius: 12px; padding: 20px; }
    .table { font-size: 0.95rem; }
    .table thead th { border-bottom: 2px solid; font-weight: 600; white-space: nowrap; }
    .sortable { cursor: pointer; }
    .accordion-header-row { cursor: pointer; }
    .accordion-header-row .fa-chevron-right { transition: transform 0.3s; }
    .accordion-header-row[aria-expanded="true"] .fa-chevron-right { transform: rotate(90deg); }

    /* === LIGHT MODE (Beyaz Tema) === */
    body.light-mode { background-color: #f0f2f5; color: #333; }
    .light-mode #sidebar { background-color: #ffffff; box-shadow: 2px 0 10px rgba(0,0,0,0.05); }
    .light-mode #sidebar .nav-link { color: #555; }
    .light-mode #sidebar .nav-link:hover, .light-mode #sidebar .nav-link.active { background-color: #e3f2fd; color: #1e88e5; }
    .light-mode .top-header { background-color: #ffffff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .light-mode .card { background-color: #ffffff; color: #333; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .light-mode .table-responsive { background-color: #ffffff; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .light-mode .table tbody tr:hover { background-color: #f8f9fa; }
    
    /* Modal Light */
    .light-mode .modal-content { background-color: #ffffff; border: 1px solid #dee2e6; color: #333; }
    .light-mode .modal-header, .light-mode .modal-footer { border-color: #dee2e6; }
    .light-mode .nav-tabs { border-bottom: 1px solid #dee2e6; }
    .light-mode .nav-tabs .nav-link { color: #555; background-color: #f8f9fa; margin-right: 2px; }
    .light-mode .nav-tabs .nav-link.active { background-color: #ffffff; color: #1e3c72; border-color: #dee2e6 #dee2e6 #ffffff; }
    .light-mode .tab-content-card { background-color: #ffffff; border: 1px solid #dee2e6; border-top: none; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

    /* === DARK MODE (Koyu Tema) === */
    body.dark-mode { background-color: #2b2d31; color: #e0e0e0; }
    
    /* Sidebar & Header */
    .dark-mode #sidebar { background-color: #36393e; box-shadow: 2px 0 10px rgba(0,0,0,0.2); }
    .dark-mode #sidebar .nav-link { color: #b0b8c0; }
    .dark-mode #sidebar .nav-link:hover { background-color: #3a3f45; color: #b0b8c0; transform: translateX(3px); }
    .dark-mode #sidebar .nav-link.active { background-color: #40444b; color: #4da6ff; transform: translateX(5px); }
    .dark-mode .top-header { background-color: #36393e; box-shadow: 0 2px 5px rgba(0,0,0,0.3); border-bottom: 1px solid #40444b; }
    
    /* Kartlar */
    .dark-mode .card { background-color: #36393e; color: #e0e0e0; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .dark-mode .card-header { background-color: #40444b; border-bottom: 1px solid #585b63; color: #f8f9fa; }
    
    /* Tablolar */
    .dark-mode .table-responsive { background-color: #36393e; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .dark-mode .table { color: #e0e0e0; }
    .dark-mode .table thead th { border-bottom: 2px solid #585b63; color: #f8f9fa; border-color: #585b63; }
    .dark-mode .table td, .dark-mode .table th { border-top: 1px solid #585b63; }
    .dark-mode .table-hover tbody tr:hover { background-color: #40444b !important; color: #e0e0e0 !important; }
    
    /* Modal & Tabs */
    .dark-mode .modal-content { background-color: #36393e; color: #e0e0e0; border: 1px solid #585b63; }
    .dark-mode .modal-header { border-bottom: 1px solid #585b63; }
    .dark-mode .modal-footer { border-top: 1px solid #585b63; }
    .dark-mode .close { color: #fff; opacity: 0.8; text-shadow: none; }
    .dark-mode .close:hover { opacity: 1; }
    
    .dark-mode .nav-tabs { border-bottom: 1px solid #585b63; }
    .dark-mode .nav-tabs .nav-link { color: #b0b8c0; background-color: #3a3f45; border-color: #3a3f45; margin-right: 2px; }
    .dark-mode .nav-tabs .nav-link.active { background-color: #30343a !important; color: #4da6ff !important; border-color: #585b63 #585b63 #30343a; }
    .dark-mode .tab-content-card { background-color: #30343a; border: 1px solid #585b63; border-top: none; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    
    /* Form ElemanlarÄ± */
    .dark-mode .form-control { background-color: #40444b; border-color: #585b63; color: #e0e0e0; }
    .dark-mode .form-control:focus { background-color: #40444b; color: #fff; border-color: #4da6ff; }
    
    /* Task KartlarÄ± */
    .task-card { border-left: 5px solid; border-radius: 12px; padding: 20px; margin-bottom: 20px; position: relative; padding-top: 35px !important; transition: transform 0.3s; }
    .light-mode .task-card { background-color: #fff; border: 1px solid #eee; border-left-width: 5px; }
    .dark-mode .task-card { background-color: #36393e; border: 1px solid #585b63; border-left-width: 5px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .task-card-success { border-left-color: #5cb85c; }
    .task-card-warning { border-left-color: #f0ad4e; }
    .task-card-danger { border-left-color: #d9534f; }
    .task-number-tag { position: absolute; top: 8px; left: 15px; font-size: 1.3rem; font-weight: 700; color: #4da6ff; opacity: 0.9; }
    
    /* GÃ¶rseller */
    img.brand-thumb, .task-brand-image { height: 100px !important; width: auto; border-radius: 6px; object-fit: contain; transition: transform 0.3s; display: block; margin: 0 auto; background-color: #fff; padding: 2px; }
    img.brand-thumb:hover, .task-brand-image:hover { transform: scale(2.5); z-index: 999; position: relative; box-shadow: 0 8px 16px rgba(0,0,0,0.3); }

    @media (max-width: 576px) { 
        #sidebar { width: 0; overflow: hidden; }
        .content, .top-header { margin-left: 0; left: 0; width: 100%; }
    }
    
    /* === EK STÄ°LLER === */
    .table .badge { font-size: 0.9rem !important; padding: 0.6em 1em !important; font-weight: 500; }
    .dark-mode .task-card .task-title { color: #4da6ff !important; font-weight: 600; }
    .dark-mode .task-card .task-meta, .dark-mode .task-card .task-meta i { color: #f0ad4e !important; }
    
    /* Akordeon DÃ¼zeltmeleri */
    .dark-mode .collapse .table, .dark-mode .accordion-table, .dark-mode .accordion-table.bg-light {
        background-color: #2b2d31 !important; 
        color: #b0b8c0 !important;
        border: 1px solid #40444b;
    }
    .dark-mode .accordion-table th, .dark-mode .accordion-table td {
        border-color: #40444b !important;
        background-color: transparent !important;
        color: inherit !important;
    }
    
    /* === Ä°TÄ°RAZ TABLOSU KOLON AYARLARI === */
    #dava-itiraz-list table { table-layout: fixed; width: 100%; }

    /* Kolon 1: # (SÄ±ra No) */
    #dava-itiraz-list th:nth-child(1), 
    #dava-itiraz-list td:nth-child(1) { width: 3%; }

    /* Kolon 2: MenÅŸe */
    #dava-itiraz-list th:nth-child(2), 
    #dava-itiraz-list td:nth-child(2) { width: 6%; }

    /* Kolon 3: Marka Ã–rneÄŸi (GÃ¶rsel) */
    #dava-itiraz-list th:nth-child(3), 
    #dava-itiraz-list td:nth-child(3) { width: 8%; }

    /* Kolon 4: M/T/B AdÄ± */
    #dava-itiraz-list th:nth-child(4), 
    #dava-itiraz-list td:nth-child(4) { width: 10%; word-wrap: break-word; white-space: normal; }

    /* Kolon 5: Ä°ÅŸlem Tipi */
    #dava-itiraz-list th:nth-child(5), 
    #dava-itiraz-list td:nth-child(5) { width: 12%; word-wrap: break-word; white-space: normal; }

    /* DiÄŸer Kolonlar (Standart) */
    #dava-itiraz-list th:nth-child(6), #dava-itiraz-list td:nth-child(6) { width: 7%; } /* BaÅŸvuru No */
    #dava-itiraz-list th:nth-child(7), #dava-itiraz-list td:nth-child(7) { width: 20%; word-wrap: break-word; white-space: normal; } /* BaÅŸvuru Sahibi */
    #dava-itiraz-list th:nth-child(8), #dava-itiraz-list td:nth-child(8) { width: 8%; } /* BÃ¼lten Tarihi */
    #dava-itiraz-list th:nth-child(9), #dava-itiraz-list td:nth-child(9) { width: 6%; }  /* BÃ¼lten No */
    #dava-itiraz-list th:nth-child(10), #dava-itiraz-list td:nth-child(10) { width: 8%; } /* Ä°ÅŸlem Tarihi */
    #dava-itiraz-list th:nth-child(11), #dava-itiraz-list td:nth-child(11) { width: 10%; } /* Durum */
    #dava-itiraz-list th:nth-child(12), #dava-itiraz-list td:nth-child(12) { width: 6%; }  /* Evrak */

 /* === MARKA GÃ–RSELÄ° (Ã‡ERÃ‡EVE VE SIÄžDIRMA) === */
    .table td.col-sample {
        height: 110px; /* HÃ¼crenin sabit yÃ¼ksekliÄŸi */
        width: 120px;  /* HÃ¼crenin sabit geniÅŸliÄŸi */
        vertical-align: middle !important;
        text-align: center;
        padding: 4px;
    }

    /* GÃ¶rsel ne kadar bÃ¼yÃ¼k olursa olsun bu kutuya sÄ±ÄŸar */
    .table .brand-thumb {
        max-height: 100px !important;
        max-width: 100px !important;
        height: auto !important;
        width: auto !important;
        object-fit: contain; /* Kilit kod: GÃ¶rseli bozmadan kutuya sÄ±ÄŸdÄ±rÄ±r */
        display: block;
        margin: 0 auto;
        background-color: #fff;
        padding: 2px;
        border: 1px solid #eee;
        border-radius: 4px;
        transition: transform 0.3s ease;
    }

    /* Task kartlarÄ±ndaki gÃ¶rseller iÃ§in de aynÄ±sÄ± */
    .task-brand-image {
        height: 100px !important; 
        width: auto; 
        object-fit: contain;
    }

    /* Hover Efekti (DokunulmadÄ±, olduÄŸu gibi kalacak) */
    .table .brand-thumb:hover,
    .task-brand-image:hover {
        transform: scale(2.5);
        z-index: 9999;
        position: relative;
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        border-color: #ccc;
    }

    /* === SIRALAMA (SORTING) Ä°KONLARI === */
    .sortable {
        cursor: pointer;
        position: relative;
        padding-right: 18px !important;
        user-select: none;
    }
    .sortable:hover {
        background-color: rgba(0,0,0,0.05);
    }
    .dark-mode .sortable:hover {
        background-color: rgba(255,255,255,0.05);
    }
    /* Pasif ikon */
    .sortable i {
        font-size: 0.8em;
        margin-left: 5px;
        opacity: 0.3;
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
    }
    /* Aktif ikon */
    .sortable.sort-asc i, .sortable.sort-desc i {
        opacity: 1;
        color: #007bff;
    }

    /* === KOLON FÄ°LTRE MENÃœSÃœ === */
    .filter-icon {
        color: #ccc;
        margin-left: 8px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: color 0.2s;
        z-index: 10; /* Sort click'i engellemek iÃ§in */
        position: relative;
    }
    .filter-icon:hover, .filter-icon.active {
        color: #007bff; /* Aktif renk */
    }
    
    /* Filtre Dropdown Kutusu */
    .column-filter-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        padding: 10px;
        min-width: 200px;
        z-index: 1050;
        display: none; /* VarsayÄ±lan gizli */
        color: #333;
        text-align: left;
        font-weight: normal;
    }
    
    .dark-mode .column-filter-dropdown {
        background: #36393e;
        border-color: #585b63;
        color: #e0e0e0;
    }

    .column-filter-dropdown .filter-option {
        display: block;
        padding: 4px 0;
        font-size: 0.9rem;
    }
    
    .column-filter-dropdown input[type="checkbox"] {
        margin-right: 8px;
        vertical-align: middle;
    }

    .filter-actions {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: space-between;
    }
    .dark-mode .filter-actions { border-top-color: #585b63; }

    /* Filtre iÃ§i arama kutusu */
    .filter-search-input {
        width: 100%;
        padding: 6px 10px;
        margin-bottom: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.85rem;
        box-sizing: border-box; /* Padding dahil geniÅŸlik */
    }
    .dark-mode .filter-search-input {
        background-color: #40444b;
        border-color: #585b63;
        color: #e0e0e0;
    }
    .dark-mode .filter-search-input::placeholder {
        color: #888;
    }
    
    /* Checkbox listesi iÃ§in kaydÄ±rma alanÄ± */
    .filter-options-container {
        max-height: 200px;
        overflow-y: auto;
        border-top: 1px solid #eee;
        padding-top: 5px;
    }
    .dark-mode .filter-options-container {
        border-top-color: #585b63;
    }

    /* Rapor KartlarÄ± Ä°Ã§in Sol Ã‡izgi Renkleri */
    .border-left-primary { border-left: 4px solid #4e73df !important; }
    .border-left-success { border-left: 4px solid #1cc88a !important; }
    .border-left-info { border-left: 4px solid #36b9cc !important; }
    .border-left-warning { border-left: 4px solid #f6c23e !important; }

    #modal-islemler table td:first-child { white-space: nowrap !important; width: 1%; min-width: 60px; }
    a i.fa-file-pdf, a i.fa-file-word, a i.fa-file-alt { font-size: 1.3rem !important; vertical-align: middle; }

</style>
</head>
<body>
<header class="top-header">
    <div class="theme-toggle custom-control custom-switch">
        <input class="custom-control-input" id="themeSwitch" type="checkbox"/>
        <label class="custom-control-label" for="themeSwitch" style="color: #b0b8c0;">Koyu Tema</label>
    </div>
    <div class="client-selector ml-3 mr-auto" style="display:none;" id="clientSelectorContainer">
        <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="clientSelectBtn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="fas fa-users mr-2"></i> <span id="currentClientName">TÃ¼m MÃ¼ÅŸteriler</span>
            </button>
            <div class="dropdown-menu" aria-labelledby="clientSelectBtn" id="clientDropdownMenu">
                </div>
        </div>
    </div>
    <div class="user-section">
        <div class="user-avatar" id="userAvatar">?</div>
        <div class="user-info"><div class="user-name" id="userName">...</div><div class="user-role" id="userRole">KullanÄ±cÄ±</div></div>
        <button class="logout-btn" id="logoutBtn">Ã‡Ä±kÄ±ÅŸ</button>
    </div>
</header>

<div id="sidebar">
    <img src="./logo.png" alt="Evreka PortalÄ±" class="d-block mx-auto mb-4" style="height: 180px;">
    <ul class="nav flex-column">
        <li class="nav-item"><a aria-controls="dashboard" class="nav-link active" data-toggle="tab" href="#dashboard" role="tab"><i class="fas fa-tachometer-alt mr-2"></i>Dashboard</a></li>
        <li class="nav-item"><a aria-controls="portfolio-content" class="nav-link" data-toggle="tab" href="#portfolio-content" role="tab"><i class="fas fa-folder-open mr-2"></i>PortfÃ¶yÃ¼m</a></li>
        <li class="nav-item"><a aria-controls="tasks" class="nav-link" data-toggle="tab" href="#tasks" role="tab"><i class="fas fa-tasks mr-2"></i>Ä°ÅŸlerim</a></li>
        <li class="nav-item"><a aria-controls="invoices" class="nav-link" data-toggle="tab" href="#invoices" role="tab"><i class="fas fa-file-invoice-dollar mr-2"></i>FaturalarÄ±m</a></li>
        <li class="nav-item"><a aria-controls="contracts" class="nav-link" data-toggle="tab" href="#contracts" role="tab"><i class="fas fa-file-contract mr-2"></i>Vekalet/SÃ¶zleÅŸme</a></li>
        <li class="nav-item"><a aria-controls="reports" class="nav-link" data-toggle="tab" href="#reports" role="tab"><i class="fas fa-chart-bar mr-2"></i>Raporlar</a></li>
    </ul>
</div>

<div class="content content-with-topbar">
    <div class="tab-content">
        <div class="tab-pane fade show active" id="dashboard">
            <h1 class="header-title">HoÅŸ Geldiniz, <span id="welcomeUserName">...</span></h1>
            <p class="lead">PortalÄ±nÄ±zda portfÃ¶yÃ¼nÃ¼zÃ¼, iÅŸlerinizi ve finansal bilgilerinizi yÃ¶netebilirsiniz.</p>
            <div class="row mt-5">
                <div class="col-md-12 mb-4" data-target-tab="portfolio-content" id="card-portfolio">
                    <div class="card p-4 text-center d-flex align-items-center flex-row justify-content-center">
                        <i class="fas fa-folder-open stat-icon text-info mr-4"></i>
                        <div><div class="stat-value" id="dashPortfolio">0</div><div class="stat-label">PortfÃ¶y KaydÄ±m</div></div>
                    </div>
                </div>
                <div class="col-md-12 mb-4" data-target-tab="tasks" id="card-tasks">
                    <div class="card p-4 text-center d-flex align-items-center flex-row justify-content-center">
                        <i class="fas fa-tasks stat-icon text-warning mr-4"></i>
                        <div><div class="stat-value" id="dashPendingApprovals">0</div><div class="stat-label">Onay Bekleyen Ä°ÅŸlem</div></div>
                    </div>
                </div>
                <div class="col-md-12 mb-4" data-target-tab="invoices" id="card-invoices">
                    <div class="card p-4 text-center d-flex align-items-center flex-row justify-content-center">
                        <i class="fas fa-file-invoice-dollar stat-icon text-success mr-4"></i>
                        <div><div class="stat-value" id="dashUnpaidInvoices">0</div><div class="stat-label">Ã–denmemiÅŸ Fatura</div></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="portfolio-content">
            <h1 class="header-title">PortfÃ¶yÃ¼m</h1>
                <div class="card p-4 mb-4">
                    <h5 class="card-title">Filtreleme ve Arama</h5>
                    <div class="form-row">
                        <div class="form-group col-md-5">
                            <input class="form-control" id="portfolioSearchText" placeholder="Marka, BaÅŸvuru No vb..." type="text"/>
                        </div>
                        <div class="form-group col-md-3">
                            <select class="form-control" id="portfolioDurumFilter">
                                <option value="TÃœMÃœ">TÃ¼mÃ¼</option>
                                <option value="BaÅŸvuru">BaÅŸvuru</option>
                                <option value="Tescilli">Tescilli</option>
                                <option value="Ä°tiraz">Ä°tiraz</option>
                            </select>
                        </div>
                        <div class="form-group col-md-2">
                            <button class="btn btn-primary btn-block" id="portfolioFilterBtn">Filtrele</button>
                        </div>
                        <div class="form-group col-md-2">
                            <div class="btn-group btn-block">
                                <button type="button" class="btn btn-success" onclick="window.exportActiveTable('excel')" title="Excel'e Aktar"><i class="fas fa-file-excel"></i></button>
                                <button type="button" class="btn btn-danger" onclick="window.exportActiveTable('pdf')" title="PDF'e Aktar"><i class="fas fa-file-pdf"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            <div class="d-flex align-items-center justify-content-between flex-wrap mb-2" id="portfolioTabsBar">
                <ul class="nav nav-tabs mb-2 mb-sm-0" id="portfolioTopTabs" role="tablist">
                    <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#marka-list" role="tab">Marka</a></li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#patent-list" role="tab">Patent</a></li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#tasarim-list" role="tab">TasarÄ±m</a></li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#dava-itiraz-list" role="tab">Ä°tiraz</a></li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#dava-list" role="tab">Dava</a></li>
                    <li class="nav-item d-flex align-items-center pl-2" id="portfolioFiltersNavItem">
                        <label class="mb-0 mr-2">MenÅŸe:</label>
                        <select class="form-control form-control-sm" id="menseFilter"><option selected value="TÃœRKPATENT">TÃœRKPATENT</option><option value="YURTDISI">YurtdÄ±ÅŸÄ±</option><option value="HEPSI">Hepsi</option></select>
                    </li>
                </ul>
            </div>
            <div class="tab-content table-responsive mt-3">
                <div class="tab-pane fade show active" id="marka-list">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="index"># <i class="fas fa-sort"></i></th>
                                
                                <th class="col-origin sortable filterable" data-sort="text" data-col-idx="1">
                                    MenÅŸe <i class="fas fa-sort"></i> <i class="fas fa-filter filter-icon" onclick="event.stopPropagation(); window.toggleColumnFilter(this, 'marka-list', 1)"></i>
                                </th>
                                
                                <th class="col-sample text-center">Marka Ã–rneÄŸi</th>
                                
                                <th class="sortable filterable" data-sort="text" data-col-idx="3">
                                    Marka <i class="fas fa-sort"></i> <i class="fas fa-filter filter-icon" onclick="event.stopPropagation(); window.toggleColumnFilter(this, 'marka-list', 3)"></i>
                                </th>
                                
                                <th class="sortable" data-sort="text">BaÅŸvuru No <i class="fas fa-sort"></i></th>
                                <th class="col-regno sortable" data-sort="text">Tescil No <i class="fas fa-sort"></i></th>
                                <th class="col-appdate sortable" data-sort="date">BaÅŸvuru Tarihi <i class="fas fa-sort"></i></th>
                                <th class="sortable" data-sort="date">Yenileme Tarihi <i class="fas fa-sort"></i></th>
                                <th class="sortable filterable" data-sort="text" data-col-idx="7">Durum <i class="fas fa-sort"></i> <i class="fas fa-filter filter-icon" onclick="event.stopPropagation(); window.toggleColumnFilter(this, 'marka-list', 7)"></i></th>
                                <th class="col-classes sortable" data-sort="text">SÄ±nÄ±flar <i class="fas fa-sort"></i></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <div id="markaPagination"></div>
                </div>
                <div class="tab-pane fade" id="patent-list"><table class="table table-hover"><thead><tr><th>#</th><th>BaÅŸlÄ±k</th><th>BaÅŸvuru No</th><th>Durum</th><th>BaÅŸvuru Tarihi</th></tr></thead><tbody></tbody></table></div>
                <div class="tab-pane fade" id="tasarim-list"><table class="table table-hover"><thead><tr><th>#</th><th class="text-center">GÃ¶rsel</th><th>TasarÄ±m AdÄ±</th><th>BaÅŸvuru No</th><th>Durum</th><th>SÄ±nÄ±flar</th></tr></thead><tbody></tbody></table></div>
                
                <div class="tab-pane fade" id="dava-itiraz-list">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="index"># <i class="fas fa-sort"></i></th>
                                <th class="col-origin sortable" data-sort="text">MenÅŸe <i class="fas fa-sort"></i></th>
                                <th class="text-center">Marka Ã–rneÄŸi</th>
                                
                                <th class="sortable filterable" data-sort="text" data-col-idx="3">
                                    M/T/B AdÄ± <i class="fas fa-sort"></i> <i class="fas fa-filter filter-icon" onclick="event.stopPropagation(); window.toggleColumnFilter(this, 'dava-itiraz-list', 3)"></i>
                                </th>
                                <th class="sortable filterable" data-sort="text" data-col-idx="4">
                                    Ä°ÅŸlem Tipi <i class="fas fa-sort"></i> <i class="fas fa-filter filter-icon" onclick="event.stopPropagation(); window.toggleColumnFilter(this, 'dava-itiraz-list', 4)"></i>
                                </th>
                                
                                <th class="sortable" data-sort="text">BaÅŸvuru No <i class="fas fa-sort"></i></th>
                                
                                <th class="sortable filterable" data-sort="text" data-col-idx="6">
                                    BaÅŸvuru Sahibi <i class="fas fa-sort"></i> <i class="fas fa-filter filter-icon" onclick="event.stopPropagation(); window.toggleColumnFilter(this, 'dava-itiraz-list', 6)"></i>
                                </th>
                                
                                <th class="sortable" data-sort="date">BÃ¼lten Tarihi <i class="fas fa-sort"></i></th>
                                <th class="sortable" data-sort="text">BÃ¼lten No <i class="fas fa-sort"></i></th>
                                <th class="sortable" data-sort="date">Ä°ÅŸlem Tarihi <i class="fas fa-sort"></i></th>
                                
                                <th class="sortable filterable" data-sort="text" data-col-idx="10">
                                    Durum <i class="fas fa-sort"></i> <i class="fas fa-filter filter-icon" onclick="event.stopPropagation(); window.toggleColumnFilter(this, 'dava-itiraz-list', 10)"></i>
                                </th>
                                
                                <th>Evrak</th>
                            </tr>
                        </thead>
                        <tbody id="dava-itiraz-tbody"></tbody>
                    </table>
                    <div id="davaItirazPagination"></div>
                </div>
                <div class="tab-pane fade" id="dava-list">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="index"># <i class="fas fa-sort"></i></th>
                                
                                <th class="sortable filterable" data-sort="text" data-col-idx="1">
                                    Dava No <i class="fas fa-sort"></i> <i class="fas fa-filter filter-icon" onclick="event.stopPropagation(); window.toggleColumnFilter(this, 'dava-list', 1)"></i>
                                </th>
                                <th class="sortable filterable" data-sort="text" data-col-idx="2">
                                    BaÅŸlÄ±k <i class="fas fa-sort"></i> <i class="fas fa-filter filter-icon" onclick="event.stopPropagation(); window.toggleColumnFilter(this, 'dava-list', 2)"></i>
                                </th>
                                
                                <th class="sortable" data-sort="text">Konu VarlÄ±k <i class="fas fa-sort"></i></th>
                                
                                <th class="sortable filterable" data-sort="text" data-col-idx="4">
                                    Mahkeme <i class="fas fa-sort"></i> <i class="fas fa-filter filter-icon" onclick="event.stopPropagation(); window.toggleColumnFilter(this, 'dava-list', 4)"></i>
                                </th>
                                <th class="sortable filterable" data-sort="text" data-col-idx="5">
                                    KarÅŸÄ± Taraf <i class="fas fa-sort"></i> <i class="fas fa-filter filter-icon" onclick="event.stopPropagation(); window.toggleColumnFilter(this, 'dava-list', 5)"></i>
                                </th>
                                
                                <th class="sortable" data-sort="date">AÃ§Ä±lÄ±ÅŸ Tarihi <i class="fas fa-sort"></i></th>
                                
                                <th class="sortable filterable" data-sort="text" data-col-idx="7">
                                    Durum <i class="fas fa-sort"></i> <i class="fas fa-filter filter-icon" onclick="event.stopPropagation(); window.toggleColumnFilter(this, 'dava-list', 7)"></i>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="dava-tbody"></tbody>
                    </table>
                    <div id="davaPagination"></div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tasks">
            <h1 class="header-title" id="tasksHeaderTitle">Ä°ÅŸlerim</h1>
            <p class="lead" id="tasksLeadText">LÃ¼tfen incelemek istediÄŸiniz fikri mÃ¼lkiyet tÃ¼rÃ¼nÃ¼ seÃ§in.</p>
            
            <div class="row mt-5" id="task-main-cards">
                <div class="col-md-3 mb-4 task-card-link" data-target-area="marka-tasks"><div class="card p-4 text-center h-100 justify-content-center"><i class="fas fa-registered stat-icon text-info mb-3"></i><div class="stat-label">Marka Ä°ÅŸlemleri</div><div class="stat-value" id="taskCount-marka-total">0</div></div></div>
                <div class="col-md-3 mb-4 task-card-link" data-target-area="patent-tasks"><div class="card p-4 text-center h-100 justify-content-center"><i class="fas fa-microchip stat-icon text-warning mb-3"></i><div class="stat-label">Patent Ä°ÅŸlemleri</div></div></div>
                <div class="col-md-3 mb-4 task-card-link" data-target-area="tasarim-tasks"><div class="card p-4 text-center h-100 justify-content-center"><i class="fas fa-palette stat-icon text-success mb-3"></i><div class="stat-label">TasarÄ±m Ä°ÅŸlemleri</div></div></div>
                <div class="col-md-3 mb-4 task-card-link" data-target-area="dava-tasks">
                    <div class="card p-4 text-center h-100 justify-content-center">
                        <i class="fas fa-gavel stat-icon text-danger mb-3"></i>
                        <div class="stat-label">Dava Ä°ÅŸlemleri</div>
                        <div class="stat-value" id="taskCount-dava-total">0</div>
                    </div>
                </div>
            </div>

            <div class="row mt-5" id="task-detail-cards" style="display: none;">
                <div class="col-md-3 mb-4 detail-card-link" data-task-type="pending-approval"><div class="card p-3 text-center h-100 justify-content-center"><i class="fas fa-tasks stat-icon text-warning mb-3"></i><div class="stat-label">Onay Bekleyen Ä°ÅŸler</div><div class="stat-value" id="taskCount-pending-approval">0</div></div></div>
                <div class="col-md-3 mb-4 detail-card-link" data-task-type="renewal-approval"><div class="card p-3 text-center h-100 justify-content-center"><i class="fas fa-sync-alt stat-icon text-info mb-3"></i><div class="stat-label">Yenileme OnaylarÄ±</div><div class="stat-value" id="taskCount-renewal-approval">0</div></div></div>
                <div class="col-md-3 mb-4 detail-card-link" data-task-type="bulletin-watch"><div class="card p-3 text-center h-100 justify-content-center"><i class="fas fa-eye stat-icon text-primary mb-3"></i><div class="stat-label">BÃ¼lten Ä°zleme Bildirim OnaylarÄ±</div><div class="stat-value" id="taskCount-bulletin-watch">0</div></div></div>
                <div class="col-md-3 mb-4 detail-card-link" data-task-type="completed-tasks"><div class="card p-3 text-center h-100 justify-content-center"><i class="fas fa-check-circle stat-icon text-success mb-3"></i><div class="stat-label">Talimat Verilen/Tamamlanan Ä°ÅŸler</div></div></div>
            </div>
            
            <div class="row mt-5" id="dava-task-detail-cards" style="display: none;">
                <div class="col-md-6 mb-4 detail-card-link" data-task-type="dava-pending">
                    <div class="card p-4 text-center h-100 justify-content-center shadow-sm" style="cursor: pointer;">
                        <i class="fas fa-gavel stat-icon text-warning mb-3" style="font-size: 3rem; display: inline-block;"></i>
                        <div class="stat-label font-weight-bold">MÃ¼vekkil OnayÄ± Bekleyen Ä°ÅŸler</div>
                        <div class="stat-value" id="taskCount-dava-pending">0</div>
                        <small class="text-muted">Dava sÃ¼reciyle ilgili onayÄ±nÄ±zÄ± bekleyen talimatlar</small>
                    </div>
                </div>
                
                <div class="col-md-6 mb-4 detail-card-link" data-task-type="dava-completed">
                    <div class="card p-4 text-center h-100 justify-content-center shadow-sm" style="cursor: pointer;">
                        <i class="fas fa-folder-open stat-icon text-success mb-3" style="font-size: 3rem; display: inline-block;"></i>
                        <div class="stat-label font-weight-bold">Talimat Verilen / Tamamlanan Ä°ÅŸler</div>
                        <small class="text-muted">Devam eden veya sonuÃ§lanan dava sÃ¼reÃ§leri</small>
                    </div>
                </div>
            </div>

            <div class="row mt-4" id="task-list-filters" style="display: none;">
                <div class="col-12"><div class="card p-3"><div class="form-row align-items-end"><div class="form-group col-md-5 mb-0"><label class="text-muted">Ara</label><input class="form-control form-control-sm" id="taskSearchText" type="text"/></div><div class="form-group col-md-4 mb-0"><label class="text-muted">Durum</label><select class="form-control form-control-sm" id="taskStatusFilter"><option value="TÃœMÃœ">TÃ¼mÃ¼</option></select></div><div class="form-group col-md-3 mb-0"><button class="btn btn-primary btn-sm btn-block" id="applyTaskFilters">Filtrele</button></div></div></div></div>
            </div>

            <div class="row mt-4" id="task-list-details" style="display: none;">
                <div class="col-12" id="task-list-container"></div>
                <div class="col-12" id="taskPagination"></div>
            </div>
        </div> <div class="fade tab-pane" id="invoices">
            <h1 class="header-title">FaturalarÄ±m</h1>
            <div class="card p-4 mb-4">
                <h5 class="card-title">Filtreleme</h5>
                <div class="form-row">
                    <div class="form-group col-md-6"><input class="form-control" id="invoiceSearchText" placeholder="Ara..." type="text"/></div>
                    <div class="form-group col-md-3">
                        <select class="form-control" id="invoiceDurumFilter">
                            <option value="TÃœMÃœ">TÃ¼mÃ¼</option>
                            <option value="unpaid">Ã–denmemiÅŸ</option>
                            <option value="paid">Ã–dendi</option>
                            <option value="partially_paid">KÄ±smen Ã–dendi</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="table-responsive mt-4">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="text">Fatura No <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-sort="text">Ä°ÅŸ No <i class="fas fa-sort"></i></th>
                            
                            <th class="sortable" data-sort="text">BaÅŸvuru No <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-sort="date">Tarih <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-sort="text">AÃ§Ä±klama <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-sort="amount">Resmi Ãœcret <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-sort="amount">Hizmet Ãœcreti <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-sort="amount">Toplam Tutar <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-sort="text">Durum <i class="fas fa-sort"></i></th>
                            <th>Fatura/Debit</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="invoices-pagination-container"></div>
        </div>
            <div class="tab-pane fade" id="contracts" role="tabpanel">
                <h1 class="header-title">Vekalet ve SÃ¶zleÅŸmeler</h1>
                
                <div class="card p-4 mb-4 shadow-sm">
                    <h5 class="card-title">Filtreleme</h5>
                    <div class="form-row">
                        <div class="form-group col-md-12">
                            <input class="form-control" id="contractsSearchText" placeholder="Belge tÃ¼rÃ¼ veya Ã¼lke ara..." type="text"/>
                        </div>
                    </div>
                </div>

                <div class="card p-4 shadow-sm">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="index" style="width: 5%;"># <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="text" style="width: 30%;">Belge TÃ¼rÃ¼ <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="text" style="width: 25%;">Ãœlke <i class="fas fa-sort"></i></th>
                                    <th class="sortable" data-sort="date" style="width: 20%;">GeÃ§erlilik Tarihi <i class="fas fa-sort"></i></th>
                                    <th class="text-center" style="width: 20%;">Ä°ÅŸlem</th>
                                </tr>
                            </thead>
                            <tbody id="contractsTableBody">
                                </tbody>
                        </table>
                        
                        <div id="noContractsMessage" class="text-center p-5 text-muted" style="display:none;">
                            <div class="mb-3">
                                <i class="fas fa-folder-open fa-3x" style="opacity: 0.3;"></i>
                            </div>
                            <p>KayÄ±t bulunamadÄ±.</p>
                        </div>

                        <div id="contractsPagination" class="mt-3"></div>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="reports" role="tabpanel" aria-labelledby="reports-tab">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="header-title">YÃ¶netim ve Performans RaporlarÄ±</h1>
                    <div>
                        <button class="btn btn-outline-secondary btn-sm mr-2" onclick="window.initReports()"><i class="fas fa-sync-alt"></i> Verileri Yenile</button>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3 bg-white d-flex flex-row align-items-center justify-content-between">
                                <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-globe-americas mr-2"></i>Global VarlÄ±k DaÄŸÄ±lÄ±mÄ±</h6>
                                <span class="badge badge-primary badge-pill" id="rep-total-countries">0 Ãœlke</span>
                            </div>
                            <div class="card-body p-0">
                                <div id="world-map-markers" style="height: 450px; width: 100%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card p-3 border-left-primary shadow-sm h-100">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-muted small text-uppercase font-weight-bold">Toplam VarlÄ±k</div>
                                    <div class="h3 mb-0 font-weight-bold text-gray-800" id="rep-total-assets">-</div>
                                </div>
                                <i class="fas fa-folder fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card p-3 border-left-warning shadow-sm h-100">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-muted small text-uppercase font-weight-bold">Onay Bekleyen Ä°ÅŸ</div>
                                    <div class="h3 mb-0 font-weight-bold text-gray-800" id="rep-pending-tasks">-</div>
                                </div>
                                <i class="fas fa-clock fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card p-3 border-left-danger shadow-sm h-100">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-muted small text-uppercase font-weight-bold">Aktif Dava/Ä°tiraz</div>
                                    <div class="h3 mb-0 font-weight-bold text-gray-800" id="rep-active-legal">-</div>
                                </div>
                                <i class="fas fa-gavel fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card p-3 border-left-success shadow-sm h-100">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="text-muted small text-uppercase font-weight-bold">Tahmini BÃ¼tÃ§e (YÄ±llÄ±k)</div>
                                    <div class="h3 mb-0 font-weight-bold text-gray-800" id="rep-budget-est">-</div>
                                </div>
                                <i class="fas fa-coins fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <h5 class="mb-3 text-gray-800 border-bottom pb-2">Hukuki ve Operasyonel Analiz</h5>
                <div class="row">
                    <div class="col-lg-4 mb-4">
                        <div class="card shadow mb-4 h-100">
                            <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-danger">Hukuki SÃ¼reÃ§ Durumu</h6></div>
                            <div class="card-body">
                                <div id="chart-legal-status"></div>
                                <div class="mt-2 text-center small text-muted">Aktif Dava ve Ä°tirazlarÄ±n DaÄŸÄ±lÄ±mÄ±</div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-8 mb-4">
                        <div class="card shadow mb-4 h-100">
                            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                                <h6 class="m-0 font-weight-bold text-warning">Ä°lerleme Bekleyen Ä°ÅŸler (>6 Ay)</h6>
                                <small class="text-danger font-weight-bold">Kritik UyarÄ±lar</small>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-striped table-sm mb-0">
                                        <thead class="thead-light">
                                            <tr>
                                                <th>Marka/Konu</th>
                                                <th>Ä°ÅŸlem Tipi</th>
                                                <th>Bekleme SÃ¼resi</th>
                                                <th>Durum</th>
                                            </tr>
                                        </thead>
                                        <tbody id="rep-stuck-list">
                                            </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <h5 class="mb-3 text-gray-800 border-bottom pb-2">PortfÃ¶y DaÄŸÄ±lÄ±mÄ±</h5>
                <div class="row">
                    <div class="col-lg-4 mb-4">
                        <div class="card shadow mb-4 h-100">
                            <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">VarlÄ±k TÃ¼rÃ¼</h6></div>
                            <div class="card-body"><div id="chart-portfolio-dist"></div></div>
                        </div>
                    </div>
                    <div class="col-lg-4 mb-4">
                        <div class="card shadow mb-4 h-100">
                            <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-info">SektÃ¶rel DaÄŸÄ±lÄ±m (SÄ±nÄ±flar)</h6></div>
                            <div class="card-body"><div id="chart-class-radar"></div></div>
                        </div>
                    </div>
                    <div class="col-lg-4 mb-4">
                        <div class="card shadow mb-4 h-100">
                            <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-success">6 AylÄ±k BÃ¼tÃ§e Projeksiyonu</h6></div>
                            <div class="card-body"><div id="chart-budget-forecast"></div></div>
                        </div>
                    </div>
                </div>
            </div>
    </div>
</div>
<div class="modal fade" id="portfolioDetailModal" tabindex="-1" role="dialog" aria-labelledby="portfolioDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title header-title" id="portfolioDetailModalLabel">Detaylar</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card p-3 h-100">
                            <div class="card-header">Marka/GÃ¶rsel</div>
                            <div class="card-body text-center d-flex align-items-center justify-content-center" style="min-height: 150px;">
                                <img id="modal-img" src="" style="max-width: 100%; max-height: 140px; border-radius: 8px; object-fit: contain;" alt="GÃ¶rsel">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card p-3 h-100">
                            <div class="card-header">VarlÄ±k DetaylarÄ±</div>
                            <div class="card-body" id="modal-details-card"><div class="text-center text-muted mt-4"><i class="fas fa-spinner fa-spin"></i></div></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card p-3 h-100">
                            <div class="card-header">Tarihler / Durum</div>
                            <div class="card-body" id="modal-dates-card"><div class="text-center text-muted mt-4"><i class="fas fa-spinner fa-spin"></i></div></div>
                        </div>
                    </div>
                </div>
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item"><a class="nav-link active" id="islemler-tab" data-toggle="tab" href="#modal-islemler" role="tab">Ä°ÅŸlemler</a></li>
                    <li class="nav-item"><a class="nav-link" id="esya-tab" data-toggle="tab" href="#modal-esya" role="tab">EÅŸya Listesi</a></li>
                    <li class="nav-item"><a class="nav-link" id="tahakkuklar-tab" data-toggle="tab" href="#modal-tahakkuklar" role="tab">Faturalar</a></li>
                </ul>
                <div class="tab-content tab-content-card">
                    <div class="tab-pane fade show active" id="modal-islemler" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0"><thead><tr><th style="width: 50px;">#</th><th>Ä°ÅŸlem</th><th style="width: 120px;">Tarih</th><th>Evrak</th></tr></thead><tbody></tbody></table>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="modal-esya" role="tabpanel"><div id="esyaListesiContent" class="mt-3 p-2"></div></div>
                    <div class="tab-pane fade" id="modal-tahakkuklar" role="tabpanel"><div class="p-3 text-muted">Ä°lgili fatura kaydÄ± bulunamadÄ±.</div></div>
                </div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Kapat</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="davaDetailModal" tabindex="-1" role="dialog" aria-labelledby="davaDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title header-title" id="davaDetailModalLabel">Dava DetaylarÄ±</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card p-3 h-100">
                            <div class="card-header">Dava Bilgileri</div>
                            <div class="card-body">
                                <p><strong>Dava No:</strong> <span id="modal-dava-caseNo">-</span></p>
                                <p><strong>BaÅŸlÄ±k:</strong> <span id="modal-dava-title">-</span></p>
                                <p><strong>Mahkeme:</strong> <span id="modal-dava-court">-</span></p>
                                <p><strong>AÃ§Ä±lÄ±ÅŸ Tarihi:</strong> <span id="modal-dava-openingDate">-</span></p>
                                <p><strong>Durum:</strong> <span id="modal-dava-status">-</span></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card p-3 h-100">
                            <div class="card-header">Taraflar</div>
                            <div class="card-body">
                                <p><strong>KarÅŸÄ± Taraf:</strong> <span id="modal-dava-opposingParty">-</span></p>
                                <p><strong>KarÅŸÄ± Taraf Vekili:</strong> <span id="modal-dava-opposingCounsel">-</span></p>
                                <p><strong>MÃ¼vekkil:</strong> <span id="modal-dava-client">-</span></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="card p-3">
                            <div class="card-header">Konu VarlÄ±k</div>
                            <div class="card-body">
                                <p><strong>VarlÄ±k Tipi:</strong> <span id="modal-dava-assetType">-</span></p>
                                <p><strong>VarlÄ±k AdÄ±:</strong> <span id="modal-dava-assetTitle">-</span></p>
                                <p><strong>No:</strong> <span id="modal-dava-assetNumber">-</span></p>
                                <hr>
                                <p><strong>AÃ§Ä±klama:</strong> <span id="modal-dava-description">-</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Kapat</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="goodsComparisonModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Mal ve Hizmet KarÅŸÄ±laÅŸtÄ±rmasÄ±</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6"><div class="card p-3 h-100"><div class="card-header bg-info text-white"><h6>Ä°ZLENEN MARKANIZ</h6></div><div class="card-body" id="monitoredGoodsContent" style="max-height: 500px; overflow-y: auto;"></div></div></div>
                    <div class="col-md-6"><div class="card p-3 h-100"><div class="card-header bg-danger text-white"><h6>BENZER MARKA</h6></div><div class="card-body" id="competitorGoodsContent" style="max-height: 500px; overflow-y: auto;"></div></div></div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="clientSelectionModal" data-backdrop="static" data-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">GÃ¶rÃ¼ntÃ¼lenecek MÃ¼ÅŸteriyi SeÃ§in</h5>
            </div>
            <div class="modal-body">
                <p>Birden fazla mÃ¼ÅŸteri hesabÄ±na eriÅŸim yetkiniz var. LÃ¼tfen iÅŸlem yapmak istediÄŸiniz hesabÄ± seÃ§in:</p>
                <div class="list-group" id="clientSelectionList">
                    </div>
            </div>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsvectormap/dist/css/jsvectormap.min.css" />
<script src="https://cdn.jsdelivr.net/npm/jsvectormap"></script>
<script src="https://cdn.jsdelivr.net/npm/jsvectormap/dist/maps/world.js"></script>
<script src="./js/simple-loading.js"></script>

<script type="module">
    import { authService, db } from './firebase-config.js';
    import { doc, getDoc, collection, getDocs, getDocsFromServer, query, where, updateDoc, limit, documentId } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import PaginationModule from './js/pagination.js';

// === GLOBAL DEÄžÄ°ÅžKENLER (GÃœNCELLENMÄ°Åž) ===
    window.Pagination = PaginationModule;
    window.countryMap = new Map(); // Ãœlke kodlarÄ±nÄ± isme Ã§evirmek iÃ§in
    
    // 1. Ä°ÅŸlerim (Tasks) Verisi
    window.taskPaginationData = { 
        allDataUnfiltered: [], // Ham veri (Filtreleme iÃ§in)
        allData: [],           // FiltrelenmiÅŸ veri
        currentType: '',       // 'pending-approval', 'bulletin-watch' vb.
        currentPage: 1, 
        itemsPerPage: 10, 
        pagination: null 
    };

    // 2. Marka Verisi
    window.markaPaginationData = { 
        allDataUnfiltered: [], // Filtresiz ham veri
        allData: [],           // FiltrelenmiÅŸ ve ekranda gÃ¶sterilen veri
        pagination: null, 
        itemsPerPage: 10 
    };

    // 3. Ä°tiraz Verisi (GÃœNCELLENDÄ°: allDataUnfiltered eklendi)
    window.davaItirazPaginationData = { 
        allDataUnfiltered: [], 
        allData: [], 
        pagination: null, 
        itemsPerPage: 10 
    };

    // 4. Dava Verisi (YENÄ° EKLENDÄ°)
    window.davaPaginationData = { 
        allDataUnfiltered: [], 
        allData: [], 
        pagination: null, 
        itemsPerPage: 10 
    };

    // 5. Fatura Verisi
    window.invoicesPaginationData = { 
        allData: [], 
        currentPage: 1, 
        itemsPerPage: 10, 
        pagination: null 
    };
    
    // 6. Vekalet Verisi (YENÄ°)
    window.contractsPaginationData = { 
        allDataUnfiltered: [], 
        allData: [], 
        pagination: null, 
        itemsPerPage: 10,
        currentPage: 1
    };

    // 7. Filtre Durumu (YENÄ° EKLENDÄ°)
    window.activeColumnFilters = {}; 

    // 8. DiÄŸerleri
    window.transactionTypesMap = new Map();
    window.linkedPersonIds = [];
    window.linkedClientsMap = []; // [{id: '123', name: 'ABC Ltd.'}, ...]
    window.selectedClientId = 'ALL'; // VarsayÄ±lan 'HEPSÄ°'

    const runGetDocs = getDocs; // getDocsFromServer iptal edildi, Ã¶nbellek aktif!
    // --- YARDIMCI FONKSÄ°YONLAR ---
    window.formatDateTR = function(v) {
        if (!v) return '-';
        try {
            let date;
            if (v && typeof v === 'object' && typeof v.toDate === 'function') date = v.toDate();
            else if (v && typeof v === 'object' && v.seconds) date = new Date(v.seconds * 1000);
            else date = new Date(v);
            if (isNaN(date.getTime())) return '-';
            const d = String(date.getDate()).padStart(2,'0');
            const m = String(date.getMonth()+1).padStart(2,'0');
            const y = date.getFullYear();
            return `${d}.${m}.${y}`;
        } catch { return '-'; }
    };

    // YardÄ±mcÄ±: Bir iÅŸin Dava olup olmadÄ±ÄŸÄ±nÄ± kontrol eder
    window.isDavaTask = function(t) {
        const type = String(t.taskType);
        const title = (t.title || '').toLowerCase();
        // Task Type 49 VEYA BaÅŸlÄ±kta 'dava'/'mahkeme' geÃ§iyorsa
        return type === '49' || title.includes('dava') || title.includes('mahkeme');
    };

    window.currencyFormatter = function(amount, currency) {
        try {
            return new Intl.NumberFormat('tr-TR', { style: 'currency', currency: currency || 'TRY' }).format(amount ?? 0);
        } catch { return (amount ?? 0) + ' ' + (currency || 'TRY'); }
    };

// === TÃœRKPATENT SORGULAMA FONKSÄ°YONU (GÃœNCELLENMÄ°Åž) ===
    window.triggerTpQuery = function(applicationNo) {
        const appNo = (applicationNo || '').toString().trim();
        
        // [DÃœZELTME]: Sadece harf, rakam VE SLASH (/) karakterine izin ver
        // Eski kod: /[^a-zA-Z0-9]/g (Slash'Ä± siliyordu)
        const cleanAppNo = appNo.replace(/[^a-zA-Z0-9/]/g, '');
        
        // URL'de / iÅŸareti sorun Ã§Ä±karmasÄ±n diye encodeURIComponent kullanÄ±yoruz
        // Bu, 2024/12345'i 2024%2F12345 yapar, portal bunu doÄŸru okur.
        const fallbackUrl = `https://portal.turkpatent.gov.tr/anonim/arastirma/marka/sonuc?dosyaNo=${encodeURIComponent(cleanAppNo)}`;
        
        const EXT_ID = 'gkhmldkbjmnipikgjabmlilibllikapk';

        try {
            if (typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.sendMessage) {
                chrome.runtime.sendMessage(EXT_ID, { type: 'SORGULA', data: cleanAppNo }, (response) => {
                    if (chrome.runtime.lastError || !response) {
                        console.warn("Eklenti bulunamadÄ±, web sitesine yÃ¶nlendiriliyor.");
                        window.open(fallbackUrl, '_blank');
                    }
                });
            } else {
                window.open(fallbackUrl, '_blank');
            }
        } catch (e) {
            window.open(fallbackUrl, '_blank');
        }
    };

    window._createDocLinkHtml = function(pdf) {
        let iconClass = 'fas fa-file-pdf';
        let titleText = pdf.fileName || 'Belge';
        let iconColor = '#dc3545'; 
        let badgeHtml = '';

        if (pdf.type === 'opposition_petition') { iconClass = 'fas fa-gavel'; titleText = 'KarÅŸÄ± Taraf Ä°tiraz DilekÃ§esi'; iconColor = '#ffc107'; }
        else if (pdf.type === 'official_document') { iconClass = 'fas fa-file-signature'; titleText = 'Resmi YazÄ±'; iconColor = '#17a2b8'; }
        else if (pdf.type === 'epats_document') { 
            iconClass = 'fas fa-file-invoice'; 
            titleText = `ePats: ${pdf.evrakNo || pdf.fileName}`; 
            iconColor = '#007bff'; 
            if (pdf.evrakNo) badgeHtml = `<span style="font-size:0.7em; margin-left:2px;">${pdf.evrakNo}</span>`; 
        }
        else if (pdf.type === 'task_document' || pdf.isTaskDoc) { iconClass = 'fas fa-file-alt'; titleText = 'GÃ¶rev Belgesi: ' + pdf.fileName; iconColor = '#6c757d'; }

        return `<a href="${pdf.fileUrl}" target="_blank" title="${titleText}" style="color:${iconColor}; text-decoration:none; margin-right:8px; font-size:1.2em; display:inline-block;"><i class="${iconClass}"></i>${badgeHtml}</a>`;
    };

    window.renderDocsCell = function(rowData) {
        const docs = rowData.allParentDocs || rowData.allChildDocs || (Array.isArray(rowData.documents) ? rowData.documents : []);
        if (!docs || docs.length === 0) return '<span class="text-muted">-</span>';
        
        return docs.map(doc => {
            if (doc.fileUrl && doc.fileName) return window._createDocLinkHtml(doc);
            const fileName = doc.name || doc.fileName || 'Belge';
            const fileUrl = doc.downloadURL || doc.url || doc.path || doc.fileUrl;
            if (!fileUrl) return '';
            return window._createDocLinkHtml({ fileName: fileName, fileUrl: fileUrl, type: doc.type, isTransactionDoc: true });
        }).filter(Boolean).join('') || '<span class="text-muted">-</span>';
    };

    // --- INIT ---
async function initPortal() {
    const user = authService.getCurrentUser();
    if (!user) return;
    
    // YÃ¼kleme ekranÄ±nÄ± baÅŸlat
    if (window.SimpleLoadingController) {
        window.SimpleLoadingController.show('Portal HazÄ±rlanÄ±yor', 'Verileriniz gÃ¼venle getiriliyor...');
    }

    $('#userName').text(user.displayName || user.email);
    $('#userAvatar').text((user.displayName||'U').charAt(0).toUpperCase());
    $('#welcomeUserName').text(user.displayName || user.email);
    
    try {
        await Promise.all([
            window.fetchCountries(),
            (async () => {
                const typesSnap = await getDocs(collection(db, 'transactionTypes'));
                typesSnap.forEach(d => window.transactionTypesMap.set(d.id, d.data()));
            })()
        ]);

        // 1. KullanÄ±cÄ± Verisini (User) Ã‡ek
        const userSnap = await getDoc(doc(db, 'users', user.uid));
        if (!userSnap.exists()) return;
        
        const userData = userSnap.data();
        const linkedIds = userData.linkedPersonIds || [];
        
        window.linkedPersonIds = linkedIds; 

        // --- YENÄ°: MÃœÅžTERÄ° Ä°SÄ°MLERÄ°NÄ° Ã‡EKME VE SEÃ‡Ä°CÄ° ---
        await window.fetchClientNames(linkedIds);
        window.renderClientSelectorUI();

        // ========================================================================
        // [DÃœZELTME] BAÄžLI KÄ°ÅžÄ°LERÄ°N (MÃœVEKKÄ°LLERÄ°N) EVRAKLARINI Ã‡EKME MANTIÄžI
        // ========================================================================
        let allDocuments = [];

        // A) Ã–nce KullanÄ±cÄ± kartÄ±ndaki evraklarÄ± al (varsa)
        if (userData.documents && Array.isArray(userData.documents)) {
            allDocuments = [...userData.documents];
        }

        // B) BaÄŸlÄ± olduÄŸu KiÅŸiler (Persons) tablosundaki evraklarÄ± topla
        if (linkedIds.length > 0) {
            const chunks = [];
            // Firestore 'in' sorgusu en fazla 10 eleman kabul eder, bu yÃ¼zden bÃ¶lÃ¼yoruz
            for (let i = 0; i < linkedIds.length; i += 10) {
                const chunk = linkedIds.slice(i, i + 10);
                // '__name__' yerine documentId() kullanÄ±yoruz ve hÄ±zlÄ± getirme iÃ§in runGetDocs'a Ã§eviriyoruz
                const q = query(collection(db, 'persons'), where(documentId(), 'in', chunk));
                chunks.push(runGetDocs(q));
            }
            
            // TÃ¼m sorgularÄ± paralel Ã§alÄ±ÅŸtÄ±r
            const snapshots = await Promise.all(chunks);
            
            snapshots.forEach(snap => {
                snap.forEach(doc => {
                    const personData = doc.data();
                    // EÄŸer bu kiÅŸinin evraklarÄ± varsa listeye ekle
                    if (personData.documents && Array.isArray(personData.documents)) {
                        // Ã‡Ã–ZÃœM: Her belgeye sahibinin ID'sini (ownerId) ekliyoruz
                        const docsWithOwner = personData.documents.map(d => ({ 
                            ...d, 
                            ownerId: doc.id, // MÃ¼ÅŸteri ID'si (Filtreleme iÃ§in ÅŸart)
                            ownerName: personData.name // MÃ¼ÅŸteri AdÄ± (GÃ¶rselde gÃ¶stermek isterseniz)
                        }));
                        allDocuments = [...allDocuments, ...docsWithOwner];
                    }
                });
            });
        }

        // Toplanan tÃ¼m evraklarÄ± ana veri objesine koy
        window.currentUserData = {
            ...userData,
            documents: allDocuments
        };

        // [YENÄ°] Vekalet Verilerini Global State'e YÃ¼kle ve BaÅŸlat
            window.contractsPaginationData.allDataUnfiltered = allDocuments || [];
            window.applyContractsFilter(); // Tabloyu ilk kez oluÅŸturur
        // ========================================================================
        // DiÄŸer verileri Ã§ek
        fetchAndDisplayPortfolio();
        // 1. En kritik veri olan PortfÃ¶y'Ã¼ Ã§ek (Bu inmeden diÄŸerleri dÃ¼zgÃ¼n Ã§alÄ±ÅŸamaz)
        await fetchAndDisplayPortfolio();
        // 2. PORTAL HAZIR! KullanÄ±cÄ±yÄ± 40 saniye bekletmemek iÃ§in YÃœKLEME EKRANINI HEMEN KAPAT.
        // KullanÄ±cÄ± anÄ±nda Dashboard ekranÄ±nÄ± gÃ¶rmeye baÅŸlayacak.
        if (window.SimpleLoadingController) window.SimpleLoadingController.hide();

        // 3. AÄŸÄ±r verileri ARKA PLANDA ve PARALEL (hepsi aynÄ± anda) Ã§ek.
        // Ekranda loading dÃ¶nmez, sistem kilitlenmez. KullanÄ±cÄ± sayfayÄ± incelerken veriler inmeye devam eder.
        Promise.all([
            fetchAndDisplayTasks(linkedIds),
            fetchAndDisplayInvoices(linkedIds),
            fetchAndDisplaySuits(),
            fetchAndDisplayObjections()
        ]).then(() => {
            console.log("Arka plan verileri baÅŸarÄ±yla yÃ¼klendi.");
            // TÃ¼m veriler indiÄŸinde sayaÃ§larÄ± son kez Ã§aktÄ±rmadan gÃ¼ncelle
            window.updateDashboardCounts(); 
        }).catch(err => {
            console.error("Arka plan veri Ã§ekme hatasÄ±:", err);
        });

    } catch (e) {
        console.error("Init Error:", e);
        if (window.SimpleLoadingController) window.SimpleLoadingController.showError('BaÄŸlantÄ± hatasÄ± oluÅŸtu.');
    } 
}

// --- 1. PORTFÃ–Y (YENÄ° VE HIZLI VERSÄ°YON) ---
async function fetchAndDisplayPortfolio() {
    const tbody = document.querySelector('#marka-list tbody');
    // Veriler gelene kadar tabloya yÃ¼kleniyor yazÄ±sÄ± koyalÄ±m
    if (tbody) tbody.innerHTML = '<tr><td colspan="10" class="text-center py-4"><i class="fas fa-spinner fa-spin"></i> PortfÃ¶y yÃ¼kleniyor...</td></tr>';

    try {
        let allPortfolios = [];
        
        // KullanÄ±cÄ±nÄ±n baÄŸlÄ± olduÄŸu mÃ¼vekkiller varsa iÅŸlemi yap
        if (window.linkedPersonIds && window.linkedPersonIds.length > 0) {
            const chunks = [];
            
            // "in" veya "array-contains-any" komutlarÄ± maksimum 10 eleman alÄ±r. Gruplara bÃ¶lÃ¼yoruz:
            for (let i = 0; i < window.linkedPersonIds.length; i += 10) {
                const chunk = window.linkedPersonIds.slice(i, i + 10);
                
                // Ä°ÅžTE SÄ°HÄ°RLÄ° SORGUMUZ: applicantIds dizisinde bu mÃ¼ÅŸterilerden BÄ°RÄ° geÃ§iyorsa anÄ±nda getir!
                const q = query(collection(db, "ipRecords"), where('applicantIds', 'array-contains-any', chunk));
                
                // runGetDocs kullanarak veriyi Ã¶nbellekten veya sunucudan Ã§ok hÄ±zlÄ± Ã§ekiyoruz
                chunks.push(runGetDocs(q));
            }
            
            // TÃ¼m gruplarÄ± paralel olarak (aynÄ± anda) veritabanÄ±ndan Ã§ek
            const snapshots = await Promise.all(chunks);
            
            snapshots.forEach(snap => {
                snap.forEach(doc => {
                    allPortfolios.push({ id: doc.id, ...doc.data() });
                });
            });
        }

        // Ã‡ekilen veriyi Global DeÄŸiÅŸkene Kaydet (DiÄŸer modÃ¼ller buradan okuyacak)
        window.allPortfolioData = allPortfolios;

        // Dashboard SayaÃ§larÄ±nÄ± GÃ¼ncelle
        window.updateDashboardCounts();
        
        // Marka Listesi (Pagination verisi hazÄ±rlÄ±ÄŸÄ±)
        // Sadece markalarÄ± filtrele
        window.markaPaginationData.allDataUnfiltered = allPortfolios.filter(p => p.type === 'trademark' || p.type === 'Marka' || p.brandType);
        window.markaPaginationData.allData = [...window.markaPaginationData.allDataUnfiltered];

        // Patent ve TasarÄ±mlarÄ± filtrele
        const patentList = allPortfolios.filter(p => p.type === 'patent' || p.type === 'Patent');
        const tasarimList = allPortfolios.filter(p => p.type === 'design' || p.type === 'TasarÄ±m');
        
        // Sayfalama ModÃ¼lÃ¼nÃ¼ BaÅŸlat
        if (!window.markaPaginationData.pagination && window.Pagination) {
            window.markaPaginationData.pagination = new window.Pagination({
                itemsPerPage: 10,
                containerId: 'markaPagination',
                onPageChange: (page, perPage) => {
                    const start = (page - 1) * perPage;
                    const slice = window.markaPaginationData.allData.slice(start, start + perPage);
                    window.populatePortfolioTable('#marka-list', slice, start);
                }
            });
        }
        
        if (window.markaPaginationData.pagination) {
            window.markaPaginationData.pagination.update(window.markaPaginationData.allData.length);
        }
        
        // TablolarÄ± Ä°lk Verilerle Doldur
        window.populatePortfolioTable('#marka-list', window.markaPaginationData.allData.slice(0,10));
        window.populatePortfolioTable('#patent-list', patentList);
        window.populatePortfolioTable('#tasarim-list', tasarimList);
        
    } catch (error) {
        console.error("PortfÃ¶y yÃ¼kleme hatasÄ±:", error);
        if (tbody) tbody.innerHTML = '<tr><td colspan="10" class="text-center text-danger">PortfÃ¶y yÃ¼klenirken bir hata oluÅŸtu.</td></tr>';
    }
}

// === PORTFÃ–Y TABLOSU DOLDURMA (GÃœNCELLENMÄ°Åž) ===
window.populatePortfolioTable = function(tableId, portfolioData, startIndex = 0) {
    const tableBody = document.querySelector(`${tableId} tbody`);
    if (!tableBody) return;
    tableBody.innerHTML = '';

    // Marka listesi iÃ§in kolon sayÄ±sÄ± 10'a Ã§Ä±karÄ±ldÄ± (Yenileme Tarihi eklendiÄŸi iÃ§in)
    const colSpan = tableId === '#marka-list' ? 10 : 6;

    if (!portfolioData || portfolioData.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="${colSpan}" class="text-center text-muted">KayÄ±t bulunamadÄ±.</td></tr>`;
        return;
    }

    const getStatusDetails = (statusRaw) => {
        if (!statusRaw) return { text: '-', className: 'secondary' };
        const s = String(statusRaw).toLowerCase().trim();
        const map = {
            'filed': { text: 'BaÅŸvuru', className: 'primary' },
            'registered': { text: 'Tescilli', className: 'success' },
            'registration': { text: 'Tescilli', className: 'success' },
            'published': { text: 'YayÄ±nlandÄ±', className: 'info' },
            'publication': { text: 'YayÄ±nlandÄ±', className: 'info' },
            'refused': { text: 'Reddedildi', className: 'danger' },
            'rejected': { text: 'GeÃ§ersiz', className: 'danger' },
            'withdrawn': { text: 'Geri Ã‡ekildi', className: 'secondary' },
            'expired': { text: 'SÃ¼resi Doldu', className: 'dark' },
            'pending': { text: 'Bekliyor', className: 'warning' },
            'active': { text: 'Aktif', className: 'success' },
            'inactive': { text: 'Pasif', className: 'secondary' },
            'baÅŸvuru': { text: 'BaÅŸvuru', className: 'primary' },
            'tescilli': { text: 'Tescilli', className: 'success' },
            'itiraz': { text: 'Ä°tiraz', className: 'warning' },
            'devam ediyor': { text: 'Devam Ediyor', className: 'info' },
            'reddedildi': { text: 'Reddedildi', className: 'danger' }
        };
        return map[s] || { text: statusRaw, className: 'secondary' };
    };

    const getClassesString = (dataItem) => {
        if (Array.isArray(dataItem.goodsAndServicesByClass) && dataItem.goodsAndServicesByClass.length > 0) {
            return dataItem.goodsAndServicesByClass.map(c => c.classNo).join(', ');
        }
        if (Array.isArray(dataItem.classes)) {
            return dataItem.classes.join(', ');
        }
        return dataItem.classes || '-';
    };

    portfolioData.forEach((item, index) => {
        const actualIndex = startIndex + index;
        const mainRow = document.createElement('tr');
        
        const originRaw = (item.origin || 'TÃœRKPATENT').toString().trim().toUpperCase();
        const originBucket = (originRaw.includes('TURK') || originRaw.includes('TÃœRK')) ? 'TÃœRKPATENT' : 'YURTDISI';
        const originDisplay = (originBucket === 'TÃœRKPATENT') ? 'TÃœRKPATENT' : (item.country || item.origin || 'YurtdÄ±ÅŸÄ±');
        
        const isParent = item.transactionHierarchy === 'parent';
        const isChild = item.transactionHierarchy === 'child';
        
        if (isChild) return; 

        let childRecords = [];
        if (isParent && window.markaPaginationData.allDataUnfiltered) {
            childRecords = window.markaPaginationData.allDataUnfiltered.filter(p => p.parentId === item.id);
        }
        const isInternational = isParent && childRecords.length > 0;

        const title = item.title || item.brandText || item.patentTitle || 'Ä°simsiz';
        const appNo = item.applicationNumber || item.applicationNo || '-';
        const appDate = window.formatDateTR(item.applicationDate || item.application_date);
        
        // --- YENÄ° ALAN: Yenileme Tarihi ---
        const renDate = window.formatDateTR(item.renewalDate);

        const statusObj = getStatusDetails(item.status || item.statusText);

        let regNoDisplay = '-';
        if (item.internationalRegNumber) regNoDisplay = item.internationalRegNumber;
        else if (item.wipoIrNumber) regNoDisplay = item.wipoIrNumber;
        else if (item.registrationNumber) regNoDisplay = item.registrationNumber;

        const classes = getClassesString(item);
        
        const imgHtml = (item.brandImageUrl || item.brandImage) 
            ? `<img src="${item.brandImageUrl || item.brandImage}" class="brand-thumb">` 
            : '-';

        mainRow.setAttribute('data-origin', originBucket);

        if (tableId === '#marka-list') {
            mainRow.innerHTML = `
                <td class="col-index">${isInternational ? '<i class="fas fa-chevron-right mr-2"></i>' : ''}${actualIndex + 1}</td>
                <td class="col-origin">${originDisplay}</td>
                <td class="col-sample text-center">${imgHtml}</td>
                <td class="col-brand"><a href="#" class="portfolio-detail-link" data-item-id="${item.id}" data-toggle="modal" data-target="#portfolioDetailModal">${title}</a></td>
                <td class="col-appno">${appNo}</td>
                <td class="col-regno">${regNoDisplay}</td>
                <td class="col-appdate">${appDate}</td>
                <td>${renDate}</td> <td class="col-status"><span class="badge badge-${statusObj.className}">${statusObj.text}</span></td>
                <td class="col-classes">${classes}</td>`;
            
            if (isInternational) {
                mainRow.classList.add('accordion-header-row');
                mainRow.setAttribute('data-toggle', 'collapse');
                mainRow.setAttribute('data-target', `#accordion-yurtdisi-${item.id}`);
            }
        } else {
            // DiÄŸer tablolar (Patent vb. iÃ§in yapÄ± aynÄ± kalÄ±yor)
            mainRow.innerHTML = `<td>${actualIndex + 1}</td>${tableId==='#tasarim-list'?`<td class="text-center">${imgHtml}</td>`:''}<td><a href="#" class="portfolio-detail-link" data-item-id="${item.id}" data-toggle="modal" data-target="#portfolioDetailModal">${title}</a></td><td>${appNo}</td><td><span class="badge badge-${statusObj.className}">${statusObj.text}</span></td>${tableId==='#patent-list'?`<td>${appDate}</td>`:`<td>${classes}</td>`}`;
        }

        tableBody.appendChild(mainRow);

    // --- CHILD KAYITLAR (YENÄ° KOLON EKLENDÄ°) ---
        if (tableId === '#marka-list' && isInternational) {
            const detailRow = document.createElement('tr');
            detailRow.setAttribute('data-origin', originBucket);
            
            const childRowsHtml = childRecords.map((sub, idx) => {
                const subClasses = getClassesString(sub);
                
                const code = (sub.country || sub.countryCode || '').trim().toUpperCase();
                const name = window.countryMap.get(code) || sub.countryName || '';
                let originStr = code;
                if (name && code) originStr = `${name} (${code})`;
                else if (name) originStr = name;

                const subAppDate = window.formatDateTR(sub.applicationDate);
                // --- Child Yenileme Tarihi ---
                const subRenDate = window.formatDateTR(sub.renewalDate);
                
                const subStatusObj = getStatusDetails(sub.status);

                // DEÄžÄ°ÅžÄ°KLÄ°K BURADA: originStr, tÄ±klanabilir bir link haline getirildi
                return `<tr>
                    <td>${actualIndex+1}.${idx+1}</td>
                    <td><a href="#" class="portfolio-detail-link" data-item-id="${sub.id}" data-toggle="modal" data-target="#portfolioDetailModal" style="font-weight:bold; text-decoration:underline;">${originStr}</a></td>
                    <td>${sub.applicationNumber||'-'}</td>
                    <td>${subAppDate}</td>
                    <td>${subRenDate}</td> <td><span class="badge badge-${subStatusObj.className}">${subStatusObj.text}</span></td>
                    <td>${subClasses}</td>
                </tr>`;
            }).join('');

            // Child Tablo Header GÃ¼ncellendi (Colspan 10 yapÄ±ldÄ±)
            detailRow.innerHTML = `
            <td colspan="10" class="p-0">
                <div class="collapse" id="accordion-yurtdisi-${item.id}">
                    <table class="table mb-0 accordion-table bg-light">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>MenÅŸe</th>
                                <th>BaÅŸvuru No</th>
                                <th>BaÅŸvuru Tarihi</th>
                                <th>Yenileme Tarihi</th> <th>Durum</th>
                                <th>SÄ±nÄ±flar</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${childRowsHtml}
                        </tbody>
                    </table>
                </div>
            </td>`;
            tableBody.appendChild(detailRow);
        }
    });

    if (tableId === '#marka-list') {
        const currentFilter = $("#menseFilter").val() || 'TÃœRKPATENT';
        if (currentFilter === 'TÃœRKPATENT') {
            $('#marka-list th.col-origin, #marka-list td.col-origin').hide();
        } else {
            $('#marka-list th.col-origin, #marka-list td.col-origin').show();
        }
    }
};

// === YENÄ° FONKSÄ°YON: Ãœlke Listesini Ã‡ek ===
window.fetchCountries = async function() {
    try {
        // Ekran gÃ¶rÃ¼ntÃ¼sÃ¼ne gÃ¶re yol: collection('common') -> doc('countries')
        const docRef = doc(db, 'common', 'countries');
        const docSnap = await getDoc(docRef);
        
        if (docSnap.exists()) {
            const data = docSnap.data();
            // 'list' array'i iÃ§inde {code: "AF", name: "Afganistan"} formatÄ±nda duruyor
            if (data.list && Array.isArray(data.list)) {
                data.list.forEach(country => {
                    if (country.code && country.name) {
                        window.countryMap.set(country.code, country.name);
                    }
                });
            }
        }
    } catch (error) {
        console.error("Ãœlke listesi yÃ¼klenemedi:", error);
    }
};

// --- 2. Ä°ÅžLERÄ°M (TASKS) ---
window.checkTaskClientRelation = async function(taskData, clientPersonIdSet) {
        if (!taskData._relatedClientIds) taskData._relatedClientIds = [];
        let isMatch = false;
        
        if (taskData.clientId && clientPersonIdSet.has(taskData.clientId)) {
            if (!taskData._relatedClientIds.includes(taskData.clientId)) taskData._relatedClientIds.push(taskData.clientId);
            isMatch = true;
        }
        if (taskData.taskOwner && typeof taskData.taskOwner === 'string' && clientPersonIdSet.has(taskData.taskOwner)) {
            if (!taskData._relatedClientIds.includes(taskData.taskOwner)) taskData._relatedClientIds.push(taskData.taskOwner);
            isMatch = true;
        }
        if (Array.isArray(taskData.taskOwner)) {
            taskData.taskOwner.forEach(ownerId => {
                if (clientPersonIdSet.has(ownerId)) {
                    if (!taskData._relatedClientIds.includes(ownerId)) taskData._relatedClientIds.push(ownerId);
                    isMatch = true;
                }
            });
        }
        const opponentId = taskData.opponent?.id || taskData.details?.opponent?.id;
        if (opponentId && clientPersonIdSet.has(opponentId)) {
            if (!taskData._relatedClientIds.includes(opponentId)) taskData._relatedClientIds.push(opponentId);
            isMatch = true;
        }
        
        // ðŸ”¥ HIZLANDIRILMIÅž KONTROL: VeritabanÄ±na ASLA gitme! 
        // EÄŸer bu marka mÃ¼ÅŸterininse, zaten ÅŸu an hafÄ±zadaki (window.allPortfolioData) listede vardÄ±r.
        if (taskData.relatedIpRecordId && !isMatch) {
            if (window.allPortfolioData) {
                const localRec = window.allPortfolioData.find(r => r.id === taskData.relatedIpRecordId);
                if (localRec) {
                    isMatch = true; 
                    if (localRec.applicants) {
                        localRec.applicants.forEach(app => {
                            if (app.id && clientPersonIdSet.has(app.id) && !taskData._relatedClientIds.includes(app.id)) {
                                taskData._relatedClientIds.push(app.id);
                            }
                        });
                    }
                }
            }
        }
        
        return isMatch;
    };


    window.fetchAndDisplayTasks = async function(linkedIds) {
        const q = query(collection(db, 'tasks'), where('status', '==', 'awaiting_client_approval'));
        const snap = await runGetDocs(q);
        const tasks = [];
        const clientSet = new Set(linkedIds);
        
        for (const d of snap.docs) {
            const t = d.data();
            if (await window.checkTaskClientRelation(t, clientSet)) tasks.push({ id: d.id, ...t });
        }
        
        // ðŸ”¥ Veriyi Global DeÄŸiÅŸkene Kaydet
        window.dashboardTasksData = tasks;

        // ðŸ”¥ Dashboard'u GÃ¼ncelle (Hesaplamalar artÄ±k updateDashboardCounts iÃ§inde yapÄ±lÄ±yor)
        window.updateDashboardCounts();
    };

    // DetaylÄ± Task Listeleme
    window.loadSampleTaskDetails = async function(taskType) {
        const container = document.getElementById('task-list-container');
        container.innerHTML = '<div class="text-center mt-5"><i class="fas fa-spinner fa-spin fa-3x"></i><p class="mt-2">Veriler yÃ¼kleniyor...</p></div>';
        
        window.taskPaginationData.currentType = taskType;
        $('#taskSearchText').val('');
        $('#taskStatusFilter').val('TÃœMÃœ');

        const tasksRef = collection(db, 'tasks');
        let q;
        
        // Sorgu: Tamamlananlar (veya aÃ§Ä±k) mÄ± yoksa sadece onay bekleyenler mi?
        if (taskType === 'completed-tasks' || taskType === 'dava-completed') {
            q = query(tasksRef, where('status', '!=', 'awaiting_client_approval'));
        } else {
            q = query(tasksRef, where('status', '==', 'awaiting_client_approval'));
        }
            
        const snap = await runGetDocs(q);
        let rawTasks = [];
        const clientSet = new Set(window.linkedPersonIds);
        
        for (const d of snap.docs) {
            const t = d.data();
            if (await window.checkTaskClientRelation(t, clientSet)) rawTasks.push({ id: d.id, ...t });
        }

        // --- FÄ°LTRELEME MANTIÄžI ---
        let finalTasks = [];

        // MARKA Ä°ÅžLERÄ° (Dava Olmayanlar)
        if (taskType === 'pending-approval') {
            finalTasks = rawTasks.filter(t => !window.isDavaTask(t) && String(t.taskType) !== '22' && String(t.taskType) !== '20');
        } else if (taskType === 'renewal-approval') {
            finalTasks = rawTasks.filter(t => String(t.taskType) === '22');
        } else if (taskType === 'bulletin-watch') {
            finalTasks = rawTasks.filter(t => String(t.taskType) === '20');
        } else if (taskType === 'completed-tasks') {
            finalTasks = rawTasks.filter(t => !window.isDavaTask(t));
        }
        
        // DAVA Ä°ÅžLERÄ° (Task Type 49)
        else if (taskType === 'dava-pending') {
            finalTasks = rawTasks.filter(t => window.isDavaTask(t));
        } else if (taskType === 'dava-completed') {
            finalTasks = rawTasks.filter(t => window.isDavaTask(t));
        }

        window.taskPaginationData.allDataUnfiltered = finalTasks;
        window.applyTaskFilter();
    };

    window._renderTaskCardsToContainer = async function(tasksToRender, containerSelector, formatDate, taskType) {
        const container = document.querySelector(containerSelector);
        if (!container) return;
        container.innerHTML = '<div class="col-12 text-center py-5"><i class="fas fa-spinner fa-spin fa-2x text-muted"></i></div>';

        const getImageUrl = (path) => {
            if (!path) return 'https://placehold.co/100x100?text=Yok';
            if (path.startsWith('http')) return path;
            const cleanPath = path.replace(/['"]/g, '');
            return `https://firebasestorage.googleapis.com/v0/b/ip-manager-production-aab4b.firebasestorage.app/o/${encodeURIComponent(cleanPath)}?alt=media`;
        };

        const formatScore = (val) => {
            if (val === undefined || val === null || val === '') return null;
            let strVal = String(val).replace(/['"%]/g, '').trim();
            let num = parseFloat(strVal);
            if (isNaN(num)) return val;
            if (num <= 1 && num > 0) return `%${Math.round(num * 100)}`;
            return `%${Math.round(num)}`;
        };

        const cardsHTML = await Promise.all(tasksToRender.map(async (task, index) => {
            const isCompletedView = (taskType === 'completed-tasks');
            const isBulletinWatch = (taskType === 'bulletin-watch');
            
            let monitoredData = null;   
            let monitoringRecord = null; 
            
            const monitoredId = task.details?.monitoredMarkId || task.relatedIpRecordId;
            let bulletinKey = task.details?.bulletinKey;
            if (!bulletinKey && task.details?.bulletinNo && task.details?.bulletinDate) {
                const dateStr = task.details.bulletinDate.replace(/\//g, '');
                bulletinKey = `${task.details.bulletinNo}_${dateStr}`;
            }
            
            if (monitoredId) {
                try {
                    if(bulletinKey) {
                        const monSnap = await getDoc(doc(db, 'monitoringTrademarkRecords', bulletinKey, 'trademarks', monitoredId));
                         if(monSnap.exists()) monitoringRecord = monSnap.data();
                    }
                    const ipSnap = await getDoc(doc(db, 'ipRecords', monitoredId));
                    if(ipSnap.exists()) monitoredData = ipSnap.data();
                } catch(e) { console.log('Data fetch error', e); }
            }

            let taskTypeName = 'Ä°ÅŸlem';
            if (task.taskType && window.transactionTypesMap && window.transactionTypesMap.has(String(task.taskType))) {
                const typeObj = window.transactionTypesMap.get(String(task.taskType));
                taskTypeName = typeObj?.alias || typeObj?.name || 'Ä°ÅŸlem';
            } else if (task.title) {
                taskTypeName = task.title;
            }

            let cardTitle = `#${task.id} - ${taskTypeName}`; 
            if (monitoredData && !isBulletinWatch) {
                const appNo = monitoredData.applicationNumber || monitoredData.applicationNo || '-';
                const brandName = monitoredData.title || monitoredData.brandText || '-';
                cardTitle = `#${task.id} - ${taskTypeName} - ${appNo} - ${brandName}`;
            } else if (isBulletinWatch) {
                cardTitle = `#${task.id} - ${taskTypeName}`;
            }

            let comparisonRow = '';
            if (isBulletinWatch) {
                const myImgUrl = getImageUrl(monitoredData?.brandImageUrl || monitoredData?.imagePath || '');
                const myClasses = (Array.isArray(monitoredData?.goodsAndServicesByClass) ? monitoredData.goodsAndServicesByClass.map(c=>c.classNo).join(', ') : monitoredData?.classes) || '-';

                const targetAppNo = task.details?.targetAppNo; 
                let competitor = null;

                if (monitoringRecord && Array.isArray(monitoringRecord.results) && targetAppNo) {
                    // Burada '/' karakterini silmiyoruz Ã§Ã¼nkÃ¼ veritabanÄ± eÅŸleÅŸtirmesi iÃ§in gerekebilir
                    // Ancak temiz bir eÅŸleÅŸtirme iÃ§in genelde slashsÄ±z tutulur.
                    // Monitoring kaydÄ± bulurken slashsÄ±z aramak daha gÃ¼venlidir:
                    const cleanTargetForMatch = String(targetAppNo).replace(/[^a-zA-Z0-9]/g, '');
                    competitor = monitoringRecord.results.find(r => String(r.applicationNo || '').replace(/[^a-zA-Z0-9]/g, '') === cleanTargetForMatch);
                }

                if (!competitor) {
                    competitor = {
                        markName: task.details?.objectionTarget,
                        applicationNo: task.details?.targetAppNo,
                        imagePath: task.details?.competitorBrandImage,
                        bs: task.details?.similarityScore,
                        note: task.details?.note,
                        holders: task.details?.competitorOwner ? [{name: task.details.competitorOwner}] : []
                    };
                }

                const compName = competitor.markName || 'Benzer Marka';
                const compNo = competitor.applicationNo || targetAppNo || '-';
                let compClasses = competitor.niceClasses || '-';
                if (Array.isArray(compClasses)) compClasses = compClasses.join(', ');
                const compImgUrl = getImageUrl(competitor.imagePath);
                
                let compOwner = '-';
                if (competitor.holders && Array.isArray(competitor.holders) && competitor.holders.length > 0) compOwner = competitor.holders[0].name || '-';

                const displayScore = formatScore(competitor.bs);
                const note = competitor.note;

                // --- [DÃœZELTME BURADA] ---
                // Buton iÃ§in ID temizliÄŸi: Slash (/) karakterine Ä°ZÄ°N VER
                const cleanCompNo = String(compNo).replace(/[^a-zA-Z0-9/]/g, '');

                let extraInfoHtml = '';
                if (displayScore || note) {
                    extraInfoHtml = `
                    <div class="mt-3 pt-2 border-top border-secondary" style="font-size: 0.9rem;">
                        ${displayScore ? `<span class="mr-3 d-block d-sm-inline mb-1"><strong style="color:rgba(255,255,255,0.7)">BaÅŸarÄ± ÅžansÄ±:</strong> <span class="badge badge-warning" style="font-size:0.9rem;">${displayScore}</span></span>` : ''}
                        ${note ? `<span class="d-block d-sm-inline"><strong style="color:rgba(255,255,255,0.7)">DeÄŸerlendirme:</strong> <span class="text-white-50 font-italic">${note}</span></span>` : ''}
                    </div>`;
                }

                const labelStyle = 'color: rgba(255, 255, 255, 0.7); font-weight: 600;';
                const valStyle = 'color: #fff; font-weight: 400;';

                comparisonRow = `
                <div class="row mt-3 pt-3 border-top border-secondary">
                    <div class="col-md-6 border-right border-secondary mb-3 mb-md-0">
                        <h6 class="text-info font-weight-bold mb-3 text-left" style="font-size:1.1rem;">Ä°ZLENEN MARKANIZ</h6>
                        <div class="d-flex align-items-start text-left">
                            <div class="mr-4" style="min-width:100px; text-align:center;"><img src="${myImgUrl}" class="task-brand-image" style="height:100px; width:auto; max-width:100%; object-fit:contain;"></div>
                            <div>
                                <div class="font-weight-bold mb-2" style="font-size:1.2rem; ${valStyle}">${monitoredData?.title || '-'}</div>
                                <div style="font-size:1rem; margin-bottom:4px;"><span style="${labelStyle}">No:</span> <span style="${valStyle}">${monitoredData?.applicationNumber || '-'}</span></div>
                                <div style="font-size:1rem;"><span style="${labelStyle}">SÄ±nÄ±f:</span> <span style="${valStyle}">${myClasses}</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-danger font-weight-bold mb-3 text-left" style="font-size:1.1rem;">BENZER MARKA</h6>
                        <div class="d-flex align-items-start text-left">
                            <div class="mr-4" style="min-width:100px; text-align:center;"><img src="${compImgUrl}" class="task-brand-image" style="height:100px; width:auto; max-width:100%; object-fit:contain;"></div>
                            <div>
                                <div class="font-weight-bold mb-2" style="font-size:1.2rem; ${valStyle}">${compName}</div>
                                <div style="font-size:1rem; margin-bottom:4px;"><span style="${labelStyle}">No:</span> <span style="${valStyle}">${compNo}</span></div>
                                <div style="font-size:1rem; margin-bottom:4px;"><span style="${labelStyle}">Sahip:</span> <span style="${valStyle}">${compOwner}</span></div>
                                <div style="font-size:1rem;"><span style="${labelStyle}">SÄ±nÄ±f:</span> <span style="${valStyle}">${compClasses}</span></div>
                                
                                <div class="mt-2">
                                    <button onclick="window.triggerTpQuery('${cleanCompNo}')" class="btn btn-sm btn-outline-light py-0 px-2" style="font-size: 0.85rem; border-color: rgba(255,255,255,0.3);">
                                        <i class="fas fa-search mr-1"></i> TÃœRKPATENT'ten Sorgula
                                    </button>
                                </div>

                            </div>
                        </div>
                        ${extraInfoHtml}
                    </div>
                </div>`;
            }

            const statusMap = { 'awaiting_client_approval': { text: 'Onay Bekliyor', class: 'warning' }, 'completed': { text: 'TamamlandÄ±', class: 'success' }, 'mÃ¼vekkil onayÄ± - kapatÄ±ldÄ±': { text: 'Reddedildi/KapandÄ±', class: 'danger' }, 'BÃ¼lten KapandÄ±': { text: 'SÃ¼resi Doldu', class: 'secondary' }, 'open': { text: 'AÃ§Ä±k', class: 'primary' } };
            const stInfo = statusMap[task.status] || { text: task.status, class: 'secondary' };

            let buttons = '';
            const detailBtn = `<button class="btn btn-info btn-sm btn-action task-detail mr-1" data-task-id="${task.id}"><i class="fas fa-eye"></i> Ä°ncele</button>`;
            if (isCompletedView) {
                if(task.status.includes('kapatÄ±ldÄ±')) buttons += `<button class="btn btn-success btn-sm btn-action task-reopen mr-1" data-id="${task.id}"><i class="fas fa-folder-open"></i> Ä°ÅŸi AÃ§</button>`;
                buttons += detailBtn;
            } else {
                buttons = `<button class="btn btn-success btn-sm btn-action task-approve mr-1" data-id="${task.id}"><i class="fas fa-check"></i> Onayla</button><button class="btn btn-danger btn-sm btn-action task-reject mr-1" data-id="${task.id}"><i class="fas fa-times"></i> Reddet</button>${detailBtn}`;
                if(isBulletinWatch) buttons += `<button class="btn btn-warning btn-sm btn-action task-compare-goods" data-task-id="${task.id}" data-ip-record-id="${monitoredId}" data-bulletin-key="${bulletinKey}" data-target-app-no="${task.details?.targetAppNo || ''}"><i class="fas fa-balance-scale"></i> KÄ±yasla</button>`;
            }

            const dateVal = window.formatDateTR(task.dueDate || task.officialDueDate || task.createdAt);
            const dateLabel = isCompletedView ? 'OluÅŸturma Tarihi:' : 'Son Onay Tarihi:';
            const dateWarning = !isCompletedView ? `<span class="text-muted ml-2 d-block d-sm-inline" style="font-size:0.85rem; font-style:italic;">(Bu tarih resmi son tarih olup, hak kaybÄ± yaÅŸanmamasÄ± adÄ±na talimatlarÄ±n bu tarihten en az 2 gÃ¼n Ã¶nce iletilmesi beklenmektedir.)</span>` : '';

            return `
            <div class="col-12 mb-4">
                <div class="task-card task-card-${stInfo.class}" data-task-id="${task.id}">
                    <div class="task-number-tag">${index + 1}.</div>
                    <h5 class="task-title ml-4">${cardTitle}</h5>
                    ${comparisonRow}
                    <div class="ml-4 mt-2 mb-2"><span class="badge badge-${stInfo.class}" style="font-size:0.85rem;">${stInfo.text}</span></div>
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mt-3">
                        <div class="mb-2 mb-md-0"><small class="task-meta"><i class="fas fa-clock mr-1"></i> <strong>${dateLabel} ${dateVal}</strong>${dateWarning}</small></div>
                        <div class="text-right">${buttons}</div>
                    </div>
                </div>
            </div>`;
        }));

        container.innerHTML = cardsHTML.join('');
    };
    

// --- 3. FATURA ---
window.fetchAndDisplayInvoices = async function(linkedIds) {
    console.log("ðŸ”µ Fatura yÃ¼kleme baÅŸladÄ±. BaÄŸlÄ± ID'ler:", linkedIds);
    
    const tbody = $('#invoices table tbody');
    tbody.html('<tr><td colspan="10" class="text-center"><i class="fas fa-spinner fa-spin"></i> YÃ¼kleniyor...</td></tr>');

    if (!linkedIds || linkedIds.length === 0) {
        tbody.html('<tr><td colspan="10" class="text-center text-muted">BaÄŸlÄ± hesap bilgisi bulunamadÄ±.</td></tr>');
        return;
    }

    try {
        const allAccruals = [];
        
        // 1. FaturalarÄ± Ã‡ek (Chunking ile)
        for (let i = 0; i < linkedIds.length; i += 10) {
            const chunk = linkedIds.slice(i, i + 10);
            const q = query(collection(db, 'accruals'), where('serviceInvoiceParty.id', 'in', chunk));
            const snap = await runGetDocs(q); // Ã–nbellek avantajÄ±yla anÄ±nda gelir
            snap.forEach(d => allAccruals.push({ id: d.id, ...d.data() }));
        }
        
        // TekilleÅŸtirme ve Tarihe GÃ¶re SÄ±ralama
        const unique = Array.from(new Map(allAccruals.map(a => [a.id, a])).values())
            .sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

        // ðŸ”¥ KRÄ°TÄ°K HIZLANDIRMA: Ekstra detaylarÄ± (BaÅŸvuru No) bekletmeden SAYAÃ‡LARI ANINDA GÃœNCELLE
        window.invoicesPaginationData.allDataUnfiltered = unique; 
        window.applyInvoiceFilter(); // Tablo anÄ±nda dolsun
        window.updateDashboardCounts(); // SayaÃ§ anÄ±nda ekrana gelsin

        // ðŸ”¥ ARKA PLAN Ä°ÅžLEMÄ°: Ekranda sayaÃ§lar gÃ¶rÃ¼nÃ¼rken, biz arkada eksik detaylarÄ± (BaÅŸvuru No vb.) getirelim
        (async () => {
            try {
                // Faturaya ait Task ID'lerini bul
                const taskIds = [...new Set(unique.map(i => i.taskId).filter(Boolean))];
                const taskMap = new Map(); // taskId -> task verisi

                if (taskIds.length > 0) {
                    for (let i = 0; i < taskIds.length; i += 10) {
                        const chunk = taskIds.slice(i, i + 10);
                        const tQ = query(collection(db, 'tasks'), where('__name__', 'in', chunk));
                        const tSnap = await getDocs(tQ);
                        tSnap.forEach(d => taskMap.set(d.id, d.data()));
                    }
                }

                // Task'lere ait IP (Marka/Patent) ID'lerini bul
                const ipIds = [...new Set(Array.from(taskMap.values()).map(t => t.relatedIpRecordId).filter(Boolean))];
                const ipMap = new Map(); // ipId -> applicationNumber

                if (ipIds.length > 0) {
                    // Ã–nce portfÃ¶yden belleÄŸe alÄ±nmÄ±ÅŸ veri var mÄ± diye bak (HÄ±z kazandÄ±rÄ±r)
                    const localData = window.allPortfolioData || [];
                    const missingIpIds = [];

                    ipIds.forEach(id => {
                        const found = localData.find(p => p.id === id);
                        if (found) {
                            ipMap.set(id, found.applicationNumber);
                        } else {
                            missingIpIds.push(id);
                        }
                    });

                    // Bellekte olmayan eksik IP kayÄ±tlarÄ±nÄ± veritabanÄ±ndan Ã§ek
                    if (missingIpIds.length > 0) {
                        for (let i = 0; i < missingIpIds.length; i += 10) {
                            const chunk = missingIpIds.slice(i, i + 10);
                            const ipQ = query(collection(db, 'ipRecords'), where('__name__', 'in', chunk));
                            const ipSnap = await getDocs(ipQ);
                            ipSnap.forEach(d => {
                                ipMap.set(d.id, d.data().applicationNumber);
                            });
                        }
                    }
                }

                // 3. Verileri BirleÅŸtir (Faturaya BaÅŸvuru No Ekle)
                unique.forEach(inv => {
                    if (inv.taskId) {
                        const task = taskMap.get(inv.taskId);
                        if (task && task.relatedIpRecordId) {
                            inv.applicationNumber = ipMap.get(task.relatedIpRecordId);
                        }
                    }
                });

                // BaÅŸvuru NumaralarÄ± tabloya yansÄ±sÄ±n diye filtreyi tekrar tetikle (kullanÄ±cÄ± fark etmez)
                window.invoicesPaginationData.allDataUnfiltered = unique; 
                window.applyInvoiceFilter();
                
            } catch (bgError) {
                console.error("Faturalara arka planda detay eklenirken hata:", bgError);
            }
        })(); // Arka plan (Async IIFE) fonksiyonu burada biter

    } catch (error) {
        console.error("âŒ Fatura yÃ¼kleme hatasÄ±:", error);
        tbody.html('<tr><td colspan="10" class="text-center text-danger">Veriler yÃ¼klenirken hata oluÅŸtu.</td></tr>');
    }
    
    // Fallback olarak (hata olsa bile) diÄŸer sayaÃ§larÄ± gÃ¼ncelle
    window.updateDashboardCounts();
};


    window.renderInvoicesTable = function(data) {
        const tbody = $('#invoices table tbody');
        tbody.empty();
        
        if(!data || data.length === 0) { 
            tbody.html('<tr><td colspan="10" class="text-center text-muted">KayÄ±t bulunamadÄ±.</td></tr>'); 
            return; 
        }
        
        // Currency Normalizer Helper
        const normalizeCurrency = (c) => {
            if(!c) return 'TRY';
            const upper = String(c).toUpperCase().trim();
            if(upper === 'EURO' || upper === 'AVRO' || upper === 'EUR') return 'EUR';
            if(upper === 'DOLAR' || upper === 'USD') return 'USD';
            if(upper === 'STERLIN' || upper === 'GBP') return 'GBP';
            return 'TRY';
        };

        // Veri Ã‡Ä±karma YardÄ±mcÄ±sÄ± (Obje veya SayÄ± kontrolÃ¼)
        const extractFee = (field) => {
            if (field && typeof field === 'object') {
                return { 
                    amount: Number(field.amount) || 0, 
                    currency: normalizeCurrency(field.currency) 
                };
            }
            return { 
                amount: Number(field) || 0, 
                currency: 'TRY' // VarsayÄ±lan
            };
        };

        data.forEach(inv => {
            let statusText = inv.status;
            let badgeClass = 'secondary';
            if (inv.status === 'paid') { statusText = 'Ã–dendi'; badgeClass = 'success'; }
            else if (inv.status === 'unpaid') { statusText = 'Ã–denmedi'; badgeClass = 'danger'; }
            else if (inv.status === 'partially_paid') { statusText = 'KÄ±smen Ã–dendi'; badgeClass = 'warning'; }

            const invoiceNoDisplay = inv.invoiceNo || (inv.id ? `#${inv.id.substring(0,8).toUpperCase()}` : '-');
            const appNoDisplay = inv.applicationNumber || '-';
            
            // Task ID Linki
            const taskIdDisplay = inv.taskId ? `<a href="#" class="task-detail" data-task-id="${inv.taskId}">#${inv.taskId}</a>` : '-';
            
            // --- TUTAR VE PARA BÄ°RÄ°MÄ° MANTIÄžI ---
            const offData = extractFee(inv.officialFee);
            const srvData = extractFee(inv.serviceFee);
            
            // Toplam Tutar ve Para Birimi Belirleme
            let totalVal = 0;
            if (inv.totalAmount && typeof inv.totalAmount === 'object') {
                totalVal = Number(inv.totalAmount.amount) || 0;
            } else {
                totalVal = Number(inv.totalAmount) || 0;
            }

            // Para Birimi Ã–nceliÄŸi:
            // 1. VeritabanÄ±ndaki 'totalAmountCurrency' TRY deÄŸilse onu kullan
            // 2. Alt kalemlerde EUR/USD varsa ve ana para birimi TRY ise, alt kalemi kullan
            let finalCurrency = normalizeCurrency(inv.totalAmountCurrency || inv.currency);
            
            if (finalCurrency === 'TRY') {
                if (offData.currency !== 'TRY') finalCurrency = offData.currency;
                else if (srvData.currency !== 'TRY') finalCurrency = srvData.currency;
            }

            // Formatlama
            const officialDisplay = window.currencyFormatter(offData.amount, finalCurrency);
            const serviceDisplay = window.currencyFormatter(srvData.amount, finalCurrency);
            let totalDisplay = window.currencyFormatter(totalVal, finalCurrency);
            
            // KÄ±smen Ã¶deme bilgisi
            if (inv.status === 'partially_paid') {
                const remVal = Number(inv.remainingAmount) || 0;
                if (remVal > 0) {
                    const remainingFormatted = window.currencyFormatter(remVal, finalCurrency);
                    totalDisplay += `<div class="small text-danger mt-1 font-weight-bold" style="font-size: 0.85em;">(Kalan: ${remainingFormatted})</div>`;
                }
            }

            const row = `<tr>
                <td class="font-weight-bold">${invoiceNoDisplay}</td>
                <td>${taskIdDisplay}</td>
                <td>${appNoDisplay}</td>
                <td>${window.formatDateTR(inv.createdAt)}</td>
                <td>${inv.taskTitle || inv.description || 'Hizmet Bedeli'}</td>
                
                <td>${officialDisplay}</td>
                <td>${serviceDisplay}</td>
                <td class="font-weight-bold">${totalDisplay}</td>
                
                <td><span class="badge badge-${badgeClass}" style="font-size: 0.85rem;">${statusText}</span></td>
                <td>
                    <button class="btn btn-sm btn-primary" title="Fatura/Debit Ä°ndir">
                        <i class="fas fa-download"></i>
                    </button>
                </td>
            </tr>`;
            tbody.append(row);
        });
    };

    window.applyInvoiceFilter = function() {
    const searchText = $('#invoiceSearchText').val().toLowerCase().trim();
    const statusFilter = $('#invoiceDurumFilter').val();
    const selectedClient = window.selectedClientId; // Global MÃ¼ÅŸteri SeÃ§imi
    
    if (!window.invoicesPaginationData.allDataUnfiltered) return;

    const filtered = window.invoicesPaginationData.allDataUnfiltered.filter(item => {
        // A) MÃœÅžTERÄ° SEÃ‡Ä°MÄ° FÄ°LTRESÄ°
        if (selectedClient && selectedClient !== 'ALL') {
            if (item.serviceInvoiceParty?.id !== selectedClient) return false;
        }

        // B) Metin AramasÄ±
        let textMatch = true;
        if (searchText) {
            const searchSource = [
                item.invoiceNo || '',
                item.id || '',
                item.description || '',
                item.taskTitle || '',
                String(item.totalAmount || '')
            ].join(' ').toLowerCase();
            
            if (!searchSource.includes(searchText)) textMatch = false;
        }

        // C) Durum Filtresi
        let statusMatch = true;
        if (statusFilter !== 'TÃœMÃœ') {
            if (item.status !== statusFilter) statusMatch = false;
        }

        return textMatch && statusMatch;
    });

    window.invoicesPaginationData.allData = filtered;

    // Render
    if (window.invoicesPaginationData.pagination) {
        window.invoicesPaginationData.pagination.update(filtered.length);
        window.invoicesPaginationData.pagination.currentPage = 1;
        window.renderInvoicesTable(filtered.slice(0, 10));
    } else {
        window.renderInvoicesTable(filtered);
    }
};

// --- 4. DAVA (GÃœNCELLENMÄ°Åž) ---
// Bu fonksiyon da sayfalama ve filtreleme iÃ§in global state kullanacak.
    window.renderDavaTable = function(rows, startIndex = 0) { // YENÄ° RENDER FONKSÄ°YONU
        const tbody = document.getElementById('dava-tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        if (!rows || rows.length === 0) { tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">KayÄ±t yok.</td></tr>'; return; }

        rows.forEach((r, index) => {
            const badge = r.status === 'Devam Ediyor' ? 'info' : 'secondary';
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${startIndex + index + 1}</td><td>${r.caseNo}</td><td><a href="#" class="dava-detail-link" data-suit-id="${r.id}">${r.title}</a></td><td>${r.subjectAssetTitle||'-'}</td><td>${r.court}</td><td>${r.opposingParty}</td><td>${r.openingDate}</td><td><span class="badge badge-${badge}">${r.status}</span></td>`;
            tbody.appendChild(tr);
        });
    };

window.fetchAndDisplaySuits = async function() {
    const tbody = document.getElementById('dava-tbody');
    if (tbody) tbody.innerHTML = '<tr><td colspan="8" class="text-center"><i class="fas fa-spinner fa-spin"></i> YÃ¼kleniyor...</td></tr>';

    try {
        let suitRows = [];
        let idx = 0;

        // KullanÄ±cÄ±nÄ±n baÄŸlÄ± olduÄŸu mÃ¼vekkil ID'leri varsa sorguyu yap
        if (window.linkedPersonIds && window.linkedPersonIds.length > 0) {
            const chunks = [];
            
            // Firestore 'in' sorgusu en fazla 10 eleman kabul ettiÄŸi iÃ§in diziyi 10'arlÄ± parÃ§alara bÃ¶lÃ¼yoruz
            for (let i = 0; i < window.linkedPersonIds.length; i += 10) {
                const chunk = window.linkedPersonIds.slice(i, i + 10);
                // Sadece bu mÃ¼ÅŸterilere ait davalarÄ± sunucudan/Ã¶nbellekten istiyoruz
                const q = query(collection(db, 'suits'), where('client.id', 'in', chunk));
                // runGetDocs kullanarak cache avantajÄ±ndan faydalanÄ±yoruz
                chunks.push(runGetDocs(q));
            }
            
            // TÃ¼m parÃ§alarÄ± paralel Ã§alÄ±ÅŸtÄ±r
            const snapshots = await Promise.all(chunks);
            
            snapshots.forEach(snap => {
                snap.forEach(d => {
                    const s = d.data();
                    idx++;
                    suitRows.push({ 
                        id: d.id, 
                        index: idx, 
                        caseNo: s.suitDetails?.caseNo || '-', 
                        title: s.suitDetails?.title || 'Dava', 
                        court: s.suitDetails?.court || '-', 
                        opposingParty: s.suitDetails?.opposingParty || '-', 
                        openingDate: window.formatDateTR(s.suitDetails?.openingDate), 
                        status: s.suitDetails?.suitStatus || 'Devam Ediyor',
                        suitStatus: s.suitDetails?.suitStatus || 'Devam Ediyor',
                        ...s.suitDetails, 
                        
                        client: s.client, 
                        clientName: s.client?.name, 
                        subjectAssetTitle: s.subjectAsset?.title, 
                        subjectAssetType: s.subjectAsset?.type, 
                        subjectAssetNumber: s.subjectAsset?.number 
                    });
                });
            });
        }

        // Global State'e Kaydet
        window.davaPaginationData.allDataUnfiltered = suitRows;
        window.suitsData = suitRows; 

        // Filtre ve Render Tetikle
        if($('#portfolioTopTabs a.nav-link.active').attr('href') === '#dava-list') {
            window.applyMasterFilter();
        } else {
            window.davaPaginationData.allData = suitRows;
            if (!window.davaPaginationData.pagination && window.Pagination) {
                 window.davaPaginationData.pagination = new window.Pagination({
                    itemsPerPage: 10,
                    containerId: 'davaPagination',
                    onPageChange: (page, perPage) => window.renderDavaTable(suitRows.slice((page-1)*perPage, page*perPage), (page-1)*perPage)
                });
            }
            if(window.davaPaginationData.pagination) window.davaPaginationData.pagination.update(suitRows.length);
            window.renderDavaTable(suitRows.slice(0,10));
        }

    } catch(e) { 
        console.error("Dava verileri Ã§ekilirken hata:", e); 
        if (tbody) tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Veriler yÃ¼klenirken hata oluÅŸtu.</td></tr>';
    }
};


// === Ä°TÄ°RAZ TABLOSU RENDER (GÃœNCELLENMÄ°Åž) ===
window.renderDavaItirazTable = function(parentRowsSlice, startIndex = 0) {
        const tbody = document.getElementById('dava-itiraz-tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        
        if (!parentRowsSlice || parentRowsSlice.length === 0) { 
            tbody.innerHTML = '<tr><td colspan="12" class="text-center text-muted">HenÃ¼z itiraz kaydÄ± bulunmamaktadÄ±r.</td></tr>'; 
            return; 
        }

        parentRowsSlice.forEach((row, index) => {
            const parentIndex = startIndex + index + 1;
            if (row.isParent) {
                const tr = document.createElement('tr');
                tr.setAttribute('data-origin', (row.origin || 'TÃœRKPATENT'));
                
                const imgHtml = row.brandImageUrl 
                    ? `<img src="${row.brandImageUrl}" alt="marka" class="brand-thumb">` 
                    : '<img src="https://placehold.co/100x100?text=Yok" alt="yok" class="brand-thumb">';
                
                const hasChildren = row.hasChildren || (row.childrenData && row.childrenData.length > 0);
                const iconHtml = hasChildren ? '<i class="fas fa-chevron-right mr-2"></i>' : '';
                
                if (hasChildren) {
                    const uniqueAccordionId = `itiraz-accordion-${row.recordId}-${row.id}`;
                    tr.classList.add('accordion-header-row');
                    tr.setAttribute('data-toggle', 'collapse');
                    tr.setAttribute('data-target', `#${uniqueAccordionId}`);
                }

                tr.innerHTML = `
                    <td>${iconHtml}${parentIndex}</td>
                    <td class="col-origin">${row.origin || '-'}</td>
                    <td class="text-center">${imgHtml}</td>
                    <td><a href="#" class="portfolio-detail-link" data-item-id="${row.recordId}">${row.title}</a></td>
                    <td>${row.transactionTypeName}</td>
                    <td>${row.applicationNumber}</td>
                    <td>${row.applicantName}</td>
                    <td>${row.bulletinDate}</td>
                    <td>${row.bulletinNo}</td>
                    <td>${row.epatsDate}</td>
                    <td><span class="badge badge-${row.statusBadge || 'warning'}">${row.statusText}</span></td>
                    <td>${window.renderDocsCell(row)}</td>`;
                
                tbody.appendChild(tr);

                if (hasChildren && row.childrenData) {
                    const uniqueAccordionId = `itiraz-accordion-${row.recordId}-${row.id}`;
                    const detailRow = document.createElement('tr');
                    detailRow.setAttribute('data-origin', (row.origin || 'TÃœRKPATENT'));
                    
                    const childrenHtml = row.childrenData.map(child => {
                        const childDocs = child.documents ? child.documents.map(d => ({ fileName: d.name || 'Belge', fileUrl: d.path || d.downloadURL, type: d.type, isTransactionDoc: true })) : [];
                        const childRowData = { allChildDocs: childDocs };
                        let childDate = '-'; if(child.timestamp) childDate = window.formatDateTR(child.timestamp);
                        const typeName = window.transactionTypesMap.get(String(child.type))?.alias || `Ä°ÅŸlem ${child.type}`;
                        return `<tr data-origin="${row.origin || 'TÃœRKPATENT'}"><td>${typeName}</td><td>${childDate}</td><td>${window.renderDocsCell(childRowData)}</td></tr>`;
                    }).join('');

                    detailRow.innerHTML = `<td colspan="12" class="p-0"><div class="collapse" id="${uniqueAccordionId}"><table class="table mb-0 accordion-table bg-light" style="font-size:0.9em;"><thead><tr><th>Ä°ÅŸlem Tipi</th><th>Ä°ÅŸlem Tarihi</th><th>Evraklar</th></tr></thead><tbody>${childrenHtml}</tbody></table></div></td>`;
                    tbody.appendChild(detailRow);
                }
            }
        });
        const currentFilter = $("#menseFilter").val() || 'TÃœRKPATENT';
        if (currentFilter === 'TÃœRKPATENT') {
            $('#dava-itiraz-list th.col-origin, #dava-itiraz-list td.col-origin').hide();
        } else {
            $('#dava-itiraz-list th.col-origin, #dava-itiraz-list td.col-origin').show();
        }
    };

// --- 5. Ä°TÄ°RAZ MODÃœLÃœ (FÄ°LTRE SORUNU KESÄ°N Ã‡Ã–ZÃœM) ---

window.fetchAndDisplayObjections = async function() {
    const tbody = document.getElementById('dava-itiraz-tbody');
    if(!tbody) return;

    tbody.innerHTML = '<tr><td colspan="12" class="text-center"><i class="fas fa-spinner fa-spin"></i> YÃ¼kleniyor...</td></tr>';

    const REQUEST_RESULT_STATUS = {
        '24': 'Eksiklik Bildirimi', '28': 'Kabul', '29': 'KÄ±smi Kabul', '30': 'Ret',
        '31': 'B.S - Kabul', '32': 'B.S - KÄ±smi Kabul','33': 'B.S - Ret',
        '34': 'Ä°.S - Kabul', '35': 'Ä°.S - KÄ±smi Kabul','36': 'Ä°.S - Ret',
        '50': 'Kabul', '51': 'KÄ±smi Kabul', '52': 'Ret'
    };

    try {
        const PARENT_TYPES = ['7', '19', '20', 7, 19, 20];
        const q = query(collection(db, 'tasks'), where('taskType', 'in', PARENT_TYPES));
        
        // runGetDocs kullanarak veriyi Ã¶nbellekten (cache) veya sunucudan tek seferde alÄ±yoruz
        const snap = await runGetDocs(q);

        const rawTasks = [];
        snap.forEach(docSnap => {
            const t = docSnap.data();
            const statusRaw = (t.status || '').trim();
            // KapanmÄ±ÅŸ veya iptal edilmiÅŸ gÃ¶revleri en baÅŸtan ele
            if (!statusRaw.includes('kapatÄ±ldÄ±') && statusRaw !== 'cancelled') {
                rawTasks.push({ id: docSnap.id, ...t });
            }
        });

        const clientSet = new Set(window.linkedPersonIds || []);

        // -------------------------------------------------------------------------
        // 1. ADIM: N+1 SORGUSUNU Ã–NLEMEK Ä°Ã‡Ä°N EKSÄ°K MARKALARI TOPLUCA (PARALEL) Ã‡EK
        // -------------------------------------------------------------------------
        const neededIpIds = [...new Set(rawTasks.map(t => t.relatedIpRecordId).filter(Boolean))];
        const ipDataMap = new Map();
        const missingIpIds = [];

        // Ã–nce bellekte (PortfÃ¶y sekmesinde yÃ¼klenenler arasÄ±nda) var mÄ± diye bak (HÄ±z KazandÄ±rÄ±r)
        neededIpIds.forEach(id => {
            const local = (window.allPortfolioData || []).find(p => p.id === id);
            if (local) {
                ipDataMap.set(id, local);
            } else {
                missingIpIds.push(id);
            }
        });

        // Bellekte olmayanlarÄ± 10'arlÄ± gruplar halinde "aynÄ± anda" (Promise.all) Ã§ek
        if (missingIpIds.length > 0) {
            const chunks = [];
            for (let i = 0; i < missingIpIds.length; i += 10) {
                chunks.push(missingIpIds.slice(i, i + 10));
            }

            await Promise.all(chunks.map(async chunk => {
                const ipQ = query(collection(db, 'ipRecords'), where('__name__', 'in', chunk));
                const ipSnap = await runGetDocs(ipQ);
                ipSnap.forEach(d => ipDataMap.set(d.id, d.data()));
            }));
        }

        // -------------------------------------------------------------------------
        // 2. ADIM: YETKÄ° KONTROLÃœ (VeritabanÄ±na gitmeden bellekteki verilerle)
        // -------------------------------------------------------------------------
        const relevantTasks = [];
        for (const task of rawTasks) {
            let isMatch = false;
            if (!task._relatedClientIds) task._relatedClientIds = [];

            // DoÄŸrudan gÃ¶rev Ã¼zerindeki ID'leri kontrol et
            if (task.clientId && clientSet.has(task.clientId)) {
                if (!task._relatedClientIds.includes(task.clientId)) task._relatedClientIds.push(task.clientId);
                isMatch = true;
            }
            if (task.taskOwner && typeof task.taskOwner === 'string' && clientSet.has(task.taskOwner)) {
                if (!task._relatedClientIds.includes(task.taskOwner)) task._relatedClientIds.push(task.taskOwner);
                isMatch = true;
            }
            if (Array.isArray(task.taskOwner)) {
                task.taskOwner.forEach(id => {
                    if (clientSet.has(id)) {
                        if (!task._relatedClientIds.includes(id)) task._relatedClientIds.push(id);
                        isMatch = true;
                    }
                });
            }

            const opponentId = task.opponent?.id || task.details?.opponent?.id;
            if (opponentId && clientSet.has(opponentId)) {
                if (!task._relatedClientIds.includes(opponentId)) task._relatedClientIds.push(opponentId);
                isMatch = true;
            }

            // Ä°lgili Marka/Patent kaydÄ±nÄ±n sahiplerini kontrol et
            if (task.relatedIpRecordId) {
                const rec = ipDataMap.get(task.relatedIpRecordId);
                if (rec && rec.applicants && Array.isArray(rec.applicants)) {
                    rec.applicants.forEach(app => {
                        if (app.id && clientSet.has(app.id)) {
                            if (!task._relatedClientIds.includes(app.id)) task._relatedClientIds.push(app.id);
                            isMatch = true;
                        }
                    });
                }
            }

            if (isMatch) {
                relevantTasks.push(task);
            }
        }

        // -------------------------------------------------------------------------
        // 3. ADIM: ALT Ä°ÅžLEMLERÄ° (TRANSACTIONS) PARALEL Ã‡EK
        // -------------------------------------------------------------------------
        const txMap = new Map();
        const relevantIpIds = [...new Set(relevantTasks.map(t => t.relatedIpRecordId).filter(Boolean))];

        // DÃ¶ngÃ¼ iÃ§inde beklemek (await) yerine tÃ¼m istekleri aynÄ± anda (Promise.all) yolluyoruz
        await Promise.all(relevantIpIds.map(async id => {
            try {
                const txQ = query(collection(db, 'ipRecords', id, 'transactions'));
                const txSnap = await runGetDocs(txQ);
                txMap.set(id, txSnap.docs.map(d => ({id: d.id, ...d.data()})));
            } catch(e) { }
        }));

        // -------------------------------------------------------------------------
        // 4. ADIM: EKRANA YAZDIRILACAK VERÄ°YÄ° HAZIRLA (Tamamen Senkron & HÄ±zlÄ±)
        // -------------------------------------------------------------------------
        const rows = [];
        for (const task of relevantTasks) {
            let rec = ipDataMap.get(task.relatedIpRecordId) || {};
            let allTx = txMap.get(task.relatedIpRecordId) || [];

            // Parent Transaction EÅŸleÅŸtirme
            let parentTx = null;
            if (task.triggeringTransactionId) {
                parentTx = allTx.find(x => x.id === task.triggeringTransactionId);
            }
            if (!parentTx) {
                parentTx = allTx.filter(x => String(x.type) === String(task.taskType))
                                .sort((a,b) => (b.timestamp?.seconds||0) - (a.timestamp?.seconds||0))[0];
            }

            // Transaction Yoksa Sanal OluÅŸtur
            if (!parentTx) {
                parentTx = {
                    id: 'virtual-tx-' + task.id,
                    type: task.taskType,
                    timestamp: task.createdAt || task.startDate || new Date(),
                    requestResult: null,
                    documents: [],
                    isVirtual: true
                };
            }

            // StatÃ¼ Rengi
            let computedStatus = 'Karar Bekleniyor';
            let badgeColor = 'secondary';
            const rr = parentTx.requestResult;
            const statusRaw = (task.status || '').trim();

            if (rr && REQUEST_RESULT_STATUS[String(rr)]) {
                computedStatus = REQUEST_RESULT_STATUS[String(rr)];
                if (computedStatus.includes('Ret')) badgeColor = 'danger';
                else if (computedStatus.includes('Kabul')) badgeColor = 'success';
                else badgeColor = 'info';
            } else if (statusRaw.includes('awaiting') || statusRaw.includes('Bekliyor')) {
                computedStatus = 'Onay Bekliyor';
                badgeColor = 'warning';
            }

            const children = parentTx.isVirtual ? [] : allTx.filter(x => x.transactionHierarchy==='child' && x.parentId===parentTx.id);
            const typeMeta = window.transactionTypesMap.get(String(task.taskType));

            const docs = [];
            if(parentTx.documents) docs.push(...parentTx.documents.map(d=>({...d, isTransactionDoc:true})));
            if(task.documents) docs.push(...task.documents.map(d=>({...d, isTaskDoc:true})));

            // Sahiplik Belirleme
            let filterApplicants = [];
            if (task._relatedClientIds && task._relatedClientIds.length > 0) {
                filterApplicants = task._relatedClientIds.map(id => ({ id: id, name: 'MÃ¼vekkil' }));
            } else if (task.clientId) {
                filterApplicants = [{ id: task.clientId, name: 'MÃ¼vekkil' }];
            } else {
                filterApplicants = rec.applicants || [];
            }

            rows.push({
                isParent: true,
                id: task.id,
                recordId: task.relatedIpRecordId,
                hasChildren: children.length > 0,
                origin: rec.origin || 'TÃœRKPATENT',
                brandImageUrl: rec.brandImageUrl,
                title: rec.title || rec.brandText || 'Ä°simsiz Marka',
                transactionTypeName: typeMeta?.alias || 'Ä°tiraz Ä°ÅŸlemi',
                applicationNumber: rec.applicationNumber || '-',
                applicantName: rec.applicants?.[0]?.name || '-', 
                applicants: filterApplicants,
                bulletinDate: window.formatDateTR(rec.details?.brandInfo?.opposedMarkBulletinDate),
                bulletinNo: rec.details?.brandInfo?.opposedMarkBulletinNo || '-',
                epatsDate: window.formatDateTR(parentTx.timestamp),
                statusText: computedStatus,
                statusBadge: badgeColor,
                allParentDocs: docs,
                childrenData: children
            });
        }

        window.davaItirazPaginationData.allDataUnfiltered = rows;

        if($('#portfolioTopTabs a.nav-link.active').attr('href') === '#dava-itiraz-list') {
            window.applyMasterFilter();
        } else {
            window.davaItirazPaginationData.allData = rows;
            if (!window.davaItirazPaginationData.pagination && window.Pagination) {
                 window.davaItirazPaginationData.pagination = new window.Pagination({
                    itemsPerPage: 10,
                    containerId: 'davaItirazPagination',
                    onPageChange: (page, perPage) => {
                        const slice = window.davaItirazPaginationData.allData.slice((page-1)*perPage, page*perPage);
                        window.renderDavaItirazTable(slice, (page-1)*perPage);
                    }
                 });
            }
            if(window.davaItirazPaginationData.pagination) window.davaItirazPaginationData.pagination.update(rows.length);
            window.renderDavaItirazTable(rows.slice(0,10));
        }

    } catch(e) {
        console.error("Objection Error", e);
        tbody.innerHTML = '<tr><td colspan="12" class="text-danger text-center">Ä°tirazlar yÃ¼klenirken hata oluÅŸtu.</td></tr>';
    }
};

    // --- PDF & LOAD TRANSACTIONS ---
    window.fetchPdfsForTransactions = async function(transactionIds) {
        if (!transactionIds || transactionIds.length === 0) return {};
        try {
            const pdfMap = {};
            const chunks = [];
            for (let i = 0; i < transactionIds.length; i += 10) chunks.push(transactionIds.slice(i, i + 10));
            for (const chunk of chunks) {
                const q = query(collection(db, 'unindexed_pdfs'), where('associatedTransactionId', 'in', chunk), where('status', '==', 'indexed'));
                const snapshot = await getDocs(q);
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const txId = data.associatedTransactionId;
                    if (!pdfMap[txId]) pdfMap[txId] = [];
                    pdfMap[txId].push({ fileName: data.fileName || 'Belge', fileUrl: data.fileUrl || data.url || data.path, type: 'transaction_doc', indexedAt: data.indexedAt });
                });
            }
            return pdfMap;
        } catch (error) { console.error("PDF Fetch HatasÄ±:", error); return {}; }
    };

    window.fetchTaskDocuments = async function(taskId) {
        if (!taskId) return [];
        try {
            const taskDoc = await getDoc(doc(db, 'tasks', taskId));
            if (!taskDoc.exists()) return [];
            const data = taskDoc.data();
            const docs = [];
            if (data.details?.epatsDocument) docs.push({ fileName: data.details.epatsDocument.name || 'ePats Belgesi', fileUrl: data.details.epatsDocument.downloadURL || data.details.epatsDocument.url, type: 'epats_document', evrakNo: data.details.epatsDocument.turkpatentEvrakNo });
            if (Array.isArray(data.documents)) {
                data.documents.forEach(d => {
                    const url = d.downloadURL || d.url || d.path;
                    if(url) docs.push({ fileName: d.name || 'Task Belgesi', fileUrl: url, type: 'task_document' });
                });
            }
            return docs;
        } catch (error) { console.error("Task Docs HatasÄ±:", error); return []; }
    };
    window.loadTransactions = async function(ipRecordId) {
        const tbody = $('#modal-islemler table tbody');
        if (tbody.length === 0) return;
        
        // YÃ¼kleniyor animasyonu
        tbody.html('<tr><td colspan="4" class="text-center py-4"><i class="fas fa-spinner fa-spin"></i> Ä°ÅŸlemler ve evraklar yÃ¼kleniyor...</td></tr>');
        
        // Belge tekilleÅŸtirme (URL bazlÄ±)
        const uniqueDocsFilter = (docs) => { 
            const seen = new Set(); 
            return docs.filter(doc => { 
                const url = doc.fileUrl || doc.url || doc.path || doc.downloadURL; 
                if (!url || seen.has(url)) return false; 
                seen.add(url); 
                return true; 
            }); 
        };

        // --- 1. Ã–NCELÄ°K LÄ°STESÄ° (KÃ¼Ã§Ã¼k sayÄ± en Ã¼stte Ã§Ä±kar) ---
        const typePriority = {
            '2': 1,   // BaÅŸvuru (En Ãœst)
            '7': 2,   // Karara Ä°tiraz
            '20': 3,  // YayÄ±na Ä°tiraz
            '19': 4   // Y.Ä°. Yeniden Ä°nceleme
        };

        try {
            // 1. Ä°ÅŸlemleri Ã‡ek
            const transactionsRef = collection(db, 'ipRecords', ipRecordId, 'transactions');
            const snapshot = await getDocs(query(transactionsRef));
            const transactions = [];
            
            snapshot.forEach(doc => {
                const data = doc.data();
                const safeType = data.type || data.transactionType || ''; 
                transactions.push({ 
                    id: doc.id, 
                    ...data,
                    type: safeType
                }); 
            });
            
            console.log(`Toplam ${transactions.length} iÅŸlem Ã§ekildi.`);

            // 2. PDF'leri HazÄ±rla
            const pdfsByTransaction = await window.fetchPdfsForTransactions(transactions.map(tx => tx.id));
            
            // --- 3. SIRALAMA ALGORÄ°TMASI ---
            const parentTransactions = transactions
                .filter(t => t.transactionHierarchy === 'parent' || !t.transactionHierarchy)
                .sort((a, b) => {
                    const typeA = String(a.type).trim();
                    const typeB = String(b.type).trim();
                    
                    const pA = typePriority[typeA] || 999;
                    const pB = typePriority[typeB] || 999;

                    // A) Ã–ncelik FarklÄ±ysa: Ã–nceliÄŸi kÃ¼Ã§Ã¼k olan (1) ÃœSTE
                    if (pA !== pB) return pA - pB; 

                    // B) Ã–ncelik AynÄ±ysa: TARÄ°HE GÃ–RE (Eskiden Yeniye / En yeni en altta)
                    const dateA = a.timestamp?.seconds || 0;
                    const dateB = b.timestamp?.seconds || 0;
                    return dateA - dateB; 
                });

            tbody.empty();
            let rowIndex = 1;
            
            // --- 4. RENDER DÃ–NGÃœSÃœ ---
            for (const parent of parentTransactions) {
                
                const children = transactions
                    .filter(t => t.transactionHierarchy === 'child' && t.parentId === parent.id)
                    .sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                
                const hasChildren = children.length > 0;
                const accordionId = `transaction-${parent.id}`;
                
                // Ä°ÅŸlem AdÄ±
                let transactionAlias = 'Ä°ÅŸlem';
                if (window.transactionTypesMap && window.transactionTypesMap.has(String(parent.type))) {
                    const t = window.transactionTypesMap.get(String(parent.type));
                    transactionAlias = t.alias || t.name;
                    if (String(parent.type) === '20') { 
                        const oppositionOwner = parent.oppositionOwner || parent.relatedParty?.name; 
                        if (oppositionOwner) transactionAlias += ` (${oppositionOwner})`; 
                    }
                } else {
                    if(parent.description) transactionAlias = parent.description;
                }

                // --- ROZET (BADGE) MANTIÄžI (GÃœNCELLENDÄ°) ---
                let resultBadge = '';
                if (parent.requestResult) {
                    const rrId = String(parent.requestResult);
                    const resultType = window.transactionTypesMap.get(rrId);
                    
                    if (resultType) {
                        const resultName = resultType.alias || resultType.name;
                        const lowerName = resultName.toLowerCase();
                        const parentType = String(parent.type);
                        
                        let badgeColor = 'info'; // VarsayÄ±lan

                        // 1. YayÄ±na Ä°tiraz (Type 20) - SÄ°ZE Ä°TÄ°RAZ EDÄ°LDÄ°
                        if (parentType === '20') {
                            // Kabul (Aleyhinize) -> KÄ±rmÄ±zÄ±
                            if (lowerName.includes('kabul')) {
                                badgeColor = 'danger';
                            } 
                            // DiÄŸerleri (Ret vb. - Lehinize) -> YeÅŸil
                            else {
                                badgeColor = 'success';
                            }
                        } 
                        // 2. YÄ°YÄ° (Type 19) - SÄ°ZÄ°N Ä°TÄ°RAZINIZ
                        else if (parentType === '19') {
                            // Ret (Aleyhinize) -> KÄ±rmÄ±zÄ±
                            if (lowerName.includes('ret') || lowerName.includes('red') || lowerName.includes('reddi')) {
                                badgeColor = 'danger';
                            } 
                            // DiÄŸerleri (Kabul vb. - Lehinize) -> YeÅŸil
                            else {
                                badgeColor = 'success';
                            }
                        } 
                        // 3. DiÄŸer Ä°ÅŸlemler (Standart MantÄ±k)
                        else {
                            if(lowerName.includes('ret') || lowerName.includes('red')) badgeColor = 'danger';
                            else if(lowerName.includes('kabul') || lowerName.includes('onay')) badgeColor = 'success';
                            else if(lowerName.includes('kÄ±smen')) badgeColor = 'warning';
                        }

                        resultBadge = `<span class="badge badge-${badgeColor} ml-2" style="font-size: 0.85em;">ðŸ ${resultName}</span>`;
                    }
                }

                // --- Belge Toplama (Fallback MantÄ±ÄŸÄ±) ---
                const parentPdfs = pdfsByTransaction[parent.id] || [];
                const parentDirectDocs = (parent.documents || []).map(d => ({ 
                    fileName: d.name, 
                    fileUrl: d.path || d.downloadURL, 
                    type: d.type 
                }));
                
                let rawParentDocs = [...parentPdfs, ...parentDirectDocs];

                if (rawParentDocs.length === 0 && parent.triggeringTaskId) {
                    const taskDocs = await window.fetchTaskDocuments(parent.triggeringTaskId);
                    rawParentDocs = [...rawParentDocs, ...taskDocs];
                }

                const allParentDocs = uniqueDocsFilter(rawParentDocs);
                const parentDocLinks = allParentDocs.map(pdf => window._createDocLinkHtml(pdf)).join('');

                const parentRow = `
                    <tr class="${hasChildren ? 'accordion-header-row' : ''}" ${hasChildren ? `data-toggle="collapse" data-target="#${accordionId}" aria-expanded="false"` : ''}>
                        <td>${hasChildren ? '<i class="fas fa-chevron-right mr-2"></i>' : ''}${rowIndex}</td>
                        <td>${transactionAlias} ${resultBadge}</td>
                        <td>${window.formatDateTR(parent.timestamp)}</td>
                        <td>${parentDocLinks || '<span class="text-muted">-</span>'}</td>
                    </tr>`;
                tbody.append(parentRow);

                if (hasChildren) {
                    let childRowsHtml = '';
                    for (const [idx, child] of children.entries()) {
                        let childAlias = 'Alt Ä°ÅŸlem';
                        if (window.transactionTypesMap.has(String(child.type))) {
                            childAlias = window.transactionTypesMap.get(String(child.type)).alias;
                            if (String(child.type) === '20') { 
                                const oppositionOwner = child.oppositionOwner || child.relatedParty?.name; 
                                if (oppositionOwner) childAlias += ` (${oppositionOwner})`; 
                            }
                        }

                        const childPdfs = pdfsByTransaction[child.id] || [];
                        const childDirectDocs = (child.documents || []).map(d => ({ 
                            fileName: d.name, fileUrl: d.path || d.downloadURL, type: d.type 
                        }));
                        
                        let rawChildDocs = [...childPdfs, ...childDirectDocs];

                        if (rawChildDocs.length === 0 && child.triggeringTaskId) {
                            const childTaskDocs = await window.fetchTaskDocuments(child.triggeringTaskId);
                            rawChildDocs = [...rawChildDocs, ...childTaskDocs];
                        }

                        const allChildDocs = uniqueDocsFilter(rawChildDocs);
                        const childDocLinks = allChildDocs.map(pdf => window._createDocLinkHtml(pdf)).join('');
                        
                        childRowsHtml += `<tr><td>${rowIndex}.${idx + 1}</td><td>${childAlias}</td><td>${window.formatDateTR(child.timestamp)}</td><td>${childDocLinks || '-'}</td></tr>`;
                    }
                    const detailRow = `<tr><td colspan="4" class="p-0"><div class="collapse" id="${accordionId}"><table class="table mb-0 accordion-table bg-light" style="font-size:0.9em;"><thead><tr><th>#</th><th>Ä°ÅŸlem DetayÄ±</th><th>Tarih</th><th>Evrak</th></tr></thead><tbody>${childRowsHtml}</tbody></table></div></td></tr>`;
                    tbody.append(detailRow);
                }
                rowIndex++;
            }
            
            if (parentTransactions.length === 0) {
                tbody.html('<tr><td colspan="4" class="text-center text-muted">Ä°ÅŸlem geÃ§miÅŸi bulunamadÄ±.</td></tr>');
            }

        } catch (error) { 
            console.error("Transaction YÃ¼kleme HatasÄ±:", error); 
            tbody.html('<tr><td colspan="4" class="text-center text-danger">Veriler yÃ¼klenirken hata oluÅŸtu.</td></tr>'); 
        }
    };

    function initTheme() {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        $('body').removeClass('light-mode dark-mode').addClass(savedTheme + '-mode');
        $('#themeSwitch').prop('checked', savedTheme === 'dark');
        $('.custom-control-label').text(savedTheme === 'dark' ? 'Koyu Tema' : 'AÃ§Ä±k Tema');
        $('#themeSwitch').off('change').on('change', function() {
            const isChecked = $(this).is(':checked');
            const newTheme = isChecked ? 'dark' : 'light';
            $('body').removeClass('light-mode dark-mode').addClass(newTheme + '-mode');
            localStorage.setItem('theme', newTheme);
            $(this).next('label').text(isChecked ? 'Koyu Tema' : 'AÃ§Ä±k Tema');
        });
    }

// === GLOBAL HELPER FONKSÄ°YONLAR (READY DIÅžINDA OLMALI) ===

// === DASHBOARD SAYAÃ‡LARINI GÃœNCELLE (DÃœZELTÄ°LMÄ°Åž) ===
    window.updateDashboardCounts = function() {
        const selectedClient = window.selectedClientId;
        console.log("ðŸ“Š Dashboard sayaÃ§larÄ± gÃ¼ncelleniyor...");

        // 1. PORTFÃ–Y SAYACI
        const allPortfolios = window.allPortfolioData || [];
        let filteredPortfolio = allPortfolios;
        
        if (selectedClient !== 'ALL') {
            filteredPortfolio = allPortfolios.filter(item => {
                return item.applicants && Array.isArray(item.applicants) && item.applicants.some(a => a.id === selectedClient);
            });
        }
        $('#dashPortfolio').text(filteredPortfolio.length);

        // 2. GÃ–REV (TASK) SAYAÃ‡LARI
        const allTasks = window.dashboardTasksData || [];
        let filteredTasks = allTasks;

        if (selectedClient !== 'ALL') {
            filteredTasks = allTasks.filter(t => {
                return t._relatedClientIds && t._relatedClientIds.includes(selectedClient);
            });
        }

        // SayaÃ§ DeÄŸiÅŸkenleri
        let cPending = 0;       // Marka - Onay Bekleyen
        let cRenewal = 0;       // Marka - Yenileme
        let cBulletin = 0;      // Marka - BÃ¼lten
        let cDavaPending = 0;   // Dava - Onay Bekleyen
        let cDavaCompleted = 0; // Dava - Tamamlanan
        
        const today = new Date(); today.setHours(0,0,0,0);

        filteredTasks.forEach(t => {
            const type = String(t.taskType);
            
            // 1. Ã–nce Dava KontrolÃ¼
            if (window.isDavaTask(t)) {
                if (t.status === 'awaiting_client_approval') {
                    cDavaPending++;
                } else {
                    cDavaCompleted++;
                }
            } 
            // 2. Marka/Patent Ä°ÅŸlemleri (Dava DeÄŸilse)
            else {
                if (type === '22') {
                    cRenewal++;
                } else if (type === '20') { 
                    const due = t.dueDate || t.officialDueDate;
                    let isExpired = false;
                    if (due) {
                        const d = due.seconds ? new Date(due.seconds*1000) : new Date(due);
                        d.setHours(0,0,0,0);
                        if (d < today) isExpired = true;
                    }
                    if (!isExpired) cBulletin++;
                } else if (t.status === 'awaiting_client_approval') { 
                    cPending++;
                }
            }
        });

        // Marka KartlarÄ±
        $('#taskCount-pending-approval').text(cPending);
        $('#taskCount-renewal-approval').text(cRenewal);
        $('#taskCount-bulletin-watch').text(cBulletin);
        
        const totalMarkaPending = cPending + cRenewal + cBulletin;
        $('#taskCount-marka-total').text(totalMarkaPending);

        // --- DAVA KARTLARI (YENÄ°) ---
        $('#taskCount-dava-pending').text(cDavaPending);     // Alt Kart
        $('#taskCount-dava-completed').text(cDavaCompleted); // Alt Kart
        $('#taskCount-dava-total').text(cDavaPending);       // Ana Kart (Sadece bekleyenleri gÃ¶sterir)

        // Ana Dashboard ToplamÄ±
        $('#dashPendingApprovals').text(totalMarkaPending + cDavaPending);

        // 3. FATURA SAYACI
        const allInvoices = window.invoicesPaginationData?.allDataUnfiltered || [];
        let filteredInvoices = allInvoices;

        if (selectedClient !== 'ALL') {
            filteredInvoices = allInvoices.filter(inv => inv.serviceInvoiceParty?.id === selectedClient);
        }

        const unpaidCount = filteredInvoices.filter(a => a.status === 'unpaid').length;
        $('#dashUnpaidInvoices').text(unpaidCount);
    };


// === GÃ–REV (TASK) FÄ°LTRELEME FONKSÄ°YONU ===
    window.applyTaskFilter = function() {
        const searchText = $('#taskSearchText').val().toLowerCase().trim();
        const statusFilter = $('#taskStatusFilter').val();
        const taskType = window.taskPaginationData.currentType;
        const allData = window.taskPaginationData.allDataUnfiltered || [];
        const selectedClient = window.selectedClientId; // Global MÃ¼ÅŸteri SeÃ§imi

        // 1. FÄ°LTRELEME
        let filteredTasks = allData.filter(t => {
            // A) MÃœÅžTERÄ° SEÃ‡Ä°MÄ° FÄ°LTRESÄ° (GÃœÃ‡LENDÄ°RÄ°LMÄ°Åž)
            if (selectedClient && selectedClient !== 'ALL') {
                // EÄŸer task bu mÃ¼ÅŸteriye ait olarak iÅŸaretlenmemiÅŸse gizle
                if (!t._relatedClientIds || !t._relatedClientIds.includes(selectedClient)) {
                    return false;
                }
            }

            // B) Metin AramasÄ±
            if (searchText) {
                const searchable = [
                    t.id,
                    t.title,
                    t.description,
                    t.details?.objectionTarget,
                    t.details?.targetAppNo,
                    t.details?.bulletinNo
                ].join(' ').toLowerCase();
                
                if (!searchable.includes(searchText)) return false;
            }

            // C) Durum Filtresi
            if (statusFilter && statusFilter !== 'TÃœMÃœ') {
                if (t.status !== statusFilter) return false;
            }

            return true;
        });

        // 2. Render HazÄ±rlÄ±ÄŸÄ± (DevamÄ± aynÄ±)
        window.taskPaginationData.allData = filteredTasks;
        const container = document.getElementById('task-list-container');
        const formatDate = window.formatDateTR;

        // ... (Fonksiyonun geri kalanÄ± aynÄ±, dokunmanÄ±za gerek yok) ...
        // A) Completed Tasks GÃ¶rÃ¼nÃ¼mÃ¼
        if (taskType === 'completed-tasks') {
            // ... (Kalan kodlar aynÄ±) ...
            const activeStatuses = ['open', 'in_progress', 'pending'];
            const active = filteredTasks.filter(t => activeStatuses.includes(t.status));
            const closed = filteredTasks.filter(t => !activeStatuses.includes(t.status));
            
            container.innerHTML = `
                <ul class="nav nav-tabs mb-3">
                    <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#tab-act">Aktif (${active.length})</a></li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#tab-fin">Kapanan (${closed.length})</a></li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="tab-act"><div class="row" id="cont-act"></div></div>
                    <div class="tab-pane fade" id="tab-fin"><div class="row" id="cont-fin"></div></div>
                </div>`;
            
            window._renderTaskCardsToContainer(active.slice(0,10), '#cont-act', formatDate, taskType);
            if(closed.length) window._renderTaskCardsToContainer(closed.slice(0,10), '#cont-fin', formatDate, taskType);
            $('#taskPagination').hide();
            return;
        }

        // B) Bulletin Watch GÃ¶rÃ¼nÃ¼mÃ¼
        if (taskType === 'bulletin-watch') {
            const groups = {}; 
            const expired = []; 
            const today = new Date(); today.setHours(0,0,0,0);
            
            filteredTasks.forEach(t => {
                const due = t.dueDate || t.officialDueDate;
                let isExp = false;
                if (due) { const d = due.seconds ? new Date(due.seconds*1000) : new Date(due); d.setHours(0,0,0,0); if (d < today) isExp = true; }
                if (isExp) { 
                    const tClone = {...t, status: 'BÃ¼lten KapandÄ±'}; 
                    expired.push(tClone); 
                } else { 
                    const bNo = t.details?.bulletinNo || 'DiÄŸer'; 
                    if (!groups[bNo]) groups[bNo] = []; 
                    groups[bNo].push(t); 
                }
            });
            
            const bNumbers = Object.keys(groups).sort((a,b)=>b-a);
            
            if (bNumbers.length === 0 && expired.length === 0) {
                container.innerHTML = '<div class="text-center text-muted p-4">Aranan kriterlere uygun kayÄ±t bulunamadÄ±.</div>';
                return;
            }

            let html = '<ul class="nav nav-tabs mb-3">'; 
            let content = '<div class="tab-content">';
            
            bNumbers.forEach((no, i) => {
                const active = i===0 ? 'active' : '';
                html += `<li class="nav-item"><a class="nav-link ${active}" data-toggle="tab" href="#b-${no}">BÃ¼lten ${no} (${groups[no].length})</a></li>`;
                content += `<div class="tab-pane fade ${active ? 'show active' : ''}" id="b-${no}"><div class="row" id="row-b-${no}"></div></div>`;
            });
            
            if (expired.length > 0) {
                const cls = bNumbers.length === 0 ? 'active' : '';
                html += `<li class="nav-item"><a class="nav-link ${cls}" data-toggle="tab" href="#b-exp">Ã–nceki BÃ¼ltenler (${expired.length})</a></li>`;
                content += `<div class="tab-pane fade ${cls ? 'show active' : ''}" id="b-exp"><div class="alert alert-secondary">Bu bildirimlerin sÃ¼resi dolmuÅŸtur.</div><div class="row" id="row-b-exp"></div></div>`;
            }
            
            html += '</ul>'; content += '</div>';
            container.innerHTML = html + content;
            
            for (const no of bNumbers) {
                window._renderTaskCardsToContainer(groups[no], `#row-b-${no}`, formatDate, taskType);
            }
            if(expired.length) window._renderTaskCardsToContainer(expired, '#row-b-exp', formatDate, taskType);
            $('#taskPagination').hide();
            return;
        }

        // C) Standart Liste GÃ¶rÃ¼nÃ¼mÃ¼
        if (filteredTasks.length === 0) {
            container.innerHTML = '<div class="text-center text-muted p-4">Aranan kriterlere uygun kayÄ±t bulunamadÄ±.</div>';
            $('#taskPagination').hide();
            return;
        }

        $('#taskPagination').show();
        
        if (!window.taskPaginationData.pagination && window.Pagination) {
            window.taskPaginationData.pagination = new window.Pagination({
                itemsPerPage: 10,
                containerId: 'taskPagination',
                onPageChange: (page, perPage) => {
                    const start = (page - 1) * perPage;
                    const slice = window.taskPaginationData.allData.slice(start, start + perPage);
                    window._renderTaskCardsToContainer(slice, '#task-list-container', formatDate, taskType);
                }
            });
        }
        
        if (window.taskPaginationData.pagination) {
            window.taskPaginationData.pagination.update(filteredTasks.length);
        }
        window._renderTaskCardsToContainer(filteredTasks.slice(0,10), '#task-list-container', formatDate, taskType);
    };


    window.loadGoodsFromIpRecord = async function(ipRecordId) {
        if (!ipRecordId) return '<p class="text-muted">ID yok.</p>';
        try {
            const ipDoc = await getDoc(doc(db, 'ipRecords', ipRecordId));
            if (!ipDoc.exists()) return '<p class="text-muted">KayÄ±t yok.</p>';
            const goodsByClass = ipDoc.data().goodsAndServicesByClass || [];
            if (goodsByClass.length === 0) return '<p class="text-muted">Veri yok.</p>';
            
            return goodsByClass.map(cls => 
                `<div class="mb-3">
                    <h6 class="text-primary">SÄ±nÄ±f ${cls.classNo||'-'}</h6>
                    <p style="font-size: 0.85rem;">${(cls.items&&Array.isArray(cls.items))?cls.items.join('; '):'Yok'}</p>
                </div>`
            ).join('');
        } catch (error) { return '<p class="text-danger">Hata.</p>'; }
    };

    window.loadGoodsFromMonitoringRecord = async function(bulletinKey, monitoredId, targetAppNo) {
        if (!bulletinKey || !monitoredId || !targetAppNo) return '<p class="text-muted">Eksik bilgi.</p>';
        try {
            const monSnap = await getDoc(doc(db, 'monitoringTrademarkRecords', bulletinKey, 'trademarks', monitoredId));
            if (!monSnap.exists()) return '<p class="text-muted">KayÄ±t yok.</p>';
            
            const monitoringRecord = monSnap.data();
            if (!Array.isArray(monitoringRecord.results)) return '<p class="text-muted">SonuÃ§ yok.</p>';
            
            const cleanTarget = String(targetAppNo).replace(/[^a-zA-Z0-9]/g, '');
            const competitor = monitoringRecord.results.find(r => String(r.applicationNo || '').replace(/[^a-zA-Z0-9]/g, '') === cleanTarget);
            
            if (!competitor || !competitor.objectID) return '<p class="text-muted">Rakip bulunamadÄ±.</p>';
            
            const bulletinSnap = await getDoc(doc(db, 'trademarkBulletinRecords', competitor.objectID));
            if (!bulletinSnap.exists()) return '<p class="text-muted">BÃ¼lten detayÄ± yok.</p>';
            
            const goods = bulletinSnap.data().goods;
            if (!goods || !Array.isArray(goods)) return '<p class="text-muted">Mal listesi yok.</p>';
            
            return goods.map(item => `<p style="font-size: 0.85rem; margin-bottom: 10px;">${item||'Yok'}</p>`).join('');
        } catch (error) { return '<p class="text-danger">Hata.</p>'; }
    };

// === 1. TABLO SIRALAMA FONKSÄ°YONU (Parent-Child Destekli) ===
    window.parseTurkishDate = function(dateStr) {
        if (!dateStr || dateStr === '-' || dateStr.trim() === '') return new Date(0);
        const parts = dateStr.trim().split('.');
        if (parts.length === 3) {
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1; 
            const year = parseInt(parts[2], 10);
            return new Date(year, month, day);
        }
        return new Date(dateStr);
    };
// === GLOBAL TABLE SORT (GÃœNCELLENDÄ°: Tarih AlgÄ±lama Ä°yileÅŸtirildi) ===
    window.sortTable = function(tableId, columnIndex, dataType = 'text') {
        const listId = tableId.replace('#', '');
        let dataObj = null;
        let renderFn = null;
        let getValueFn = null;

        // 1. Hangi Tablo?
        if (listId === 'marka-list') {
            dataObj = window.markaPaginationData;
            renderFn = (slice, start) => window.populatePortfolioTable('#marka-list', slice, start);
            getValueFn = (item) => {
                if (columnIndex === 1) return (item.origin || item.country || '').toLowerCase();
                if (columnIndex === 3) return (item.title || item.brandText || '').toLowerCase();
                if (columnIndex === 4) return (item.applicationNumber || '').toLowerCase();
                if (columnIndex === 5) return (item.registrationNumber || item.internationalRegNumber || '').toLowerCase();
                if (columnIndex === 6) return item.applicationDate; 
                if (columnIndex === 7) return item.renewalDate;     
                if (columnIndex === 8) return (item.status || '').toLowerCase();
                return '';
            };
        } else if (listId === 'dava-itiraz-list') {
            dataObj = window.davaItirazPaginationData;
            renderFn = (slice, start) => window.renderDavaItirazTable(slice, start);
            getValueFn = (item) => {
                if (columnIndex === 1) return (item.origin || '').toLowerCase();
                if (columnIndex === 3) return (item.title || '').toLowerCase();
                if (columnIndex === 4) return (item.transactionTypeName || '').toLowerCase();
                if (columnIndex === 6) return (item.applicantName || '').toLowerCase();
                if (columnIndex === 7) return item.bulletinDate; 
                if (columnIndex === 9) return item.epatsDate;    
                if (columnIndex === 10) return (item.statusText || '').toLowerCase();
                return '';
            };
        } else if (listId === 'dava-list') {
            dataObj = window.davaPaginationData;
            renderFn = (slice, start) => window.renderDavaTable(slice, start);
            getValueFn = (item) => {
                if (columnIndex === 1) return (item.caseNo || '').toLowerCase();
                if (columnIndex === 2) return (item.title || '').toLowerCase();
                if (columnIndex === 4) return (item.court || '').toLowerCase();
                if (columnIndex === 6) return item.openingDate; 
                if (columnIndex === 7) return (item.suitStatus || '').toLowerCase();
                return '';
            };
        } else if (listId === 'contracts') {
            dataObj = window.contractsPaginationData;
            renderFn = (slice, start) => window.renderContractsTable(slice, start);
            getValueFn = (item) => {
                if (columnIndex === 1) return (item.type || '').toLowerCase();
                if (columnIndex === 2) return (item.countryName || '').toLowerCase();
                if (columnIndex === 3) return item.validityDate; 
                return '';
            };
        } else if (listId === 'invoices') {
            dataObj = window.invoicesPaginationData;
            renderFn = (slice) => window.renderInvoicesTable(slice);
            
            getValueFn = (item) => {
                if (columnIndex === 0) return (item.invoiceNo || '').toLowerCase();
                if (columnIndex === 1) return (item.taskId || '').toLowerCase();
                if (columnIndex === 2) return (item.applicationNumber || '').toLowerCase();
                if (columnIndex === 3) return item.createdAt;
                if (columnIndex === 4) return (item.taskTitle || item.description || '').toLowerCase();
                
                // Helper: Obje iÃ§inden amount'u al veya direkt sayÄ±yÄ± al
                const getAmt = (val) => {
                    if (val && typeof val === 'object') return Number(val.amount) || 0;
                    return Number(val) || 0;
                };

                // TUTARLAR (DoÄŸru sÄ±ralama iÃ§in)
                if (columnIndex === 5) return getAmt(item.officialFee); 
                if (columnIndex === 6) return getAmt(item.serviceFee);  
                if (columnIndex === 7) return getAmt(item.totalAmount); 
                
                if (columnIndex === 8) return (item.status || '').toLowerCase();
                return '';
            };
        }

        if (!dataObj || !dataObj.allData || dataObj.allData.length === 0) return;

        // 2. SÄ±ralama YÃ¶nÃ¼
        const table = document.querySelector(`#${listId} table`) || document.querySelector(`#${listId} .table`);
        if(!table) return;
        const th = table.querySelectorAll('thead th')[columnIndex];
        const isAsc = !th.classList.contains('sort-asc');

        table.querySelectorAll('thead th').forEach(h => {
            h.classList.remove('sort-asc', 'sort-desc');
            const icon = h.querySelector('i');
            if(icon) icon.className = 'fas fa-sort';
        });
        th.classList.add(isAsc ? 'sort-asc' : 'sort-desc');
        const activeIcon = th.querySelector('i');
        if(activeIcon) activeIcon.className = isAsc ? 'fas fa-sort-up' : 'fas fa-sort-down';

        // 3. DeÄŸer DÃ¶nÃ¼ÅŸtÃ¼rme (Helper)
        const normalize = (val) => {
            if (val === null || val === undefined) return (dataType === 'amount' || dataType === 'number') ? 0 : '';
            
            // Tarih Ä°ÅŸleme (GeliÅŸtirilmiÅŸ)
            if (dataType === 'date') {
                // 1. Firebase Timestamp
                if (val.toDate && typeof val.toDate === 'function') return val.toDate().getTime();
                // 2. JS Date Objesi
                if (val instanceof Date) return val.getTime();
                // 3. String Tarih
                if (typeof val === 'string') {
                    // "15.05.2023" formatÄ±
                    if (val.includes('.')) return window.parseTurkishDate(val).getTime();
                    // ISO formatÄ± "2023-05-15..."
                    const parsed = Date.parse(val);
                    if (!isNaN(parsed)) return parsed;
                }
                return 0;
            }
            return val;
        };

        // 4. SÄ±ralama (TÃ¼m Veri Ãœzerinde)
        dataObj.allData.sort((a, b) => {
            let valA = normalize(getValueFn(a));
            let valB = normalize(getValueFn(b));

            if (valA < valB) return isAsc ? -1 : 1;
            if (valA > valB) return isAsc ? 1 : -1;
            return 0;
        });

        // 5. SayfayÄ± BaÅŸa Al ve Yeniden Ã‡iz
        if (dataObj.pagination) {
            dataObj.pagination.currentPage = 1;
            const perPage = dataObj.pagination.itemsPerPage || 10;
            const slice = dataObj.allData.slice(0, perPage);
            if (listId === 'invoices') renderFn(slice);
            else renderFn(slice, 0);
        } else {
            if (listId === 'invoices') renderFn(dataObj.allData);
            else renderFn(dataObj.allData, 0);
        }
    };
    
    // === 2. MASTER FÄ°LTRELEME FONKSÄ°YONLARI ===
    window.activeColumnFilters = {}; 

window.applyMasterFilter = function() {
    // 1. Hangi Tablo Aktif?
    const activeTabLink = $('#portfolioTopTabs a.nav-link.active');
    const activeTabId = activeTabLink.attr('href');
    
    let targetDataObj = null;
    let renderFunction = null;
    let tableId = '';

    if (activeTabId === '#marka-list') {
        targetDataObj = window.markaPaginationData;
        renderFunction = window.populatePortfolioTable;
        tableId = 'marka-list';
    } else if (activeTabId === '#dava-itiraz-list') {
        targetDataObj = window.davaItirazPaginationData;
        renderFunction = window.renderDavaItirazTable;
        tableId = 'dava-itiraz-list';
    } else if (activeTabId === '#dava-list') {
        targetDataObj = window.davaPaginationData;
        renderFunction = window.renderDavaTable;
        tableId = 'dava-list';
    } else {
        return;
    }

    if (!targetDataObj || !targetDataObj.allDataUnfiltered) return;

    // Filtre DeÄŸerlerini Al
    const menseVal = $("#menseFilter").val() || 'TÃœRKPATENT';
    const searchVal = $("#portfolioSearchText").val().toLowerCase().trim();
    const statusVal = $("#portfolioDurumFilter").val();
    const selectedClient = window.selectedClientId; // Global MÃ¼ÅŸteri SeÃ§imi
    
    console.log('ðŸ” applyMasterFilter Ã§alÄ±ÅŸÄ±yor');
    console.log('ðŸ” Aktif sekme:', tableId);
    console.log('ðŸ” selectedClient:', selectedClient);
    console.log('ðŸ” allDataUnfiltered:', targetDataObj?.allDataUnfiltered?.length);
    
    const allData = targetDataObj.allDataUnfiltered;

    // 2. FÄ°LTRELEME MANTIÄžI
    let filteredData = allData.filter(item => {
        // DEBUG
        const itemDebug = tableId === 'dava-itiraz-list' && item.id === '221';
        if (itemDebug) console.log('ðŸ” 221 filtreleme baÅŸlangÄ±cÄ±');
        
        // A) Child KayÄ±tlarÄ± Gizle (Sadece Parentlar)
        if (item.transactionHierarchy === 'child' || item.isChild) {
            if (itemDebug) console.log('âŒ 221 child olduÄŸu iÃ§in elendi');
            return false;
        }

        // B) MÃœÅžTERÄ° SEÃ‡Ä°MÄ° KONTROLÃœ (YENÄ°)
        if (selectedClient && selectedClient !== 'ALL') {
            let hasAccess = false;
            
            // Marka/Patent (applicants dizisi kontrolÃ¼)
            if (item.applicants && Array.isArray(item.applicants)) {
                if (item.applicants.some(app => app.id === selectedClient)) hasAccess = true;
            }
            // Dava (client objesi kontrolÃ¼)
            else if (item.client && item.client.id === selectedClient) {
                hasAccess = true;
            }
            // Ä°tiraz (applicants kontrolÃ¼ - genelde IP record Ã¼zerinden gelir)
            else if (item.applicants && Array.isArray(item.applicants)) {
                 if (item.applicants.some(app => app.id === selectedClient)) hasAccess = true;
            }
            
            if (!hasAccess) return false;
        }
if (itemDebug) console.log('âœ… 221 mÃ¼ÅŸteri kontrolÃ¼nÃ¼ geÃ§ti');
        // C) MenÅŸe KontrolÃ¼
        if (item.origin) {
            const origin = (item.origin || 'TÃœRKPATENT').toString().toUpperCase();
            const isTurk = origin.includes('TURK') || origin.includes('TÃœRK');
            if (menseVal === 'TÃœRKPATENT' && !isTurk) return false;
            if (menseVal === 'YURTDISI' && isTurk) return false;
        }
if (itemDebug) console.log('âœ… 221 menÅŸe kontrolÃ¼nÃ¼ geÃ§ti');
        // D) Metin Arama
        if (searchVal) {
            let searchableText = Object.values(item).map(v => 
                (v && typeof v === 'object') ? '' : String(v).toLowerCase()
            ).join(' ');

            if(item.caseNo) searchableText += ' ' + item.caseNo.toLowerCase();
            if(item.opposingParty) searchableText += ' ' + item.opposingParty.toLowerCase();
            
            // Child kayÄ±tlarÄ± da aramaya dahil et (Marka listesi iÃ§in)
            if (tableId === 'marka-list') {
                const children = allData.filter(c => c.parentId === item.id);
                children.forEach(child => {
                    searchableText += ' ' + Object.values(child).map(v => 
                        (v && typeof v === 'object') ? '' : String(v).toLowerCase()
                    ).join(' ');
                    if (child.country || child.countryCode) {
                        const code = (child.country || child.countryCode).toUpperCase();
                        const countryName = window.countryMap.get(code);
                        if (countryName) searchableText += ' ' + countryName.toLowerCase();
                    }
                });
            }

            if (!searchableText.includes(searchVal)) return false;
        }
if (itemDebug) console.log('âœ… 221 metin aramasÄ±nÄ± geÃ§ti');
        // E) Durum Filtresi
        if (statusVal && statusVal !== 'TÃœMÃœ') {
            const st = item.status || item.statusText || item.suitStatus || '';
            if (!st.toLowerCase().includes(statusVal.toLowerCase())) return false;
        }
if (itemDebug) console.log('âœ… 221 durum filtresini geÃ§ti');
        // F) Kolon BazlÄ± Filtreler
        for (const [key, selectedValues] of Object.entries(window.activeColumnFilters)) {
            if (!key.startsWith(tableId + '-')) continue;
            const colIdx = key.split('-').pop();
            let cellValue = '';

            if (tableId === 'marka-list') {
                const isTurk = (item.origin||'').toUpperCase().includes('TURK');
                if (colIdx == '1') cellValue = isTurk ? 'TÃœRKPATENT' : (item.country || 'YurtdÄ±ÅŸÄ±');
                if (colIdx == '3') cellValue = item.title || item.brandText || '';
                if (colIdx == '7') cellValue = item.status || '';
            } else if (tableId === 'dava-itiraz-list') {
                if (colIdx == 3) cellValue = item.title || '';
                if (colIdx == 4) cellValue = item.transactionTypeName || '';
                if (colIdx == 6) cellValue = item.applicantName || '';
                if (colIdx == 10) cellValue = item.statusText || '';
            } else if (tableId === 'dava-list') {
                if (colIdx == 1) cellValue = item.caseNo || '';
                if (colIdx == 2) cellValue = item.title || '';
                if (colIdx == 4) cellValue = item.court || '';
                if (colIdx == 5) cellValue = item.opposingParty || '';
                if (colIdx == 7) cellValue = item.suitStatus || '';
            }

            if (!selectedValues.includes(cellValue.trim())) return false;
        }
if (itemDebug) console.log('âœ… 221 kolon filtresini geÃ§ti');
    // DEBUG: KayÄ±t filtreyi geÃ§ti
        if (tableId === 'dava-itiraz-list') {
            console.log('âœ… KayÄ±t geÃ§ti:', item.id);
        }
        return true;
    });
    
    // DEBUG: Hangi kayÄ±tlar elendi?
    if (tableId === 'dava-itiraz-list' && filteredData.length === 0) {
        console.log('âŒ HÄ°Ã‡BÄ°R KAYIT GEÃ‡MEDÄ°!');
        console.log('Ä°lk kayÄ±t detayÄ±:', allData[0]);
    }
    
    console.log('ðŸ” Filtreleme Ã¶ncesi:', allData.length);
    console.log('ðŸ” Filtreleme sonrasÄ±:', filteredData.length);
    if (filteredData.length === 0 && allData.length > 0) {
        console.log('âš ï¸ TÃœM KAYITLAR FÄ°LTRELENDÄ°!');
        console.log('âš ï¸ Ä°lk kayÄ±t Ã¶rneÄŸi:', allData[0]);
        console.log('âš ï¸ KayÄ±tta applicants var mÄ±?', allData[0].applicants);
        if (allData[0].applicants && allData[0].applicants.length > 0) {
            console.log('âš ï¸ Ä°lk applicant ID:', allData[0].applicants[0].id);
            console.log('âš ï¸ Aranan selectedClient:', selectedClient);
            console.log('âš ï¸ EÅŸleÅŸiyor mu?', allData[0].applicants[0].id === selectedClient);
        }
    }

    // 3. Render ve Sayfalama
    targetDataObj.allData = filteredData;
    
    let paginationContainerId = '';
    if (tableId === 'marka-list') paginationContainerId = 'markaPagination';
    else if (tableId === 'dava-itiraz-list') paginationContainerId = 'davaItirazPagination';
    else if (tableId === 'dava-list') paginationContainerId = 'davaPagination';

    if (!targetDataObj.pagination && window.Pagination && paginationContainerId) {
        targetDataObj.pagination = new window.Pagination({
            itemsPerPage: 10,
            containerId: paginationContainerId,
            onPageChange: (page, perPage) => {
                const start = (page - 1) * perPage;
                const slice = targetDataObj.allData.slice(start, start + perPage);
                renderFunction(`#${tableId}`, slice, start); 
            }
        });
    }

    if (targetDataObj.pagination) {
        targetDataObj.pagination.update(filteredData.length);
        targetDataObj.pagination.currentPage = 1; 
        const slice = filteredData.slice(0, 10);
        if(tableId === 'dava-itiraz-list' || tableId === 'dava-list') {
             renderFunction(slice, 0);
        } else {
             renderFunction(`#${tableId}`, slice, 0);
        }
    }

    if (tableId !== 'dava-list') {
        if (menseVal === 'TÃœRKPATENT') $(`#${tableId} th.col-origin, #${tableId} td.col-origin`).hide();
        else $(`#${tableId} th.col-origin, #${tableId} td.col-origin`).show();
    }
};

window.toggleColumnFilter = function(icon, tableId, colIdx) {
        const existing = $(icon).next('.column-filter-dropdown');
        if (existing.length) { existing.remove(); return; }
        $('.column-filter-dropdown').remove();

        // Hangi veriden Ã§ekeceÄŸiz?
        let sourceData = [];
        if(tableId === 'marka-list') sourceData = window.markaPaginationData.allDataUnfiltered || [];
        else if(tableId === 'dava-itiraz-list') sourceData = window.davaItirazPaginationData.allDataUnfiltered || [];
        else if(tableId === 'dava-list') sourceData = window.davaPaginationData.allDataUnfiltered || [];

        const uniqueValues = new Set();

        sourceData.forEach(item => {
            if (item.transactionHierarchy === 'child' || item.isChild) return;
            
            let val = '';
            // Tabloya gÃ¶re map
            if (tableId === 'marka-list') {
                if (colIdx == 1) { const o = (item.origin||'').toUpperCase(); val = o.includes('TURK') ? 'TÃœRKPATENT' : (item.country||'YurtdÄ±ÅŸÄ±'); }
                else if (colIdx == 3) val = item.title || item.brandText || '';
                else if (colIdx == 7) val = item.status || '';
            }
            else if (tableId === 'dava-itiraz-list') {
                if (colIdx == 3) val = item.title || '';
                if (colIdx == 4) val = item.transactionTypeName || '';
                if (colIdx == 6) val = item.applicantName || '';
                if (colIdx == 10) val = item.statusText || '';
            }
            else if (tableId === 'dava-list') {
                if (colIdx == 1) val = item.caseNo || '';
                if (colIdx == 2) val = item.title || '';
                if (colIdx == 4) val = item.court || '';
                if (colIdx == 5) val = item.opposingParty || '';
                if (colIdx == 7) val = item.suitStatus || '';
            }

            if (val) uniqueValues.add(val.trim());
        });

        const sorted = Array.from(uniqueValues).sort((a, b) => a.localeCompare(b, 'tr'));
        const filterKey = `${tableId}-${colIdx}`; // Unique key for storage

        const optionsHtml = sorted.map(val => {
            const isChecked = (window.activeColumnFilters[filterKey] || []).includes(val) ? 'checked' : '';
            return `<label class="filter-option" style="display:block; cursor:pointer;"><input type="checkbox" value="${val}" ${isChecked}> ${val}</label>`;
        }).join('');

        const html = `
            <div class="column-filter-dropdown" onclick="event.stopPropagation()" style="min-width:220px;">
                <input type="text" class="filter-search-input" placeholder="Ara..." onkeyup="window.filterDropdownList(this)">
                <div class="filter-options-container">${optionsHtml}</div>
                <div class="filter-actions">
                    <button class="btn btn-xs btn-light" onclick="window.clearColFilter('${tableId}', ${colIdx}, this)">Temizle</button>
                    <button class="btn btn-xs btn-primary" onclick="window.applyColFilter('${tableId}', ${colIdx}, this)">Uygula</button>
                </div>
            </div>`;

        $(icon).parent().append(html);
        $(icon).next('.column-filter-dropdown').fadeIn(200);
        setTimeout(()=>$(icon).next().find('input[type="text"]').focus(), 100);
    };

    // --- YENÄ° YARDIMCI FONKSÄ°YON: LÄ°STE Ä°Ã‡Ä°NDE ARAMA ---
    window.filterDropdownList = function(input) {
        const txt = input.value.toLowerCase();
        $(input).next('.filter-options-container').find('label').each(function() {
            const t = $(this).text().toLowerCase();
            t.includes(txt) ? $(this).show() : $(this).hide();
        });
    }; 


    window.applyColFilter = function(tableId, colIdx, btn) {
        const container = $(btn).closest('.column-filter-dropdown');
        const selected = [];
        container.find('input:checked').each(function() { selected.push($(this).val()); });
        
        const filterKey = `${tableId}-${colIdx}`;
        if (selected.length > 0) {
            window.activeColumnFilters[filterKey] = selected;
            // Ä°lgili tablodaki ikonu boya
            $(`#${tableId} th[data-col-idx="${colIdx}"] .filter-icon`).addClass('active').css('color', '#007bff');
        } else {
            delete window.activeColumnFilters[filterKey];
            $(`#${tableId} th[data-col-idx="${colIdx}"] .filter-icon`).removeClass('active').css('color', '');
        }
        container.remove();
        window.applyMasterFilter();
    };

    window.clearColFilter = function(tableId, colIdx, btn) {
        const filterKey = `${tableId}-${colIdx}`;
        delete window.activeColumnFilters[filterKey];
        $(`#${tableId} th[data-col-idx="${colIdx}"] .filter-icon`).removeClass('active').css('color', '');
        $(btn).closest('.column-filter-dropdown').remove();
        window.applyMasterFilter();
    };

    // === YARDIMCI: GÃ¶rseli Base64 FormatÄ±na Ã‡evir (Hata KorumalÄ±) ===
window.imageUrlToBase64 = async function(url) {
    if (!url || url.length < 10) return null;
    try {
        // 'Anonymous' modu CORS iÃ§in Ã¶nemlidir
        const response = await fetch(url, { mode: 'cors', credentials: 'omit' });
        if (!response.ok) throw new Error('Resim indirilemedi');
        
        const blob = await response.blob();
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.onerror = () => resolve(null); // Hata olursa null dÃ¶n, patlama
            reader.readAsDataURL(blob);
        });
    } catch (e) {
        console.warn("GÃ¶rsel yÃ¼klenemedi (CORS veya Network hatasÄ±):", url);
        // Hata durumunda null dÃ¶nÃ¼yoruz ki export iÅŸlemi devam etsin
        return null;
    }
};

// === GELÄ°ÅžMÄ°Åž EXPORT YÃ–NETÄ°CÄ°SÄ° (V4 - Fallback Link Destekli) ===
window.exportActiveTable = async function(type) {
    const activeTabId = $('#portfolioTopTabs a.nav-link.active').attr('href');
    let dataToExport = [];
    let fileName = 'Portfoy_Listesi';
    let headers = [];

    const translateStatus = (status) => {
        const map = {
            'filed': 'BaÅŸvuru', 'registered': 'Tescilli', 'pending': 'Bekliyor',
            'published': 'YayÄ±nlandÄ±', 'refused': 'Reddedildi', 'expired': 'SÃ¼resi Doldu',
            'active': 'Aktif', 'inactive': 'Pasif'
        };
        return map[String(status).toLowerCase()] || status || '-';
    };

    if (activeTabId === '#marka-list') {
        fileName = 'Marka_Portfoy_Raporu';
        const rawData = window.markaPaginationData?.allData || [];
        
        const btnIcon = type === 'excel' ? '.fa-file-excel' : '.fa-file-pdf';
        const originalBtnHtml = $(btnIcon).parent().html();
        $(btnIcon).parent().html('<i class="fas fa-spinner fa-spin"></i>').prop('disabled', true);

        try {
            for (const item of rawData) {
                let base64Image = null;
                // GÃ¶rsel URL'si varsa indirmeyi dene
                const imgUrl = item.brandImageUrl || item.brandImage;
                if (imgUrl) {
                    base64Image = await window.imageUrlToBase64(imgUrl);
                }

                const originRaw = (item.origin || 'TÃœRKPATENT').toString().toUpperCase();
                const originDisplay = (originRaw.includes('TURK')) ? 'TÃœRKPATENT' : (item.country || item.origin || 'YurtdÄ±ÅŸÄ±');
                
                dataToExport.push({
                    type: 'parent',
                    mense: originDisplay,
                    base64Image: base64Image,
                    originalImageUrl: imgUrl, // Linki saklÄ±yoruz (Fallback iÃ§in)
                    markaAdi: item.title || item.brandText || '-',
                    basvuruNo: item.applicationNumber || '-',
                    tescilNo: item.internationalRegNumber || item.wipoIrNumber || item.registrationNumber || '-',
                    basvuruTarihi: window.formatDateTR(item.applicationDate),
                    yenilemeTarihi: window.formatDateTR(item.renewalDate),
                    durum: translateStatus(item.status || item.statusText),
                    siniflar: (Array.isArray(item.goodsAndServicesByClass) ? item.goodsAndServicesByClass.map(c=>c.classNo).join(', ') : item.classes) || '-'
                });

                const children = window.markaPaginationData.allDataUnfiltered.filter(p => p.parentId === item.id);
                if (children.length > 0) {
                    for (let idx = 0; idx < children.length; idx++) {
                        const child = children[idx];
                        const code = (child.country || child.countryCode || '').trim().toUpperCase();
                        const name = window.countryMap.get(code) || child.countryName || '';
                        let childOrigin = code;
                        if (name && code) childOrigin = `${name} (${code})`;
                        else if (name) childOrigin = name;

                        dataToExport.push({
                            type: 'child',
                            mense: childOrigin,
                            base64Image: null,
                            originalImageUrl: null,
                            markaAdi: `   â†³ ${idx+1}. ${item.title || ''}`,
                            basvuruNo: child.applicationNumber || '-',
                            tescilNo: '-',
                            basvuruTarihi: window.formatDateTR(child.applicationDate),
                            yenilemeTarihi: window.formatDateTR(child.renewalDate),
                            durum: translateStatus(child.status),
                            siniflar: (Array.isArray(child.goodsAndServicesByClass) ? child.goodsAndServicesByClass.map(c=>c.classNo).join(', ') : child.classes) || '-'
                        });
                    }
                }
            }
        } catch (e) {
            console.error("Export HatasÄ±:", e);
            alert('Veri hazÄ±rlanÄ±rken hata oluÅŸtu, ancak iÅŸlem devam ediyor.');
        }

        headers = [
            { key: 'mense', title: 'MenÅŸe', width: 15 },
            { key: 'base64Image', title: 'GÃ¶rsel', width: 15 },
            { key: 'markaAdi', title: 'Marka AdÄ±', width: 30 },
            { key: 'basvuruNo', title: 'BaÅŸvuru No', width: 20 },
            { key: 'tescilNo', title: 'Tescil / WIPO No', width: 20 },
            { key: 'basvuruTarihi', title: 'BaÅŸvuru T.', width: 15 },
            { key: 'yenilemeTarihi', title: 'Yenileme T.', width: 15 },
            { key: 'durum', title: 'Durum', width: 15 },
            { key: 'siniflar', title: 'SÄ±nÄ±flar', width: 15 }
        ];

        const today = new Date().toISOString().slice(0,10);
        const finalFileName = `${fileName}_${today}`;

        if (type === 'excel') {
            await window.generateExcelWithImages(dataToExport, headers, finalFileName);
        } else if (type === 'pdf') {
            await window.generatePDF(dataToExport, headers, finalFileName);
        }
        
        $(btnIcon).parent().html(originalBtnHtml).prop('disabled', false);

    } else {
        alert('Bu Ã¶zellik ÅŸimdilik sadece Marka sekmesi iÃ§in aktiftir.');
    }
};

// === EXCEL OLUÅžTURUCU (Link Fallback Destekli) ===
window.generateExcelWithImages = async function(data, headers, filename) {
    const workbook = new ExcelJS.Workbook();
    const sheet = workbook.addWorksheet('Marka Listesi');

    sheet.columns = headers.map(h => ({ header: h.title, key: h.key, width: h.width }));

    data.forEach(item => {
        const rowData = { ...item, base64Image: '' }; 
        const row = sheet.addRow(rowData);
        
        if (item.type === 'child') {
            row.eachCell((cell) => {
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF5F5F5' } };
                cell.font = { italic: true, color: { argb: 'FF555555' } };
            });
        } else {
            // --- DEÄžÄ°ÅžÄ°KLÄ°K BURADA: SatÄ±r yÃ¼ksekliÄŸi artÄ±rÄ±ldÄ± ---
            row.height = 90; // 60 yerine 90 yapÄ±ldÄ± (Resimler kareye yaklaÅŸsÄ±n diye)
            
            row.eachCell((cell) => { cell.alignment = { vertical: 'middle', wrapText: true }; });
        }

        // Link Fallback
        if (!item.base64Image && item.originalImageUrl && item.type === 'parent') {
            const cell = row.getCell(2); 
            cell.value = {
                text: 'GÃ¶rsel Linki',
                hyperlink: item.originalImageUrl,
                tooltip: 'GÃ¶rsele gitmek iÃ§in tÄ±klayÄ±n'
            };
            cell.font = { color: { argb: 'FF0000FF' }, underline: true };
        }
    });

    // GÃ¶rselleri HÃ¼crelere GÃ¶m
    for (let i = 0; i < data.length; i++) {
        const item = data[i];
        if (item.base64Image) {
            const imageId = workbook.addImage({
                base64: item.base64Image,
                extension: 'png',
            });
            
            // Resmi hÃ¼creye tam sÄ±ÄŸdÄ±r (editAs: 'oneCell')
            sheet.addImage(imageId, {
                tl: { col: 1, row: i + 1 },
                br: { col: 2, row: i + 2 },
                editAs: 'oneCell'
            });
        }
    }

    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
    const link = document.createElement('a');
    link.href = window.URL.createObjectURL(blob);
    link.download = `${filename}.xlsx`;
    link.click();
};

// === PDF OLUÅžTURUCU (V4 - Hata DÃ¼zeltildi ve Girinti AyarlandÄ±) ===
window.generatePDF = async function(data, headers, filename) {
    const { jsPDF } = window.jspdf;
    
    // A4 Yatay (Landscape)
    const doc = new jsPDF('l', 'mm', 'a4');

    // --- 1. BaÅŸlÄ±k ve Bilgiler ---
    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.setTextColor(41, 128, 185); // Mavi
    doc.text("Marka PortfÃ¶y Raporu", 14, 15);
    
    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    doc.setTextColor(100);
    doc.text(`OluÅŸturulma Tarihi: ${new Date().toLocaleDateString('tr-TR')}`, 14, 22);
    
    doc.text("IP YÃ¶netim Sistemi", 280, 15, { align: 'right' });

    // --- 2. Veri HazÄ±rlÄ±ÄŸÄ± ---
    const head = [headers.map(h => h.title)];
    const body = data.map(row => {
        const rowArray = headers.map(h => row[h.key]);
        rowArray.raw = row; // Stil kontrolÃ¼ iÃ§in ham veriyi sakla
        return rowArray;
    });

    // --- 3. Tablo Ã‡izimi ---
    doc.autoTable({
        head: head,
        body: body,
        startY: 28,
        theme: 'grid',
        
        // Genel Stiller
        styles: { 
            font: "helvetica",
            fontSize: 8, 
            valign: 'middle',
            cellPadding: 3, // VarsayÄ±lan padding
            overflow: 'linebreak',
            lineWidth: 0.1,
            lineColor: [200, 200, 200]
        },

        // BaÅŸlÄ±k Stili
        headStyles: { 
            fillColor: [41, 128, 185],
            textColor: 255,
            fontStyle: 'bold',
            halign: 'center',
            valign: 'middle',
            minCellHeight: 10
        },

        // SÃ¼tun GeniÅŸlikleri
        columnStyles: {
            0: { cellWidth: 25 }, // MenÅŸe
            1: { cellWidth: 22, minCellHeight: 22 }, // GÃ¶rsel
            2: { cellWidth: 45 }, // Marka AdÄ±
            3: { cellWidth: 25 }, // BaÅŸvuru No
            4: { cellWidth: 25 }, // Tescil No
            5: { cellWidth: 22, halign: 'center' }, // BaÅŸvuru T.
            6: { cellWidth: 22, halign: 'center' }, // Yenileme T.
            7: { cellWidth: 25, halign: 'center' }, // Durum
            8: { cellWidth: 'auto' } // SÄ±nÄ±flar
        },

        // --- HÃœCRE AYRIÅžTIRMA (Stil ve Girinti) ---
        didParseCell: function(data) {
            const rowData = data.row.raw;
            
            // Sadece Body bÃ¶lÃ¼mÃ¼ iÃ§in iÅŸlem yap
            if (data.section === 'body' && rowData && rowData.raw) {
                
                // CHILD (ALT) KAYITLAR
                if (rowData.raw.type === 'child') {
                    // Arka plan rengi (Gri)
                    data.cell.styles.fillColor = [248, 249, 250]; 
                    data.cell.styles.textColor = [80, 80, 80];
                    
                    // Marka AdÄ± kolonunda (index 2) girinti
                    if (data.column.index === 2) {
                         data.cell.styles.fontStyle = 'italic';
                         
                         // --- HATA DÃœZELTÄ°LDÄ° ---
                         // data.cell.padding yerine data.cell.styles.cellPadding kullanÄ±ldÄ±
                         data.cell.styles.cellPadding = { top: 3, bottom: 3, left: 10, right: 3 };
                    }
                } 
                // PARENT (ANA) KAYITLAR
                else {
                    // Marka adÄ±nÄ± kalÄ±n yap
                    if (data.column.index === 2) {
                        data.cell.styles.fontStyle = 'bold';
                    }
                }
            }
        },

        // --- GÃ–RSEL Ã‡Ä°ZDÄ°RME ---
        didDrawCell: function(data) {
            // Sadece GÃ¶rsel Kolonu (Index 1) ve Body bÃ¶lÃ¼mÃ¼
            if (data.section === 'body' && data.column.index === 1) {
                const rawItem = data.row.raw.raw;
                
                if (rawItem && rawItem.base64Image) {
                    try {
                        const imgData = rawItem.base64Image;
                        const cellWidth = data.cell.width;
                        const cellHeight = data.cell.height;
                        const padding = 2;
                        const dim = Math.min(cellWidth, cellHeight) - (padding * 2);
                        
                        // Ortala
                        const x = data.cell.x + (cellWidth - dim) / 2;
                        const y = data.cell.y + (cellHeight - dim) / 2;

                        doc.addImage(imgData, 'PNG', x, y, dim, dim);
                    } catch (err) {
                        // Hata olursa gÃ¶rseli atla
                    }
                }
            }
        }
    });

    // Sayfa NumaralarÄ±
    const pageCount = doc.internal.getNumberOfPages();
    doc.setFontSize(8);
    for(let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.text('Sayfa ' + i + ' / ' + pageCount, 285, 200, { align: 'right' });
    }

    doc.save(`${filename}.pdf`);
};

// 1. Ä°simleri Ã‡ek
    window.fetchClientNames = async function(ids) {
        window.linkedClientsMap = [];
        try {
            // Firestore 'in' sorgusu 10 ile sÄ±nÄ±rlÄ±dÄ±r, batch yapalÄ±m
            const chunks = [];
            for (let i = 0; i < ids.length; i += 10) {
                const chunk = ids.slice(i, i + 10);
                const q = query(collection(db, 'persons'), where('__name__', 'in', chunk));
                chunks.push(getDocs(q));
            }
            
            const snapshots = await Promise.all(chunks);
            snapshots.forEach(snap => {
                snap.forEach(d => {
                    window.linkedClientsMap.push({
                        id: d.id,
                        name: d.data().name || 'Ä°simsiz MÃ¼ÅŸteri'
                    });
                });
            });
            
            // Ä°sme gÃ¶re sÄ±rala
            window.linkedClientsMap.sort((a,b) => a.name.localeCompare(b.name));
            
        } catch (e) {
            console.error("MÃ¼ÅŸteri isimleri Ã§ekilemedi:", e);
            // Hata olursa ID'leri isim gibi kullan (Fallback)
            window.linkedClientsMap = ids.map(id => ({id: id, name: `MÃ¼ÅŸteri (${id})`}));
        }
    };

    // 2. UI OluÅŸtur ve YÃ¶net
    window.renderClientSelectorUI = function() {
        const clients = window.linkedClientsMap;
        if (clients.length <= 1) return; // Tek mÃ¼ÅŸteri varsa seÃ§iciye gerek yok

        // Dropdown Doldur
        const dropdownMenu = $('#clientDropdownMenu');
        dropdownMenu.empty();
        
        // "TÃ¼mÃ¼" seÃ§eneÄŸi
        dropdownMenu.append(`<a class="dropdown-item" href="#" onclick="window.switchClient('ALL')"><strong>TÃ¼mÃ¼</strong></a>`);
        dropdownMenu.append('<div class="dropdown-divider"></div>');
        
        // MÃ¼ÅŸteriler
        clients.forEach(c => {
            dropdownMenu.append(`<a class="dropdown-item" href="#" onclick="window.switchClient('${c.id}')">${c.name}</a>`);
        });
        
        $('#clientSelectorContainer').show();

        // Modal Doldur (Ä°lk aÃ§Ä±lÄ±ÅŸta sormak isterseniz)
        // EÄŸer kullanÄ±cÄ± daha Ã¶nce seÃ§mediyse modalÄ± gÃ¶ster
        if (!sessionStorage.getItem('selectedClientSession')) {
            const modalList = $('#clientSelectionList');
            modalList.empty();
            
            modalList.append(`<button type="button" class="list-group-item list-group-item-action font-weight-bold" onclick="window.switchClient('ALL', true)">TÃ¼m MÃ¼ÅŸterileri GÃ¶ster</button>`);
            
            clients.forEach(c => {
                modalList.append(`<button type="button" class="list-group-item list-group-item-action" onclick="window.switchClient('${c.id}', true)">${c.name}</button>`);
            });
            
            $('#clientSelectionModal').modal('show');
        } else {
            // Oturumda varsa onu yÃ¼kle
            window.switchClient(sessionStorage.getItem('selectedClientSession'));
        }
    };

    // 3. MÃ¼ÅŸteri DeÄŸiÅŸtirme MantÄ±ÄŸÄ±
    window.switchClient = function(clientId, fromModal = false) {
        // 1. Ä°ÅŸlem baÅŸlar baÅŸlamaz yÃ¼kleme ekranÄ±nÄ± gÃ¶ster
        if (window.SimpleLoadingController) {
            window.SimpleLoadingController.show('MÃ¼vekkil Verileri YÃ¼kleniyor', 'PortfÃ¶y ve analizler hazÄ±rlanÄ±yor...');
        }

        if (fromModal) {
            $('#clientSelectionModal').modal('hide');
        }

        // 2. setTimeout: TarayÄ±cÄ±ya animasyonu ekrana Ã§izmesi iÃ§in 50 milisaniye nefes aldÄ±rÄ±yoruz!
        // Bu olmazsa JS doÄŸrudan filtrelemeye girer ve loading animasyonu ekrana gelemeden sayfa donar.
        setTimeout(() => {
            window.selectedClientId = clientId;
            sessionStorage.setItem('selectedClientSession', clientId);
            
            // UI GÃ¼ncelle
            let nameText = 'TÃ¼m MÃ¼ÅŸteriler';
            if (clientId !== 'ALL') {
                const client = window.linkedClientsMap.find(c => c.id === clientId);
                if (client) nameText = client.name;
            }
            $('#currentClientName').text(nameText);

            // --- VERÄ°LERÄ° FÄ°LTRELE VE YENÄ°LE ---
            console.log("MÃ¼ÅŸteri deÄŸiÅŸtirildi:", clientId);
            
            window.applyMasterFilter(); // PortfÃ¶y
            window.applyTaskFilter();   // Ä°ÅŸlerim
            window.applyInvoiceFilter(); // Faturalar
            if (typeof window.applyContractsFilter === 'function') {
                window.applyContractsFilter(); // Vekaletler
            }
            
            // ðŸ”¥ Dashboard SayaÃ§larÄ±nÄ± Yeniden Hesapla
            window.updateDashboardCounts();

            if ($('#portfolioTopTabs a.nav-link.active').attr('href') === '#dava-list') {
                 window.applyMasterFilter(); 
            }

            // 3. Ä°ÅŸlem bitince yÃ¼kleme ekranÄ±nÄ± kapat
            if (window.SimpleLoadingController) {
                window.SimpleLoadingController.hide();
            }
        }, 50); // 50ms bekleme
    };

// === RAPORLAR MODÃœLÃœ (TAM VE NÄ°HAÄ° VERSÄ°YON) ===
window.initReports = function() {
    console.log("Raporlar ve Analizler HazÄ±rlanÄ±yor...");

    // --- 1. VERÄ° KAYNAKLARINI TOPLA ---
    let portfolioData = window.markaPaginationData?.allDataUnfiltered || [];
    let legalData = (window.davaItirazPaginationData?.allDataUnfiltered || [])
                      .concat(window.davaPaginationData?.allDataUnfiltered || []);
    let taskData = window.taskPaginationData?.allDataUnfiltered || [];

    // --- 2. VERÄ°LERÄ° SEÃ‡Ä°LÄ° MÃœÅžTERÄ°YE GÃ–RE FÄ°LTRELE (YENÄ°) ---
    const selectedClient = window.selectedClientId; // Global seÃ§im

    if (selectedClient && selectedClient !== 'ALL') {
        console.log("ðŸ“Š Raporlar filtreleniyor. SeÃ§ili MÃ¼ÅŸteri:", selectedClient);

        // A) PortfÃ¶y Filtresi (Marka/Patent Sahibi)
        portfolioData = portfolioData.filter(item => 
            item.applicants && Array.isArray(item.applicants) && item.applicants.some(a => a.id === selectedClient)
        );

        // B) Hukuki Veri Filtresi (Dava/Ä°tiraz TarafÄ±)
        legalData = legalData.filter(item => {
            // Dava ise: client.id kontrolÃ¼
            if (item.client && item.client.id === selectedClient) return true;
            // Ä°tiraz ise: applicants (Marka sahibi) kontrolÃ¼
            if (item.applicants && Array.isArray(item.applicants) && item.applicants.some(a => a.id === selectedClient)) return true;
            return false;
        });

        // C) GÃ¶rev Filtresi (Ä°lgili MÃ¼ÅŸteri)
        taskData = taskData.filter(t => 
            t._relatedClientIds && t._relatedClientIds.includes(selectedClient)
        );
    }

    // Veri kontrolÃ¼ (Filtreleme sonrasÄ± boÅŸ kaldÄ±ysa)
    if (portfolioData.length === 0 && legalData.length === 0) {
        $('#world-map-markers').html('<div class="d-flex justify-content-center align-items-center h-100 text-muted">Bu mÃ¼ÅŸteri iÃ§in analiz edilecek veri bulunamadÄ±.</div>');
        // Eski grafikleri temizle
        $('#chart-portfolio-dist, #chart-legal-status, #chart-class-radar, #chart-budget-forecast').html('');
        // SayaÃ§larÄ± sÄ±fÄ±rla
        $('#rep-total-assets, #rep-total-countries, #rep-pending-tasks, #rep-active-legal, #rep-budget-est').text('0');
        $('#rep-stuck-list').html('');
        return;
    }

    // --- 2. ANALÄ°Z DEÄžÄ°ÅžKENLERÄ° ---
    let mapData = {};                 // Harita iÃ§in { "TR": 50, "DE": 10 }
    let uniqueCountries = new Set();  // Ãœlke sayÄ±sÄ±nÄ± bulmak iÃ§in
    let typeCounts = {};              // Donut grafik iÃ§in { "Marka": 100, "Patent": 20 }
    let classCounts = {};             // Radar grafik iÃ§in { "35": 50, "9": 30 }
    let budgetForecast = {};          // BÃ¼tÃ§e grafiÄŸi iÃ§in { "2025-11": 15000 }
    const monthNames = ["Ocak", "Åžubat", "Mart", "Nisan", "MayÄ±s", "Haziran", "Temmuz", "AÄŸustos", "EylÃ¼l", "Ekim", "KasÄ±m", "AralÄ±k"];

    // Tarih iÅŸlemleri iÃ§in yardÄ±mcÄ±lar
    const now = new Date();
    const sixMonthsAgo = new Date();
    sixMonthsAgo.setMonth(now.getMonth() - 6);
    const nextYear = new Date();
    nextYear.setFullYear(now.getFullYear() + 1);

    // --- 3. ANA DÃ–NGÃœ (PORTFÃ–Y VERÄ°SÄ° ANALÄ°ZÄ°) ---
    portfolioData.forEach(item => {
        // A) COÄžRAFÄ° VERÄ°
        let code = '';
        const originRaw = (item.origin || '').toString().toUpperCase();
        if (originRaw.includes('TURK') || originRaw.includes('TÃœRK')) { 
            code = 'TR'; 
        } else if (item.country || item.countryCode) { 
            code = (item.country || item.countryCode).toUpperCase().trim(); 
        }
        
        if (code && code.length === 2) {
            mapData[code] = (mapData[code] || 0) + 1;
            uniqueCountries.add(code);
        }

        // B) VARLIK TÃœRÃœ
        const t = item.iptype || item.type || 'Marka';
        typeCounts[t] = (typeCounts[t] || 0) + 1;

        // C) SINIFLAR (NICE)
        let classes = [];
        if (Array.isArray(item.goodsAndServicesByClass)) classes = item.goodsAndServicesByClass.map(c => c.classNo);
        else if (item.classes) classes = String(item.classes).split(',');
        
        classes.forEach(c => { 
            if(c) {
                const cleanC = c.toString().trim();
                classCounts[cleanC] = (classCounts[cleanC] || 0) + 1; 
            }
        });

        // D) BÃœTÃ‡E PROJEKSÄ°YONU (Yenileme Tarihine GÃ¶re)
        if (item.renewalDate) {
            // Tarihi objeye Ã§evir (Firebase Timestamp veya String olabilir)
            let rDate = item.renewalDate.toDate ? item.renewalDate.toDate() : new Date(item.renewalDate);
            
            // Sadece gelecek 12 ay iÃ§indekileri al
            if (rDate > now && rDate < nextYear) {
                const key = `${rDate.getFullYear()}-${rDate.getMonth()}`; // Ã–rn: 2025-10
                // Tahmini Maliyet (Yerli: 4500 TL, YurtdÄ±ÅŸÄ±: 15000 TL varsayÄ±mÄ±)
                const cost = (originRaw.includes('TURK')) ? 4500 : 15000; 
                budgetForecast[key] = (budgetForecast[key] || 0) + cost;
            }
        }
    });

    // --- 4. HARÄ°TA Ã‡Ä°ZÄ°MÄ° (jsVectorMap) ---
    const mapContainer = document.querySelector("#world-map-markers");
    mapContainer.innerHTML = ""; // Ã–nce temizle
    
    // Harita verisi boÅŸsa haritayÄ± Ã§izme
    if (Object.keys(mapData).length > 0) {
        new jsVectorMap({
            selector: '#world-map-markers',
            map: 'world',
            zoomButtons: true,
            zoomOnScroll: false,
            regionStyle: {
                initial: { fill: '#e3eaef', stroke: 'none', "stroke-width": 0 },
                hover: { fillOpacity: 0.7, cursor: 'pointer' }
            },
            visualizeData: {
                scale: ['#a2cffe', '#2e59d9'], // AÃ§Ä±k Mavi -> Koyu Mavi
                values: mapData
            },
            onRegionTooltipShow(event, tooltip, code) {
                const count = mapData[code] || 0;
                if (count > 0) {
                    tooltip.text(`<strong>${tooltip.text()}</strong>: ${count} Dosya`, true);
                }
            }
        });
    }

    // --- 5. KPI KARTLARINI DOLDUR ---
    $('#rep-total-assets').text(portfolioData.length);
    $('#rep-total-countries').text(uniqueCountries.size + ' Ãœlke');

    // Onay Bekleyen Ä°ÅŸler (Task Data'dan)
    const pendingTasks = taskData.filter(t => t.status === 'waiting_approval' || t.status === 'pending').length;
    $('#rep-pending-tasks').text(pendingTasks);

    // Aktif Hukuki SÃ¼reÃ§ler (SonuÃ§lanmamÄ±ÅŸ olanlar)
    const activeLegal = legalData.filter(l => {
        const s = (l.statusText || l.status || '').toLowerCase();
        return !s.includes('sonuÃ§') && !s.includes('kapalÄ±') && !s.includes('bit');
    }).length;
    $('#rep-active-legal').text(activeLegal);

    // Toplam Tahmini BÃ¼tÃ§e
    const totalBudget = Object.values(budgetForecast).reduce((a,b)=>a+b, 0);
    $('#rep-budget-est').text('â‚º' + totalBudget.toLocaleString('tr-TR'));


    // --- 6. KRÄ°TÄ°K TABLO: SÃœRÃœNCEMEDE KALAN Ä°ÅžLER ---
    // Filtre: StatÃ¼sÃ¼ 'baÅŸvuru/filed' OLAN ve Tarihi 6 aydan ESKÄ° olanlar
    const stuckItems = portfolioData.filter(item => {
        const status = (item.status || item.statusText || '').toLowerCase();
        const appDate = item.applicationDate ? (item.applicationDate.toDate ? item.applicationDate.toDate() : new Date(item.applicationDate)) : null;
        
        const isFiled = status === 'baÅŸvuru' || status === 'filed' || status === 'pending';
        return isFiled && appDate && appDate < sixMonthsAgo;
    }).sort((a,b) => {
        // En eskiden yeniye sÄ±rala
        const dateA = a.applicationDate.toDate ? a.applicationDate.toDate() : new Date(a.applicationDate);
        const dateB = b.applicationDate.toDate ? b.applicationDate.toDate() : new Date(b.applicationDate);
        return dateA - dateB;
    }).slice(0, 5); // Sadece en kritik 5 tanesi

    const stuckTableBody = $('#rep-stuck-list');
    stuckTableBody.empty();
    
    if (stuckItems.length === 0) {
        stuckTableBody.html('<tr><td colspan="4" class="text-center text-success py-3"><i class="fas fa-check-circle"></i> Harika! SÃ¼rÃ¼ncemede kalan iÅŸiniz bulunmuyor.</td></tr>');
    } else {
        stuckItems.forEach(item => {
            const appDate = item.applicationDate.toDate ? item.applicationDate.toDate() : new Date(item.applicationDate);
            const diffTime = Math.abs(now - appDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            
            stuckTableBody.append(`
                <tr>
                    <td><div class="font-weight-bold text-truncate" style="max-width: 150px;">${item.title || item.brandText}</div></td>
                    <td><span class="badge badge-light border">BaÅŸvuru AÅŸamasÄ±nda</span></td>
                    <td class="text-danger font-weight-bold">${diffDays} GÃ¼ndÃ¼r</td>
                    <td><small class="text-muted">Ä°lerleme Yok</small></td>
                </tr>
            `);
        });
    }

    // --- 7. APEXCHARTS GRAFÄ°KLERÄ° ---
    
    // Grafik Render YardÄ±mcÄ±sÄ±
    const renderChart = (id, options) => {
        const el = document.querySelector("#" + id);
        if(!el) return;
        el.innerHTML = "";
        const chart = new ApexCharts(el, { 
            fontFamily: 'inherit',
            theme: { mode: $('body').hasClass('dark-mode') ? 'dark' : 'light' },
            toolbar: { show: false }, 
            ...options 
        });
        chart.render();
    };

    // GRAFÄ°K A: VarlÄ±k TÃ¼rÃ¼ (Donut)
    renderChart('chart-portfolio-dist', {
        series: Object.values(typeCounts),
        labels: Object.keys(typeCounts),
        chart: { type: 'donut', height: 260 },
        colors: ['#4e73df', '#1cc88a', '#36b9cc'],
        legend: { position: 'bottom' },
        plotOptions: { pie: { donut: { size: '65%' } } }
    });

    // GRAFÄ°K B: Hukuki BaÅŸarÄ± Durumu (Bar)
    let legalStatusCounts = { 'Devam Eden': 0, 'Lehe (KazanÄ±lan)': 0, 'Aleyhe (Kaybedilen)': 0 };
    legalData.forEach(l => {
        const s = (l.statusText || l.status || '').toLowerCase();
        if (s.includes('kabul') || s.includes('kÄ±smen kabul') || s.includes('lehe')) legalStatusCounts['Lehe (KazanÄ±lan)']++;
        else if (s.includes('red') || s.includes('aleyhe')) legalStatusCounts['Aleyhe (Kaybedilen)']++;
        else legalStatusCounts['Devam Eden']++;
    });

    renderChart('chart-legal-status', {
        series: [{ name: 'Dosya SayÄ±sÄ±', data: Object.values(legalStatusCounts) }],
        chart: { type: 'bar', height: 260 },
        plotOptions: { bar: { borderRadius: 4, horizontal: true, distributed: true } },
        colors: ['#f6c23e', '#1cc88a', '#e74a3b'], // SarÄ±(Devam), YeÅŸil(Kazan), KÄ±rmÄ±zÄ±(Kaybet)
        xaxis: { categories: Object.keys(legalStatusCounts) },
        legend: { show: false }
    });

    // GRAFÄ°K C: SÄ±nÄ±f Analizi (Radar)
    const topClasses = Object.entries(classCounts).sort((a,b)=>b[1]-a[1]).slice(0, 6);
    renderChart('chart-class-radar', {
        series: [{ name: 'Marka SayÄ±sÄ±', data: topClasses.map(x => x[1]) }],
        chart: { type: 'radar', height: 260 },
        labels: topClasses.map(x => `SÄ±nÄ±f ${x[0]}`),
        fill: { opacity: 0.2 },
        stroke: { width: 2 },
        markers: { size: 4 },
        colors: ['#36b9cc']
    });

    // GRAFÄ°K D: BÃ¼tÃ§e Projeksiyonu (Bar)
    const sortedBudgetKeys = Object.keys(budgetForecast).sort();
    renderChart('chart-budget-forecast', {
        series: [{ name: 'Tahmini Tutar', data: sortedBudgetKeys.map(k => budgetForecast[k]) }],
        chart: { type: 'bar', height: 260 },
        colors: ['#4e73df'],
        xaxis: { categories: sortedBudgetKeys.map(k => {
            const [y, m] = k.split('-');
            return `${monthNames[parseInt(m)]} ${y}`;
        })},
        yaxis: { labels: { formatter: (val) => (val/1000).toFixed(1) + 'k' } },
        dataLabels: { enabled: false },
        tooltip: { y: { formatter: (val) => 'â‚º' + val.toLocaleString() } }
    });
};

// === 3. TÃœM EVENT LISTENER'LAR (DOCUMENT READY) ===
    $(document).ready(function() {
        
        // BaÅŸlangÄ±Ã§
        initTheme();
        const auth = getAuth(); 
        onAuthStateChanged(auth, (user) => { 
            if (user) initPortal(); 
            else window.location.href = 'index.html'; 
        });
        
        $('#logoutBtn').click(() => auth.signOut());

        // --- TABLO SIRALAMA CLICK ---
        $(document).on('click', 'th.sortable', function() {
            const table = $(this).closest('table');
            let containerId = table.closest('.tab-pane').attr('id');
            if(!containerId) containerId = table.parent().parent().attr('id'); 
            if($(this).closest('#invoices').length) containerId = 'invoices';

            const index = $(this).index();
            const type = $(this).data('sort') || 'text';
            if(containerId) window.sortTable(containerId, index, type);
        });

        // --- FÄ°LTRELEME TETÄ°KLEYÄ°CÄ°LERÄ° ---
        $('#menseFilter').off('change').on('change', window.applyMasterFilter);
        $('#portfolioSearchText').off('keyup').on('keyup', function() { window.applyMasterFilter(); });
        $('#portfolioDurumFilter').off('change').on('change', window.applyMasterFilter);
        $('#portfolioFilterBtn').off('click').on('click', window.applyMasterFilter);
        $('a[data-toggle="tab"]').on('shown.bs.tab', function(e) { window.applyMasterFilter(); });
        $('#taskSearchText').off('keyup').on('keyup', function() {window.applyTaskFilter(); });
        $('#taskStatusFilter').off('change').on('change', function() {window.applyTaskFilter(); });
        $('#applyTaskFilters').off('click').on('click', function() {window.applyTaskFilter();});
        $('#contractsSearchText').off('keyup').on('keyup', function() { 
            window.applyContractsFilter(); 
        });
        // --- FATURA FÄ°LTRELEME EVENTLERÄ° ---
        $('#invoiceSearchText').off('keyup').on('keyup', function() { 
            window.applyInvoiceFilter(); 
        });

        $('#invoiceDurumFilter').off('change').on('change', function() { 
            window.applyInvoiceFilter(); 
        });

        // --- RAPORLAR SEKMESÄ° TETÄ°KLEYÄ°CÄ°SÄ° ---
        // KullanÄ±cÄ± Raporlar sekmesine tÄ±kladÄ±ÄŸÄ±nda Ã§alÄ±ÅŸÄ±r
        $('a[data-toggle="tab"][href="#reports"]').on('shown.bs.tab', function (e) {
            // EÄŸer Marka verisi henÃ¼z Ã§ekilmediyse grafikler boÅŸ gelebilir,
            // ama initPortal zaten veriyi Ã§ekmiÅŸ olacaÄŸÄ± iÃ§in sorun olmaz.
            if (window.initReports) {
                window.initReports();
            }
        });

        // Filtre MenÃ¼sÃ¼nÃ¼ Kapatma
        $(document).on('click', function(e) {
            if (!$(e.target).closest('.column-filter-dropdown').length && !$(e.target).hasClass('filter-icon')) {
                $('.column-filter-dropdown').remove();
            }
        });

        // --- GÃ–REV VE DÄ°ÄžER Ä°ÅžLEMLER ---
        $(document).on('click', '.task-approve', async function() { 
            const taskId = String($(this).data('id'));
            if(confirm('Bu iÅŸi onaylamak istediÄŸinizden emin misiniz?')) { 
                try {
                    await updateDoc(doc(db, "tasks", taskId), { status: "open", approvalDate: new Date().toISOString() }); 
                    alert('Ä°ÅŸ baÅŸarÄ±yla onaylandÄ±!'); 
                    if(window.linkedPersonIds) window.fetchAndDisplayTasks(window.linkedPersonIds);
                    if($('#task-list-details').is(':visible')) {
                        const isBulletin = $(this).closest('.tab-pane').attr('id')?.startsWith('b-');
                        if(isBulletin) window.loadSampleTaskDetails('bulletin-watch');
                        else $(this).closest('.col-12.mb-4').fadeOut(300, function(){ $(this).remove(); });
                    }
                } catch(e) { alert("Hata: " + e.message); }
            } 
        });
        
        $(document).on('click', '.task-reject', async function() { 
            const taskId = String($(this).data('id'));
            const r = prompt('Red sebebi:'); 
            if(r) { 
                try {
                    await updateDoc(doc(db, "tasks", taskId), { status: "mÃ¼vekkil onayÄ± - kapatÄ±ldÄ±", rejectionDate: new Date().toISOString(), rejectionReason: r }); 
                    alert('Ä°ÅŸ reddedildi.'); 
                    if(window.linkedPersonIds) window.fetchAndDisplayTasks(window.linkedPersonIds);
                    $(this).closest('.col-12.mb-4').fadeOut(300, function(){ $(this).remove(); });
                } catch(e) { alert("Hata: " + e.message); }
            } 
        });

        // Navigasyon & Modallar
        // Ä°ÅŸlerim Ana Kart TÄ±klamasÄ±
        $('.task-card-link').click(function() { 
            $('.task-card-link').removeClass('active-task-area'); 
            $(this).addClass('active-task-area'); 
            const area = $(this).data('target-area'); 
            
            // Hepsini kapat
            $('#task-detail-cards').slideUp();
            $('#dava-task-detail-cards').slideUp(); // Bunu HTML'e ekleyeceÄŸiz
            $('#task-list-filters').slideUp();
            $('#task-list-details').slideUp();

            // Ä°lgili olanÄ± aÃ§
            if(area === 'marka-tasks') {
                $('#task-detail-cards').slideDown(); 
            } else if (area === 'dava-tasks') {
                $('#dava-task-detail-cards').slideDown(); 
            }
        });

        // Ä°ÅŸlerim Detay Kart TÄ±klamasÄ± (Onay Bekleyen, Yenileme vb.)
        $('.detail-card-link').click(function() { 
            const type = $(this).data('task-type'); 
            $('.detail-card-link').removeClass('active-list-type');
            $(this).addClass('active-list-type');

            $('#task-list-filters').slideDown(); // <--- BU SATIR EKLENDÄ°
            
            $('#task-list-details').slideDown(); 
            
            // InputlarÄ± temizle
            $('#taskSearchText').val('');
            $('#taskStatusFilter').val('TÃœMÃœ');
            
            window.loadSampleTaskDetails(type); 
        });
        
        $(document).on('click', '.task-compare-goods', async function() { 
            const taskId = $(this).data('task-id'); 
            const ipRecordId = $(this).data('ip-record-id'); 
            const bulletinKey = $(this).data('bulletin-key'); 
            const targetAppNo = $(this).data('target-app-no'); 
            $('#goodsComparisonModal').modal('show'); 
            $('#monitoredGoodsContent').html('<p class="text-muted">YÃ¼kleniyor...</p>'); 
            $('#competitorGoodsContent').html('<p class="text-muted">YÃ¼kleniyor...</p>'); 
            try { 
                const monitoredGoodsHtml = await loadGoodsFromIpRecord(ipRecordId); 
                $('#monitoredGoodsContent').html(monitoredGoodsHtml); 
                const competitorGoodsHtml = await loadGoodsFromMonitoringRecord(bulletinKey, ipRecordId, targetAppNo); 
                $('#competitorGoodsContent').html(competitorGoodsHtml); 
            } catch (error) { console.error(error); } 
        });

        // Detay Modal Linkleri
        $(document).on('click', '.portfolio-detail-link', async function(e) { 
            e.preventDefault(); 
            const itemId = $(this).data('item-id'); 
            let item = null; 
            if (window.markaPaginationData?.allDataUnfiltered) item = window.markaPaginationData.allDataUnfiltered.find(p => p.id === itemId);
            if (!item) return; 
            
            const title = item.title || item.brandText || 'Detaylar'; 
            $('#portfolioDetailModalLabel').text(title); 
            $('#modal-img').attr('src', item.brandImageUrl || 'https://placehold.co/150x150/png?text=Yok'); 
            
            const appDate = window.formatDateTR(item.applicationDate); 
            const regDate = window.formatDateTR(item.registrationDate); 
            const renDate = window.formatDateTR(item.renewalDate);
            const status = item.status || 'Bilinmiyor';
            const statusBadge = { 'Tescilli': 'success', 'BaÅŸvuru': 'primary' }[status] || 'warning';

            $('#modal-details-card').html(`<p><strong>TÃ¼r:</strong> ${item.type}</p><p><strong>B.No:</strong> ${item.applicationNumber}</p><p><strong>T.No:</strong> ${item.registrationNumber}</p>`); 
            $('#modal-dates-card').html(`<p><strong>BaÅŸvuru:</strong> ${appDate}</p><p><strong>Tescil:</strong> ${regDate}</p><p><strong>Yenileme:</strong> ${renDate}</p><p><span class="badge badge-${statusBadge}">${status}</span></p>`); 
            
            let esya = '<p class="text-muted">Veri yok.</p>';
            if(item.goodsAndServicesByClass) esya = item.goodsAndServicesByClass.map(c=>`<div><b>SÄ±nÄ±f ${c.classNo}</b>: ${c.items?.join(', ')}</div>`).join('<hr>');
            $('#esyaListesiContent').html(esya); 
            
            $('#modal-islemler table tbody').html('<tr><td colspan="4" class="text-center"><i class="fas fa-spinner fa-spin"></i></td></tr>'); 
            if (window.loadTransactions) await window.loadTransactions(item.id); 
            
            $('#myTab a[href="#modal-islemler"]').tab('show'); 
            $('#portfolioDetailModal').modal('show'); 
        });
        
        $('[data-target-tab]').on('click', function() { 
            const t = $(this).data('target-tab'); 
            $(`#sidebar a[href="#${t}"]`).tab('show'); 
            if(t === 'portfolio-content') setTimeout(() => { $('#portfolioTopTabs a[href="#marka-list"]').tab('show'); }, 100);
            window.scrollTo({ top: 0, behavior: 'smooth' }); 
        });
        
        $(document).on('click', '.dava-detail-link', function(e) { 
            e.preventDefault(); 
            const suitId = $(this).data('suit-id'); 
            const suit = window.suitsData?.find(s => s.id === suitId); 
            if (!suit) return; 
            
            $('#davaDetailModalLabel').text(suit.title); 
            $('#modal-dava-caseNo').text(suit.caseNo); 
            $('#modal-dava-title').text(suit.title); 
            $('#modal-dava-court').text(suit.court); 
            $('#modal-dava-openingDate').text(suit.openingDate); 
            $('#modal-dava-status').html(`<span class="badge badge-info">${suit.suitStatus}</span>`); 
            $('#modal-dava-opposingParty').text(suit.opposingParty); 
            $('#modal-dava-client').text(suit.clientName); 
            $('#davaDetailModal').modal('show'); 
        });
        
        $(document).on('click', '.task-detail', async function(e) { 
            e.preventDefault(); 
            const taskId = $(this).data('task-id'); 
            try { 
                const docSnap = await getDoc(doc(db, 'tasks', String(taskId))); 
                if (!docSnap.exists()) return alert('Ä°ÅŸlem bulunamadÄ±.'); 
                const ipId = docSnap.data().relatedIpRecordId; 
                if (ipId) { 
                    const $l = $('<a>', { 'class': 'portfolio-detail-link', 'data-item-id': ipId, 'href': '#' }); 
                    $('body').append($l); $l.trigger('click'); $l.remove(); 
                } else alert('KayÄ±t yok.'); 
            } catch(err) { console.error(err); } 
        });
    });

/* --- VEKALET/SÃ–ZLEÅžME MODÃœLÃœ (GÃœNCELLENMÄ°Åž) --- */
    
    // Sekmeye tÄ±klandÄ±ÄŸÄ±nda veriyi yÃ¼kle
    $('a[data-toggle="tab"][href="#contracts"]').on('shown.bs.tab', function (e) {
        // Veriler initPortal iÃ§inde zaten yÃ¼klendiÄŸi iÃ§in
        // doÄŸrudan filtreleme fonksiyonunu Ã§aÄŸÄ±rarak tabloyu tazeleyebiliriz.
        if (typeof window.applyContractsFilter === 'function') {
            window.applyContractsFilter();
        } else {
            console.warn("Filtreleme fonksiyonu henÃ¼z hazÄ±r deÄŸil.");
        }
    });

// KullanÄ±cÄ± verisi yÃ¼klendiÄŸinde (initPortal fonksiyonu iÃ§inde) bu deÄŸiÅŸkeni set ediyoruz.
// EÄŸer veritabanÄ±ndan veri geÃ§ geliyorsa burasÄ± veriyi global deÄŸiÅŸkenden okur.
    
// A) VEKALET FÄ°LTRELEME VE YÃ–NETÄ°M
    window.applyContractsFilter = function() {
        const searchText = $('#contractsSearchText').val().toLowerCase().trim();
        const rawData = window.contractsPaginationData.allDataUnfiltered || [];
        const selectedClient = window.selectedClientId; // Global MÃ¼ÅŸteri SeÃ§imi

        // Filtreleme
        const filtered = rawData.filter(doc => {
            // 1. MÃœÅžTERÄ° FÄ°LTRESÄ° (YENÄ° EKLENDÄ°)
            // EÄŸer "TÃ¼mÃ¼" seÃ§ili deÄŸilse ve belgenin sahibi seÃ§ili mÃ¼ÅŸteri deÄŸilse GÄ°ZLE.
            if (selectedClient && selectedClient !== 'ALL') {
                // ownerId yukarÄ±daki dÃ¼zeltme ile artÄ±k belgenin iÃ§inde var
                if (doc.ownerId && doc.ownerId !== selectedClient) return false;
            }

            // 2. Metin AramasÄ± (Mevcut kod)
            if (!searchText) return true;
            const searchSource = [
                doc.type || 'DiÄŸer',
                doc.countryName || '-',
                doc.ownerName || '' // MÃ¼ÅŸteri adÄ±nda da arama yapabilmesi iÃ§in
            ].join(' ').toLowerCase();
            return searchSource.includes(searchText);
        });

        // Veriyi gÃ¼ncelle ve tabloyu Ã§iz
        window.contractsPaginationData.allData = filtered;

        // Sayfalama (Pagination) YÃ¶netimi
        if (!window.contractsPaginationData.pagination && window.Pagination) {
            window.contractsPaginationData.pagination = new window.Pagination({
                itemsPerPage: 10,
                containerId: 'contractsPagination',
                onPageChange: (page, perPage) => {
                    const start = (page - 1) * perPage;
                    const slice = window.contractsPaginationData.allData.slice(start, start + perPage);
                    window.renderContractsTable(slice, start);
                }
            });
        }

        if (window.contractsPaginationData.pagination) {
            window.contractsPaginationData.pagination.update(filtered.length);
            window.contractsPaginationData.pagination.currentPage = 1;
            window.renderContractsTable(filtered.slice(0, 10), 0);
        } else {
            window.renderContractsTable(filtered, 0);
        }
    };

    // B) VEKALET TABLOSU RENDER (GÃœNCELLENMÄ°Åž)
    window.renderContractsTable = function(dataSlice, startIndex = 0) {
        const tbody = $('#contractsTableBody');
        const noMsg = $('#noContractsMessage');
        
        tbody.empty();

        if (!dataSlice || dataSlice.length === 0) {
            noMsg.show();
            return;
        }
        noMsg.hide();

        dataSlice.forEach((doc, index) => {
            // Tarih formatla
            let dateDisplay = '-';
            if (doc.validityDate) {
                let parts = doc.validityDate.split('-');
                if(parts.length === 3) dateDisplay = `${parts[2]}.${parts[1]}.${parts[0]}`;
            }
            
            // Link
            let actionHtml = doc.url 
                ? `<a href="${doc.url}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="fas fa-eye"></i> GÃ¶rÃ¼ntÃ¼le</a>`
                : `<span class="badge badge-secondary">Dosya Yok</span>`;

            let rowHtml = `
                <tr>
                    <td>${startIndex + index + 1}</td>
                    <td class="font-weight-bold text-primary">
                        <i class="fas fa-file-alt mr-2 text-muted"></i>${doc.type || 'DiÄŸer'}
                    </td>
                    <td>${doc.countryName || '-'}</td>
                    <td>${dateDisplay}</td>
                    <td class="text-center">${actionHtml}</td>
                </tr>
            `;
            tbody.append(rowHtml);
        });
    };
</script>
</body>
</html>