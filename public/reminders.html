<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPGATE - Bildirim Merkezi v3.1</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="./css/shared-styles.css">
    <style>
        :root { --primary-blue: #1e3c72; --dark-slate: #1e293b; --slate-600: #475569; --slate-200: #e2e8f0; }
        .page-wrapper { background: #f1f5f9; min-height: 100vh; }
        .main-container { padding-top: 100px; max-width: 950px; margin: 0 auto; padding-bottom: 80px; }

        /* Notification Container (Sağ Üst) */
        #notification-container {
            position: fixed; top: 20px; right: 20px; z-index: 9999;
            display: flex; flex-direction: column; gap: 10px;
        }

        /* Timeline Yapısı */
        .reminders-timeline { position: relative; padding-left: 50px; }
        .reminders-timeline::before {
            content: ''; position: absolute; left: 20px; top: 0; bottom: 0;
            width: 3px; background: #cbd5e0;
        }

        .reminder-number {
            position: absolute; left: -48px; top: 22px; width: 34px; height: 34px;
            background: var(--primary-blue); color: white;
            border: 3px solid white; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: 800; z-index: 2; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        /* --- KART TASARIMI (Derinlik ve Kontrast) --- */
        .reminder-card {
            background: white; border-radius: 16px; padding: 28px; margin-bottom: 28px;
            border: 1px solid rgba(30, 41, 59, 0.1);
            position: relative; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
        }
        .reminder-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.15);
            border-color: var(--primary-blue);
        }

        /* Okunmadı (Canlı) */
        .reminder-card.unread { background: #ffffff; border-top: 4px solid var(--primary-blue); }
        .reminder-card.unread .title-text { color: var(--dark-slate); font-weight: 800; }
        .unread-indicator { width: 12px; height: 12px; background: #3b82f6; border-radius: 50%; display: inline-block; margin-right: 12px; box-shadow: 0 0 8px rgba(59, 130, 246, 0.6); }

        /* Okundu (Sönük) */
        .reminder-card.read { background: #f8fafc; opacity: 0.85; border-left: 8px solid #94a3b8 !important; }
        .reminder-card.read .title-text { color: #64748b; font-weight: 600; }

        /* Aciliyet Şeritleri */
        .reminder-card.unread.overdue { border-left: 8px solid #dc2626; }
        .reminder-card.unread.today { border-left: 8px solid #ea580c; }
        .reminder-card.unread.upcoming { border-left: 8px solid #2563eb; }

        .icon-box { width: 55px; height: 55px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; flex-shrink: 0; }
        .icon-task { background: #dbeafe; color: #1e40af; }
        .icon-doc { background: #ffe4e6; color: #9f1239; }
        .icon-manual { background: #dcfce7; color: #166534; }

        /* Butonlar */
        .action-group { display: flex; gap: 15px; }
        .btn-action { font-size: 0.8rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.8px; border: none; background: transparent; padding: 5px 0; transition: 0.3s; cursor: pointer; }
        .btn-action.read-toggle-btn { color: #2563eb; }
        .btn-action.archive-btn { color: #dc2626; }

        .btn-incele { 
            background: var(--primary-blue); color: white !important; border-radius: 10px; font-weight: 700; padding: 10px 22px; 
            font-size: 0.85rem; box-shadow: 0 4px 6px rgba(30, 60, 114, 0.2); transition: 0.3s;
        }
        .btn-incele:hover { background: #0f172a; transform: scale(1.05); text-decoration: none; }

        .pagination-container { display: flex; justify-content: center; gap: 10px; margin-top: 50px; }
        .page-btn { border: 1px solid var(--slate-200); background: white; padding: 10px 20px; border-radius: 12px; font-weight: 700; cursor: pointer; }
        .page-btn.active { background: var(--primary-blue); color: white; }

        /* Modal */
        .modal.show { display: flex; align-items: center; justify-content: center; background: rgba(15, 23, 42, 0.6); }
    </style>
</head>
<body>
    <div id="notification-container"></div>
    
    <div id="layout-placeholder"></div>
    <div class="page-wrapper">
        <main class="main-container">
            <header class="d-flex justify-content-between align-items-center mb-5">
                <div>
                    <h1 class="font-weight-bold" style="color: #1e3c72; font-size: 2.4rem;">Hatırlatmalar Akış</h1>
                    <p class="text-muted" style="font-size: 1.1rem;">Süreç takibi ve kritik bildirimler.</p>
                </div>
                <button class="btn btn-primary rounded-pill px-4 shadow-lg" id="addReminderBtn" style="background: #1e3c72; border:none; height: 52px; font-weight: 700;">
                    <i class="fas fa-plus-circle mr-2"></i>Yeni Hatırlatma
                </button>
            </header>

            <ul class="nav nav-pills mb-4 bg-white p-2 rounded-xl shadow-sm" style="width: fit-content; border: 1px solid #e2e8f0;">
                <li class="nav-item"><a class="nav-link active" id="active-tab" data-toggle="pill" href="#">Gelen Kutusu <span class="badge badge-light ml-2" id="activeCount" style="color: #1e3c72;">0</span></a></li>
                <li class="nav-item"><a class="nav-link" id="closed-tab" data-toggle="pill" href="#">Arşiv</a></li>
            </ul>

            <div class="reminders-timeline" id="timelineContainer"></div>
            <div class="pagination-container" id="paginationControls"></div>
        </main>
    </div>

    <div id="reminderModal" class="modal">
        <div class="modal-content shadow-lg w-100 border-0" style="max-width: 600px; border-radius: 20px;">
            <div class="modal-header border-0 p-4 pb-0 d-flex justify-content-between">
                <h4 style="color: #1e3c72; font-weight: 700;">Yeni Not Oluştur</h4>
                <button class="close" id="closeReminderModal" style="cursor:pointer">&times;</button>
            </div>
            <form id="reminderForm" class="p-4">
                <div class="form-group mb-4">
                    <label class="small font-weight-bold text-muted mb-2 text-uppercase">Başlık</label>
                    <input type="text" id="reminderTitle" class="form-control" style="border-radius: 10px;" required>
                </div>
                <div class="form-row mb-4">
                    <div class="form-group col-md-6">
                        <label class="small font-weight-bold text-muted mb-2 text-uppercase">Kategori</label>
                        <select id="reminderCategory" class="form-control" style="border-radius: 10px;">
                            <option value="KİŞİSEL NOT">Genel Not</option>
                            <option value="TOPLANTI">Toplantı</option>
                            <option value="EVRAK">Evrak Takibi</option>
                        </select>
                    </div>
                    <div class="form-group col-md-6">
                        <label class="small font-weight-bold text-muted mb-2 text-uppercase">Tarih</label>
                        <input type="text" id="reminderDueDate" class="form-control" placeholder="gg.aa.yyyy" data-datepicker required>
                    </div>
                </div>
                <div class="form-group mb-4">
                    <label class="small font-weight-bold text-muted mb-2 text-uppercase">Mesaj</label>
                    <textarea id="reminderDescription" class="form-control" style="border-radius: 10px;" rows="3"></textarea>
                </div>
                <div class="modal-footer border-0 p-0 pt-2">
                    <button type="button" class="btn btn-light rounded-pill px-4" id="cancelReminderBtn">Vazgeç</button>
                    <button type="submit" class="btn btn-primary rounded-pill px-5" style="background: #1e3c72;">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { reminderService, auth, db } from './firebase-config.js';
        import { showNotification,formatToTRDate } from './utils.js';
        import { loadSharedLayout } from './js/layout-loader.js';
        import { collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        class RemindersTimelineModule {
            constructor() {
                this.combinedData = [];
                this.currentPage = 1;
                this.itemsPerPage = 10;
                this.activeTab = 'active';
            }

            async init() {
                await loadSharedLayout({ activeMenuLink: 'reminders.html' });
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        this.currentUser = user;
                        await this.loadAllSources();
                        this.setupEvents();
                        if (window.EvrekaDatePicker) window.EvrekaDatePicker.init();
                    }
                });
            }

            async loadAllSources() {
                const container = document.getElementById('timelineContainer');
                container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" style="width: 3rem; height: 3rem; color: #1e3c72 !important"></div></div>';

                try {
                    const [remRes, tasksSnap, personsSnap] = await Promise.all([
                        reminderService.getReminders(),
                        getDocs(collection(db, "tasks")),
                        getDocs(collection(db, "persons"))
                    ]);

                    const rawManual = remRes.success ? remRes.data : [];

                    // --- TASKLAR (365/180) ---
                    const taskReminders = tasksSnap.docs.map(doc => {
                        const d = doc.data();
                        if (d.status === 'completed') return null;
                        const date = d.taskDueDate || d.dueDate || d.officialDue || d.operationalDue;
                        if (!date) return null;
                        const diff = this.getDayDiff(date);
                        if (diff > 365 || diff < -180) return null;
                        return { id: doc.id, type: 'task', category: 'İŞ TAKİBİ', title: d.taskTitle || d.title || "İsimsiz İş", message: `<b>"${d.taskTitle || d.title}"</b> işine <b>${diff === 0 ? 'BUGÜN' : (diff > 0 ? diff + ' gün kaldı' : Math.abs(diff) + ' gün geçti')}</b>.`, dueDate: date, status: 'active', isRead: true, link: `task-update.html?id=${doc.id}` };
                    }).filter(Boolean);

                    // --- EVRAKLAR ---
                    const docReminders = [];
                    personsSnap.forEach(pDoc => {
                        const p = pDoc.data();
                        (p.documents || []).forEach((d, idx) => {
                            const diff = this.getDayDiff(d.validityDate);
                            if (diff <= 365 && diff >= -60) {
                                docReminders.push({ id: `${pDoc.id}_doc_${idx}`, type: 'doc', category: 'EVRAK SÜRESİ', title: `${d.type} Geçerlilik`, message: `<b>${p.name}</b> adına kayıtlı <b>${d.type}</b> belgesinin süresi doluyor (Kalan: ${diff} gün).`, dueDate: d.validityDate, status: 'active', isRead: false, link: 'persons.html' });
                            }
                        });
                    });

                    // --- MANUEL ---
                    const manualReminders = rawManual.map(r => ({ ...r, type: 'manual', category: r.category || 'KİŞİSEL NOT', message: r.description || r.title, dueDate: r.dueDate || r.date, isRead: r.isRead || false, status: r.status || 'active' }));

                    this.combinedData = [...manualReminders, ...taskReminders, ...docReminders]
                        .sort((a, b) => new Date(this.formatIsoDate(a.dueDate)) - new Date(this.formatIsoDate(b.dueDate)));

                    this.render();
                } catch (e) { console.error(e); }
            }

            render() {
                const container = document.getElementById('timelineContainer');
                const filtered = this.combinedData.filter(r => (this.activeTab === 'active' ? r.status !== 'completed' : r.status === 'completed'));
                document.getElementById('activeCount').textContent = this.combinedData.filter(r => r.status !== 'completed').length;

                const start = (this.currentPage - 1) * this.itemsPerPage;
                const pageItems = filtered.slice(start, start + this.itemsPerPage);

                if (pageItems.length === 0) {
                    container.innerHTML = '<div class="empty-state text-center py-5">Listelenecek bildirim yok.</div>';
                    document.getElementById('paginationControls').innerHTML = '';
                    return;
                }

                container.innerHTML = pageItems.map((item, idx) => {
                    const diff = this.getDayDiff(item.dueDate);
                    const urgency = diff < 0 ? 'overdue' : (diff <= 3 ? 'today' : (diff <= 15 ? 'upcoming' : ''));
                    const icon = item.type === 'task' ? 'fa-tasks' : (item.type === 'doc' ? 'fa-file-signature' : 'fa-sticky-note');
                    const iconColor = item.type === 'task' ? 'icon-task' : (item.type === 'doc' ? 'icon-doc' : 'icon-manual');

                    return `
                    <div class="reminder-card ${urgency} ${item.isRead ? 'read' : 'unread'}">
                        <div class="reminder-number">${start + idx + 1}</div>
                        <div class="d-flex align-items-start">
                            <div class="icon-box ${iconColor} mr-3 shadow-sm"><i class="fas ${icon}"></i></div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="category-text uppercase font-weight-bold">
                                        ${!item.isRead ? '<span class="unread-indicator"></span>' : ''}${item.category}
                                    </span>
                                    <span class="small text-muted font-weight-bold"><i class="far fa-clock mr-1"></i>${formatToTRDate(item.dueDate)}</span>
                                </div>
                                <h5 class="title-text mb-2">${item.title}</h5>
                                <p class="mb-4 text-secondary" style="line-height: 1.6;">${item.message}</p>
                                <div class="reminder-footer border-top pt-3 d-flex justify-content-between align-items-center">
                                    <div class="action-group">
                                        <button class="btn-action read-toggle-btn" data-id="${item.id}">
                                            <i class="fas ${item.isRead ? 'fa-envelope' : 'fa-envelope-open'} mr-1"></i>
                                            ${item.isRead ? 'Okunmadı İşaretle' : 'Oku'}
                                        </button>
                                        <button class="btn-action archive-btn" data-id="${item.id}">
                                            <i class="fas fa-archive mr-1"></i>Arşivle
                                        </button>
                                    </div>
                                    <a href="${item.link || '#'}" class="btn-incele">İncele <i class="fas fa-arrow-right ml-2"></i></a>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('');

                this.renderPagination(filtered.length);
            }

            getDayDiff(dStr) { const target = new Date(this.formatIsoDate(dStr)); if (isNaN(target)) return 999; target.setHours(0,0,0,0); const today = new Date(); today.setHours(0,0,0,0); return Math.round((target - today) / (1000 * 60 * 60 * 24)); }
            formatIsoDate(d) { if (!d || typeof d !== 'string') return d; if (d.includes('.')) { const p = d.split('.'); return `${p[2]}-${p[1]}-${p[0]}`; } return d; }

            renderPagination(totalItems) {
                const totalPages = Math.ceil(totalItems / this.itemsPerPage);
                const controls = document.getElementById('paginationControls');
                if (totalPages <= 1) { controls.innerHTML = ''; return; }
                let html = `<button class="page-btn" ${this.currentPage === 1 ? 'disabled' : ''} id="prevPage">Geri</button>`;
                for (let i = 1; i <= totalPages; i++) { html += `<button class="page-btn ${this.currentPage === i ? 'active' : ''}" data-page="${i}">${i}</button>`; }
                html += `<button class="page-btn" ${this.currentPage === totalPages ? 'disabled' : ''} id="nextPage">İleri</button>`;
                controls.innerHTML = html;
                controls.querySelectorAll('[data-page]').forEach(btn => { btn.onclick = () => { this.currentPage = parseInt(btn.dataset.page); this.render(); window.scrollTo(0,0); }; });
                const prev = document.getElementById('prevPage'); if(prev) prev.onclick = () => { this.currentPage--; this.render(); };
                const next = document.getElementById('nextPage'); if(next) next.onclick = () => { this.currentPage++; this.render(); };
            }

            setupEvents() {
                document.getElementById('active-tab').onclick = () => { this.activeTab = 'active'; this.currentPage = 1; this.render(); };
                document.getElementById('closed-tab').onclick = () => { this.activeTab = 'completed'; this.currentPage = 1; this.render(); };
                
                document.addEventListener('click', async (e) => {
                    const id = e.target.closest('[data-id]')?.dataset.id;
                    if (!id) return;
                    const item = this.combinedData.find(x => x.id === id);

                    if (e.target.closest('.read-toggle-btn')) {
                        const newState = !item.isRead;
                        if (item.type === 'manual') await reminderService.updateReminder(id, { isRead: newState });
                        item.isRead = newState;
                        showNotification(newState ? "Okundu işaretlendi." : "Okunmadı işaretlendi.", "success");
                        this.render();
                    }

                    if (e.target.closest('.archive-btn')) {
                        if (item.type === 'manual') await reminderService.updateReminder(id, { status: 'completed' });
                        item.status = 'completed';
                        showNotification("Bildirim arşive taşındı.", "info");
                        this.render();
                    }
                });

                document.getElementById('addReminderBtn').onclick = () => {
                    document.getElementById('reminderForm').reset();
                    document.getElementById('reminderModal').classList.add('show');
                };
                
                document.getElementById('closeReminderModal').onclick = () => document.getElementById('reminderModal').classList.remove('show');
                document.getElementById('cancelReminderBtn').onclick = () => document.getElementById('reminderModal').classList.remove('show');

                document.getElementById('reminderForm').onsubmit = async (e) => {
                    e.preventDefault();
                    const data = { title: document.getElementById('reminderTitle').value, description: document.getElementById('reminderDescription').value, dueDate: document.getElementById('reminderDueDate').value, category: document.getElementById('reminderCategory').value, userId: this.currentUser.uid, isRead: false, status: 'active', createdAt: new Date().toISOString() };
                    await reminderService.addReminder(data);
                    showNotification("Yeni hatırlatma başarıyla oluşturuldu.", "success");
                    document.getElementById('reminderModal').classList.remove('show');
                    await this.loadAllSources();
                };
            }
        }

        window.module = new RemindersTimelineModule();
        window.module.init();
    </script>
</body>
</html>