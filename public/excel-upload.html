<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toplu Portföy Yükleme | Evreka IP</title>
    
    <link rel="stylesheet" href="css/shared-styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
    
    <style>
        :root { --primary-color: #1e3c72; --primary-light: #eff6ff; --border-color: #e2e8f0; --text-dark: #0f172a; --text-gray: #64748b; --bg-body: #f8fafc; --card-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-dark); margin: 0; padding: 0; }
        .main-content { padding: 30px 40px; padding-top: 120px; width: 100%; box-sizing: border-box; max-width: 1600px; margin: 0 auto; }
        .page-header { margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
        .page-title h1 { font-size: 24px; font-weight: 700; color: var(--text-dark); margin: 0; display: flex; align-items: center; gap: 12px; }
        .page-title p { color: var(--text-gray); font-size: 14px; margin: 5px 0 0 0; }
        .card { background: white; border-radius: 12px; padding: 0; box-shadow: var(--card-shadow); border: 1px solid var(--border-color); margin-bottom: 25px; width: 100%; }
        .card-header { padding: 20px 25px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 12px; background: #fff; border-radius: 12px 12px 0 0; }
        .step-icon { width: 32px; height: 32px; background: var(--primary-light); color: var(--primary-color); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; }
        .card-title { font-size: 16px; font-weight: 600; color: var(--text-dark); margin: 0; }
        .card-body { padding: 25px; }
        .client-search-wrapper { position: relative; max-width: 600px; }
        .form-control { width: 100%; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background: #fff; transition: all 0.2s; }
        .form-control:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(30, 60, 114, 0.1); }
        .search-results { position: absolute; top: 105%; left: 0; right: 0; background: white; border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); max-height: 250px; overflow-y: auto; z-index: 50; display: none; }
        .search-item { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f1f5f9; font-size: 14px; display: flex; align-items: center; gap: 10px; }
        .search-item:hover { background-color: var(--primary-light); color: var(--primary-color); }
        .selected-clients-area { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px dashed var(--border-color); min-height: 50px; align-items: center; }
        .client-tag { background: white; color: var(--primary-color); padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 8px; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .client-tag i { cursor: pointer; color: #94a3b8; transition: 0.2s; }
        .client-tag i:hover { color: #ef4444; }
        .drop-zone { border: 2px dashed #cbd5e1; background: #f8fafc; border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .drop-zone:hover { border-color: var(--primary-color); background: var(--primary-light); }
        .drop-zone-icon { font-size: 40px; color: #94a3b8; margin-bottom: 15px; }
        .drop-zone h3 { margin: 0 0 5px 0; font-size: 16px; font-weight: 600; }
        .drop-zone p { margin: 0; font-size: 13px; color: var(--text-gray); }
        .progress-section { margin-top: 25px; display: none; }
        .progress-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; font-weight: 600; }
        .progress-track { height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary-color); width: 0%; transition: width 0.3s; }
        .error-report { margin-top: 25px; display: none; border: 1px solid #fee2e2; background: #fff5f5; border-radius: 8px; overflow: hidden; }
        .error-header { background: #ffe4e6; padding: 12px 20px; color: #9f1239; font-weight: 600; font-size: 14px; }
        .error-list { list-style: none; padding: 0; margin: 0; max-height: 250px; overflow-y: auto; }
        .error-item { padding: 10px 20px; border-bottom: 1px solid #fecaca; font-size: 13px; color: #881337; }
        .status-log { margin-top: 20px; background: #0f172a; color: #e2e8f0; padding: 15px; border-radius: 8px; font-family: 'Consolas', monospace; font-size: 12px; max-height: 200px; overflow-y: auto; display: none; }
        .log-item { margin-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 2px; }
        .log-success { color: #4ade80; }
        .log-error { color: #f87171; }
        .btn-restart { margin-top: 20px; padding: 12px 24px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-weight: 500; cursor: pointer; display: none; float: right; }
        .btn-restart:hover { background: #162c55; }
        @media (max-width: 768px) { .main-content { padding: 20px; padding-top: 100px; } }
    </style>
</head>
<body>
    <div id="layout-placeholder"></div>

    <div class="main-content">
        <div class="page-header">
            <div class="page-title">
                <h1><i class="fas fa-file-import" style="color: #1e3c72; margin-right: 10px;"></i> Excel Portföy Yükleme</h1>
                <p>Toplu portföy verilerini doğrulayarak güvenli bir şekilde sisteme aktarın.</p>
            </div>
        </div>

        <div class="card">
            <div class="card-header"><div class="step-icon">1</div><h3 class="card-title">Müşteri Seçimi</h3></div>
            <div class="card-body">
                <div class="form-group">
                    <label style="display:block; margin-bottom: 8px; font-weight: 500; font-size: 14px;">Müşteri Arayın</label>
                    <div class="client-search-wrapper">
                        <input type="text" id="clientSearchInput" class="form-control" placeholder="Müşteri adı veya unvanı yazın...">
                        <div id="searchResults" class="search-results"></div>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label style="display:block; margin-bottom: 8px; font-weight: 500; font-size: 14px;">Seçili Müşteriler</label>
                    <div id="selectedClientsList" class="selected-clients-area">
                        <span style="color: #94a3b8; font-size: 13px;">Listeye eklemek için yukarıdan arama yapın.</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header"><div class="step-icon">2</div><h3 class="card-title">Dosya Yükleme</h3></div>
            <div class="card-body">
                <div id="dropZone" class="drop-zone">
                    <input type="file" id="fileInput" accept=".xlsx" style="display: none;">
                    <i class="fas fa-file-excel drop-zone-icon"></i>
                    <h3>Excel Dosyasını Buraya Sürükleyin</h3>
                    <p>veya dosya seçmek için tıklayın (.xlsx)</p>
                </div>
            </div>
        </div>

        <div class="card" id="statusCard" style="display:none;">
            <div class="card-header"><div class="step-icon"><i class="fas fa-check"></i></div><h3 class="card-title">İşlem Durumu</h3></div>
            <div class="card-body">
                <div id="progressContainer" class="progress-section">
                    <div class="progress-header"><span id="progressText">Analiz ediliyor...</span><span id="progressPercent">0%</span></div>
                    <div class="progress-track"><div id="progressFill" class="progress-fill"></div></div>
                </div>
                <div id="errorReport" class="error-report">
                    <div class="error-header"><i class="fas fa-exclamation-triangle mr-2"></i><span>Aktarılamayan Kayıtlar (<span id="errorCountHeader">0</span>)</span></div>
                    <ul id="errorList" class="error-list"></ul>
                </div>
                <div id="statusLog" class="status-log"></div>
                <div style="overflow: hidden;">
                    <button id="restartBtn" class="btn-restart"><i class="fas fa-sync-alt mr-2"></i> Yeni İşlem Başlat</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, storage, ipRecordsService, auth } from './firebase-config.js'; 
        import { collection, getDocs, query, orderBy, where, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        import { loadSharedLayout } from './js/layout-loader.js';
        
        const MAX_CONCURRENT_UPLOADS = 5; 
        
        let ALL_COUNTRIES = []; 
        let ALL_CLIENTS = []; 
        let SELECTED_CLIENTS = []; 
        let FAILED_ROWS = [];
        let elements = {}; 

        const ENGLISH_TO_CODE_MAP = {
        // A
        "Afghanistan": "AF", "Albania": "AL", "Algeria": "DZ", "American Samoa": "AS", "Andorra": "AD", "Angola": "AO", "Anguilla": "AI", "Antarctica": "AQ", "Antigua and Barbuda": "AG", "Argentina": "AR", "Armenia": "AM", "Aruba": "AW", "Australia": "AU", "Austria": "AT", "Azerbaijan": "AZ",
        // B
        "Bahamas": "BS", "Bahrain": "BH", "Bangladesh": "BD", "Barbados": "BB", "Belarus": "BY", "Belgium": "BE", "Belize": "BZ", "Benin": "BJ", "Bermuda": "BM", "Bhutan": "BT", "Bolivia": "BO", "Bosnia and Herzegovina": "BA", "Botswana": "BW", "Brazil": "BR", "British Indian Ocean Territory": "IO", "Brunei": "BN", "Bulgaria": "BG", "Burkina Faso": "BF", "Burundi": "BI",
        // C
        "Cabo Verde": "CV", "Cambodia": "KH", "Cameroon": "CM", "Canada": "CA", "Cayman Islands": "KY", "Central African Republic": "CF", "Chad": "TD", "Chile": "CL", "China": "CN", "Christmas Island": "CX", "Cocos (Keeling) Islands": "CC", "Colombia": "CO", "Comoros": "KM", "Congo": "CG", "Congo, Democratic Republic of": "CD", "Cook Islands": "CK", "Costa Rica": "CR", "Croatia": "HR", "Cuba": "CU", "Curaçao": "CW", "Cyprus": "CY", "Czech Republic": "CZ", "Czechia": "CZ",
        // D
        "Denmark": "DK", "Djibouti": "DJ", "Dominica": "DM", "Dominican Republic": "DO",
        // E
        "Ecuador": "EC", "Egypt": "EG", "El Salvador": "SV", "Equatorial Guinea": "GQ", "Eritrea": "ER", "Estonia": "EE", "Eswatini": "SZ", "Ethiopia": "ET",
        // F
        "Falkland Islands": "FK", "Faroe Islands": "FO", "Fiji": "FJ", "Finland": "FI", "France": "FR", "French Guiana": "GF", "French Polynesia": "PF",
        // G
        "Gabon": "GA", "Gambia": "GM", "Georgia": "GE", "Germany": "DE", "Ghana": "GH", "Gibraltar": "GI", "Greece": "GR", "Greenland": "GL", "Grenada": "GD", "Guadeloupe": "GP", "Guam": "GU", "Guatemala": "GT", "Guernsey": "GG", "Guinea": "GN", "Guinea-Bissau": "GW", "Guyana": "GY",
        // H
        "Haiti": "HT", "Honduras": "HN", "Hong Kong": "HK", "Hungary": "HU",
        // I
        "Iceland": "IS", "India": "IN", "Indonesia": "ID", "Iran": "IR", "Iraq": "IQ", "Ireland": "IE", "Isle of Man": "IM", "Israel": "IL", "Italy": "IT", "Ivory Coast": "CI",
        // J
        "Jamaica": "JM", "Japan": "JP", "Jersey": "JE", "Jordan": "JO",
        // K
        "Kazakhstan": "KZ", "Kenya": "KE", "Kiribati": "KI", "Korea, North": "KP", "Korea, South": "KR", "South Korea": "KR", "North Korea": "KP", "Kuwait": "KW", "Kyrgyzstan": "KG",
        // L
        "Laos": "LA", "Latvia": "LV", "Lebanon": "LB", "Lesotho": "LS", "Liberia": "LR", "Libya": "LY", "Liechtenstein": "LI", "Lithuania": "LT", "Luxembourg": "LU",
        // M
        "Macao": "MO", "Madagascar": "MG", "Malawi": "MW", "Malaysia": "MY", "Maldives": "MV", "Mali": "ML", "Malta": "MT", "Marshall Islands": "MH", "Martinique": "MQ", "Mauritania": "MR", "Mauritius": "MU", "Mayotte": "YT", "Mexico": "MX", "Micronesia": "FM", "Moldova": "MD", "Monaco": "MC", "Mongolia": "MN", "Montenegro": "ME", "Montserrat": "MS", "Morocco": "MA", "Mozambique": "MZ", "Myanmar": "MM",
        // N
        "Namibia": "NA", "Nauru": "NR", "Nepal": "NP", "Netherlands": "NL", "New Caledonia": "NC", "New Zealand": "NZ", "Nicaragua": "NI", "Niger": "NE", "Nigeria": "NG", "Niue": "NU", "North Macedonia": "MK", "Macedonia": "MK", "Norway": "NO",
        // O
        "Oman": "OM",
        // P
        "Pakistan": "PK", "Palau": "PW", "Palestine": "PS", "Panama": "PA", "Papua New Guinea": "PG", "Paraguay": "PY", "Peru": "PE", "Philippines": "PH", "Poland": "PL", "Portugal": "PT", "Puerto Rico": "PR",
        // Q
        "Qatar": "QA",
        // R
        "Réunion": "RE", "Romania": "RO", "Russia": "RU", "Russian Federation": "RU", "Rwanda": "RW",
        // S
        "Saint Kitts and Nevis": "KN", "Saint Lucia": "LC", "Saint Vincent and the Grenadines": "VC", "Samoa": "WS", "San Marino": "SM", "Sao Tome and Principe": "ST", "Saudi Arabia": "SA", "Senegal": "SN", "Serbia": "RS", "Seychelles": "SC", "Sierra Leone": "SL", "Singapore": "SG", "Sint Maarten": "SX", "Slovakia": "SK", "Slovenia": "SI", "Solomon Islands": "SB", "Somalia": "SO", "South Africa": "ZA", "South Sudan": "SS", "Spain": "ES", "Sri Lanka": "LK", "Sudan": "SD", "Suriname": "SR", "Sweden": "SE", "Switzerland": "CH", "Syria": "SY",
        // T
        "Taiwan": "TW", "Tajikistan": "TJ", "Tanzania": "TZ", "Thailand": "TH", "Timor-Leste": "TL", "Togo": "TG", "Tokelau": "TK", "Tonga": "TO", "Trinidad and Tobago": "TT", "Tunisia": "TN", "Turkey": "TR", "Türkiye": "TR", "Turkmenistan": "TM", "Turks and Caicos Islands": "TC", "Tuvalu": "TV",
        // U
        "Uganda": "UG", "Ukraine": "UA", "United Arab Emirates": "AE", "United Kingdom": "GB", "United States": "US", "United States of America": "US", "Uruguay": "UY", "Uzbekistan": "UZ",
        // V
        "Vanuatu": "VU", "Vatican City": "VA", "Venezuela": "VE", "Vietnam": "VN", "Virgin Islands, British": "VG", "Virgin Islands, U.S.": "VI",
        // W, Y, Z
        "Wallis and Futuna": "WF", "Western Sahara": "EH", "Yemen": "YE", "Zambia": "ZM", "Zimbabwe": "ZW",
        // Special / Regional
        "European Union": "EUIPO", 
        "African Intellectual Property Organization": "OAPI",
        "OAPI": "OAPI",
        "Benelux": "BX",
        "Benelux (Belgium, Netherlands, Luxembourg)": "BX",
        "Turkish Republic of Northern Cyprus": "TRNC"
    };

        document.addEventListener('DOMContentLoaded', () => {
             loadSharedLayout({ activeMenuLink: 'excel-upload.html' });

             elements = {
                dropZone: document.getElementById('dropZone'),
                fileInput: document.getElementById('fileInput'),
                clientSearchInput: document.getElementById('clientSearchInput'),
                searchResults: document.getElementById('searchResults'),
                selectedClientsList: document.getElementById('selectedClientsList'),
                statusCard: document.getElementById('statusCard'), 
                progressContainer: document.getElementById('progressContainer'),
                progressFill: document.getElementById('progressFill'),
                progressText: document.getElementById('progressText'),
                progressPercent: document.getElementById('progressPercent'),
                statusLog: document.getElementById('statusLog'),
                restartBtn: document.getElementById('restartBtn'),
                errorReport: document.getElementById('errorReport'),
                errorList: document.getElementById('errorList'),
                errorCountHeader: document.getElementById('errorCountHeader')
            };

            if (elements.dropZone && elements.fileInput) {
                elements.dropZone.onclick = () => elements.fileInput.click();
                elements.fileInput.onchange = (e) => { if(e.target.files.length) handleFile(e.target.files[0]); };
                elements.dropZone.ondragover = (e) => { e.preventDefault(); elements.dropZone.style.background = "#eff6ff"; elements.dropZone.style.borderColor = "#1e3c72"; };
                elements.dropZone.ondragleave = (e) => { e.preventDefault(); elements.dropZone.style.background = "#f8fafc"; elements.dropZone.style.borderColor = "#cbd5e1"; };
                elements.dropZone.ondrop = (e) => { e.preventDefault(); if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); };
            }

            if (elements.clientSearchInput) {
                elements.clientSearchInput.addEventListener('input', (e) => filterClients(e.target.value));
                document.addEventListener('click', (e) => { if (!e.target.closest('.client-search-wrapper')) elements.searchResults.style.display = 'none'; });
            }

            init();
        });

        async function init() {
            try { await Promise.all([loadClients(), loadCountries()]); } catch (e) { log(e.message, 'error'); }
        }

        async function loadClients() {
            try {
                const q = query(collection(db, "persons"), orderBy("name"));
                const snap = await getDocs(q);
                ALL_CLIENTS = [];
                snap.forEach(doc => { ALL_CLIENTS.push({ id: doc.id, name: doc.data().name, email: doc.data().email || "" }); });
            } catch(e) { console.error("Müşteri yükleme hatası", e); }
        }

        async function loadCountries() {
            try {
                const docRef = doc(db, 'common', 'countries');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) ALL_COUNTRIES = docSnap.data().list || [];
            } catch (e) { console.error(e); }
        }

        function filterClients(searchText) {
            if (!searchText || searchText.length < 2) { elements.searchResults.style.display = 'none'; return; }
            const lowerText = searchText.toLowerCase();
            const filtered = ALL_CLIENTS.filter(c => c.name.toLowerCase().includes(lowerText));
            renderSearchResults(filtered);
        }

        function renderSearchResults(results) {
            elements.searchResults.innerHTML = '';
            if (results.length === 0) { elements.searchResults.style.display = 'none'; return; }
            results.forEach(client => {
                const div = document.createElement('div');
                div.className = 'search-item';
                div.innerHTML = `<i class="fas fa-user-circle"></i> ${client.name}`;
                div.onclick = () => addSelectedClient(client);
                elements.searchResults.appendChild(div);
            });
            elements.searchResults.style.display = 'block';
        }

        function addSelectedClient(client) {
            if (SELECTED_CLIENTS.some(c => c.id === client.id)) { elements.clientSearchInput.value = ''; elements.searchResults.style.display = 'none'; return; }
            SELECTED_CLIENTS.push(client);
            renderSelectedClients();
            elements.clientSearchInput.value = '';
            elements.searchResults.style.display = 'none';
        }

        function removeSelectedClient(clientId) {
            SELECTED_CLIENTS = SELECTED_CLIENTS.filter(c => c.id !== clientId);
            renderSelectedClients();
        }

        function renderSelectedClients() {
            elements.selectedClientsList.innerHTML = '';
            if (SELECTED_CLIENTS.length === 0) { elements.selectedClientsList.innerHTML = '<span style="color: #94a3b8; font-size: 13px;">Listeye eklemek için arama yapın.</span>'; return; }
            SELECTED_CLIENTS.forEach(client => {
                const tag = document.createElement('div');
                tag.className = 'client-tag';
                tag.innerHTML = `<span>${client.name}</span><i class="fas fa-times" onclick="window.removeClientGlobal('${client.id}')"></i>`;
                elements.selectedClientsList.appendChild(tag);
            });
        }
        window.removeClientGlobal = (id) => removeSelectedClient(id);

        function formatDateForDataEntry(cellValue) {
            if (!cellValue) return null;
            let dateObj = null;
            if (cellValue instanceof Date) dateObj = cellValue;
            else {
                const d = new Date(cellValue);
                if (!isNaN(d.getTime())) dateObj = d;
            }
            if (dateObj) {
                const year = dateObj.getFullYear();
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const day = String(dateObj.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            return null;
        }

        function mapStatus(statusText) {
            if (!statusText) return 'filed'; // Boşsa Başvuru (filed) kabul et
            
            const s = String(statusText).trim().toLowerCase();

            // 1. TESCİLLİ (Registered) - Sadece "valid" geçenler
            if (s.includes('valid') && !s.includes('invalid')) { 
                // "invalid" kelimesi de "valid" içerdiği için hariç tutuyoruz
                return 'registered';
            }

            // 2. GEÇERSİZ (Invalidated) - "expired" veya "invalid" geçenler
            if (s.includes('expired') || s.includes('invalid')) {
                return 'rejected';
            }

            // 3. BAŞVURU (Filed) - Diğer her şey
            return 'filed'; 
        }

        function getCountryCode(countryName) {
            if (!countryName) return null; // DEĞİŞİKLİK: Bulunamadığında TR yerine null dönüyor
            const search = String(countryName).trim();
            if (!search) return null;

            const searchLower = search.toLowerCase();
            
            // 2 harfli kod kuralı
            if (search.length === 2) {
                return search.toUpperCase();
            }

            if (ENGLISH_TO_CODE_MAP[search]) return ENGLISH_TO_CODE_MAP[search];
            if (searchLower.includes('european union')) return 'EUIPO'; 
            if (searchLower.includes('african intellectual')) return 'OAPI'; 
            if (searchLower.includes('wipo')) return 'WO'; 
            if (searchLower.includes('aripo')) return 'AP';
            
            // Firestore verisinden kontrol
            if (Array.isArray(ALL_COUNTRIES)) {
                const found = ALL_COUNTRIES.find(c => c.name.toLowerCase() === searchLower);
                if (found) return found.code;
            }
            
            // Eğer "Turkey" veya varyasyonları ise manuel TR döndür
            if (searchLower === 'turkey' || searchLower === 'türkiye' || searchLower === 'turkiye') return 'TR';

            return null; // Hiçbir eşleşme yoksa null
        }

        function parseGoodsAndServicesStructured(text) {
            if (!text) return { classes: [], goodsByClass: [] };
            const regex = /\[(\d+)\]:\s*([\s\S]*?)(?=\s*\[\d+\]:|$)/g;
            const goodsByClass = [];
            const classes = [];
            let match;
            let foundMatch = false;
            while ((match = regex.exec(text)) !== null) {
                foundMatch = true;
                const cls = match[1];
                const desc = match[2].trim();
                if (!classes.includes(cls)) classes.push(cls);
                goodsByClass.push({ classNo: cls, items: [desc] });
            }
            if (!foundMatch && text.trim().length > 0) {
                return { classes: [], goodsByClass: [], raw: text.trim() };
            }
            return { classes, goodsByClass };
        }

        function log(msg, type = 'info') {
            if (!elements.statusLog) return;
            elements.statusLog.style.display = 'block';
            const div = document.createElement('div');
            div.className = `log-item log-${type}`;
            div.innerHTML = `<span style="opacity:0.6">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
            elements.statusLog.appendChild(div);
            elements.statusLog.scrollTop = elements.statusLog.scrollHeight;
        }

        function updateProgress(current, total) {
            if (!elements.progressFill) return;
            const percent = Math.round((current / total) * 100);
            elements.progressFill.style.width = `${percent}%`;
            elements.progressPercent.textContent = `${percent}%`;
            elements.progressText.textContent = `${current}/${total} İşlendi`;
        }

        function addErrorToReport(rowNumber, name, message) {
            FAILED_ROWS.push({ rowNumber, name, message });
            elements.errorReport.style.display = 'block';
            elements.errorCountHeader.textContent = FAILED_ROWS.length;
            const li = document.createElement('li');
            li.className = 'error-item';
            li.innerHTML = `<span class="error-badge">Satır ${rowNumber}</span><div><strong>${name || 'İsimsiz Kayıt'}</strong>: ${message}</div>`;
            elements.errorList.appendChild(li);
        }

        async function checkDuplicate(appNo, regNo, countryCode) {
            if (appNo) {
                const qApp = query(collection(db, "ipRecords"), where("applicationNumber", "==", String(appNo)), where("country", "==", countryCode));
                const snapApp = await getDocs(qApp);
                if (!snapApp.empty) return true;
            }
            if (regNo) {
                const qReg = query(collection(db, "ipRecords"), where("registrationNumber", "==", String(regNo)), where("country", "==", countryCode));
                const snapReg = await getDocs(qReg);
                if (!snapReg.empty) return true;
            }
            return false;
        }

        async function uploadImageToStorage(buffer, extension, brandName) {
            try {
                const safeName = brandName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                const filename = `brand-logos/${Date.now()}_${safeName}.${extension}`;
                const storageRef = ref(storage, filename);
                const blob = new Blob([buffer], { type: `image/${extension}` });
                await uploadBytes(storageRef, blob);
                const url = await getDownloadURL(storageRef);
                return url;
            } catch (error) {
                console.error("Resim yükleme hatası:", error);
                return null;
            }
        }

        function extractImagesFromSheet(workbook, sheet) {
            const imageMap = {};
            if (!sheet || typeof sheet.getImages !== 'function') return imageMap;

            const images = sheet.getImages();
            if (!images || images.length === 0) return imageMap;
            images.forEach(img => {
                const rowIndex = img.range.tl.nativeRow + 1; 
                const colIndex = img.range.tl.nativeCol;
                if (colIndex === 1) { 
                    const media = workbook.getImage(img.imageId);
                    if (media) {
                        imageMap[rowIndex] = { buffer: media.buffer, extension: media.extension };
                    }
                }
            });
            return imageMap;
        }

        async function handleFile(file) {
            if (SELECTED_CLIENTS.length === 0) { alert("Lütfen en az bir müşteri seçin!"); elements.fileInput.value = ''; return; }

            const currentUser = auth.currentUser;
            const currentUserId = currentUser ? currentUser.uid : "";
            const currentUserEmail = currentUser ? currentUser.email : "";
            const currentUserName = currentUser ? (currentUser.displayName || currentUser.email) : "Sistem";

            elements.statusCard.style.display = 'block'; 
            elements.dropZone.style.pointerEvents = 'none'; 
            elements.dropZone.style.opacity = '0.5';

            elements.progressContainer.style.display = 'block';
            elements.errorReport.style.display = 'none';
            elements.errorList.innerHTML = '';
            FAILED_ROWS = [];

            log(`Dosya okunuyor: ${file.name}`, 'info');

            const workbook = new ExcelJS.Workbook();
            try { await workbook.xlsx.load(file); } catch (err) {
                alert("Dosya yüklenirken hata oluştu.");
                elements.dropZone.style.pointerEvents = 'auto';
                elements.dropZone.style.opacity = '1';
                return;
            }

            let sheet = workbook.getWorksheet(1);
            if (!sheet && workbook.worksheets.length > 0) sheet = workbook.worksheets[0];

            if (!sheet) {
                alert("Excel dosyasında okunabilir bir çalışma sayfası bulunamadı!");
                elements.dropZone.style.pointerEvents = 'auto';
                elements.dropZone.style.opacity = '1';
                return;
            }
            
            const rowImages = extractImagesFromSheet(workbook, sheet);
            
            const rowsToProcess = [];
            sheet.eachRow((row, rowNumber) => {
                if (rowNumber === 1) return;
                if (!row.getCell(1).value) return;

                const rawData = {
                    rowNumber,
                    Name: row.getCell(1).text,
                    Registry: row.getCell(3).text,
                    Status: row.getCell(4).text,
                    Classes: row.getCell(5).text, 
                    "Goods and services": row.getCell(6).text,
                    "App. no.": row.getCell(7).text,
                    "Reg. no": row.getCell(8).text,
                    "App. date": row.getCell(9).value,
                    "Reg. date": row.getCell(10).value,
                    "Exp. date": row.getCell(11).value,
                    "Representative": row.getCell(12).text,
                    "Jurisdictions": row.getCell(13).text
                };
                rowsToProcess.push(rawData);
            });

            const totalRows = rowsToProcess.length;
            log(`${totalRows} adet kayıt bulundu. İşlem başlıyor...`, 'info');

            let processedCount = 0;
            let successCount = 0;
            let errorCount = 0;

            const processRow = async (rowData) => {
                try {
                    if (!rowData.Name || rowData.Name.trim().length === 0) throw new Error("Marka adı (Name) boş olamaz.");
                    
                    const formattedBrandText = rowData.Name.replace(/\n/g, ' ').trim().toLowerCase();

                    let uploadedImageUrl = null;
                    if (rowImages[rowData.rowNumber]) {
                        const imgData = rowImages[rowData.rowNumber];
                        uploadedImageUrl = await uploadImageToStorage(imgData.buffer, imgData.extension, formattedBrandText);
                    }

                    const parsedGS = parseGoodsAndServicesStructured(rowData["Goods and services"]);
                    let finalNiceClasses = parsedGS.classes;
                    let finalGoodsByClass = parsedGS.goodsByClass;
                    
                    if (finalNiceClasses.length === 0) {
                        const classCol = rowData["Classes"];
                        if (classCol) finalNiceClasses = String(classCol).split(',').map(c => c.trim().replace(/\D/g, ''));
                        if (parsedGS.raw) {
                            const mainClass = finalNiceClasses.length > 0 ? finalNiceClasses[0] : '0';
                            finalGoodsByClass = [{ classNo: mainClass, items: [parsedGS.raw] }];
                        }
                    }

                    let rawJurisdictions = rowData.Jurisdictions || "";
                    if (rawJurisdictions.includes("Benelux (Belgium, Netherlands, Luxembourg)")) {
                        rawJurisdictions = rawJurisdictions.replace("Benelux (Belgium, Netherlands, Luxembourg)", "BX");
                    }
                    const isWipo = rowData.Registry === "INT WIPO" && rawJurisdictions.includes(",");
                    const mappedStatus = mapStatus(rowData.Status);
                    const appDateStr = formatDateForDataEntry(rowData["App. date"]);
                    const regDateStr = formatDateForDataEntry(rowData["Reg. date"]);
                    const expDateStr = formatDateForDataEntry(rowData["Exp. date"]);
                    const now = new Date().toISOString();
                    const applicantsArray = SELECTED_CLIENTS.map(client => ({
                        id: client.id, name: client.name, email: client.email
                    }));

                    let appNum = rowData["App. no."] ? String(rowData["App. no."]) : "";
                    let regNum = rowData["Reg. no"] ? String(rowData["Reg. no"]) : "";

                    const baseData = {
                        applicants: applicantsArray, 
                        title: formattedBrandText, 
                        brandText: formattedBrandText,
                        brandCategory: "Ticaret/Hizmet Markası",
                        brandImageUrl: uploadedImageUrl,
                        status: mappedStatus,
                        applicationNumber: appNum,
                        registrationNumber: regNum,
                        applicationDate: appDateStr,
                        registrationDate: regDateStr,
                        renewalDate: expDateStr,
                        representative: rowData.Representative ? rowData.Representative.trim() : "",
                        niceClasses: finalNiceClasses,
                        goodsAndServicesByClass: finalGoodsByClass,
                        source: "Excel Import",
                        createdFrom: "excel_upload", 
                        type: "trademark",
                        ipType: "trademark",
                        portfolioStatus: "Active",
                        createdAt: now,
                        updatedAt: now
                    };

                    let createdRecords = [];

                    if (isWipo) {
                        const wipoAppNoToCheck = baseData.registrationNumber;
                        const isDuplicate = await checkDuplicate(wipoAppNoToCheck, wipoAppNoToCheck, 'WO');

                        if (isDuplicate) throw new Error(`Bu kayıt zaten sistemde mevcut! (WIPO: ${wipoAppNoToCheck})`);

                        const countryCodes = rawJurisdictions.split(',')
                            .map(c => c.trim())
                            .filter(c => c.length > 0)
                            .map(cName => getCountryCode(cName) || 'TR'); // DEĞİŞİKLİK: Bulunamazsa varsayılan TR

                        if (countryCodes.length === 0) throw new Error("WIPO ülke listesi boş.");

                        const wipoParentData = {
                            ...baseData,
                            countries: countryCodes, 
                            transactionHierarchy: "parent",
                            origin: "WIPO",
                            applicationNumber: baseData.registrationNumber, 
                            applicationDate: baseData.registrationDate,
                            internationalRegNumber: baseData.registrationNumber,
                            wipoIR: baseData.registrationNumber
                        };

                        const parentResult = await ipRecordsService.addRecord(wipoParentData);
                        if (!parentResult.success) throw new Error("WIPO Parent hatası: " + parentResult.error);
                        createdRecords.push({ id: parentResult.id || parentResult.data?.id, role: 'parent' });

                        const countryNames = rawJurisdictions.split(',').map(c => c.trim()).filter(c => c.length > 0);
                        
                        for (const countryName of countryNames) {
                            const childCode = getCountryCode(countryName) || 'TR'; // DEĞİŞİKLİK
                            const childRes = await ipRecordsService.addRecord({
                                ...baseData,
                                country: childCode,
                                transactionHierarchy: "child",
                                parentId: parentResult.id || parentResult.data?.id,
                                origin: "WIPO",
                                wipoIR: baseData.registrationNumber
                            });
                            if(childRes.success) {
                                createdRecords.push({ id: childRes.id || childRes.data?.id, role: 'parent' });
                            }
                        }
                    } else {
                        // --- TEKİL KAYIT İŞLEME VE FALLBACK MANTIĞI ---
                        
                        // 1. Önce Jurisdiction hücresini al (Varsa)
                        let countryInput = rawJurisdictions.split(',')[0].trim();
                        let countryCode = getCountryCode(countryInput);
                        
                        // 2. Eğer Jurisdiction boşsa VEYA tanımsızsa (null), Registry'ye bak
                        if (!countryCode && rowData.Registry) {
                            // "BR INPI" -> "BR" olarak ilk kelimeyi al
                            const registryParts = rowData.Registry.trim().split(/[\s,-]+/);
                            if (registryParts.length > 0) {
                                const registryInput = registryParts[0].trim(); 
                                const registryCode = getCountryCode(registryInput);
                                if (registryCode) {
                                    countryCode = registryCode;
                                }
                            }
                        }

                        // 3. Hiçbiri yoksa TR
                        if (!countryCode) countryCode = "TR";
                        
                        const isDuplicate = await checkDuplicate(baseData.applicationNumber, baseData.registrationNumber, countryCode);
                        if (isDuplicate) {
                             throw new Error(`Bu kayıt zaten mevcut! (App: ${baseData.applicationNumber} / Reg: ${baseData.registrationNumber})`);
                        }

                        let originValue = "Yurtdışı Ulusal";
                        if (countryCode === "EUIPO") originValue = "EUIPO";
                        if (countryCode === "OAPI") originValue = "OAPI";

                        const res = await ipRecordsService.addRecord({
                            ...baseData,
                            country: countryCode,
                            transactionHierarchy: "parent",
                            origin: originValue 
                        });
                        
                        if(!res.success) throw new Error("Kayıt hatası: " + res.error);
                        createdRecords.push({ id: res.id || res.data?.id, role: 'parent' });
                    }

                    for (const rec of createdRecords) {
                        let descriptionText = "Başvuru işlemi.";
                        if (rec.role === 'child') descriptionText = "Ülke başvurusu işlemi.";

                        await ipRecordsService.addTransactionToRecord(rec.id, {
                            type: "2", 
                            transactionTypeId: "2",
                            designation: "Başvuru",
                            description: descriptionText,
                            transactionHierarchy: rec.role,
                            userId: currentUserId,
                            userEmail: currentUserEmail,
                            userName: currentUserName,
                            timestamp: now,
                            createdFrom: "excel_upload"
                        });
                    }

                    successCount++;
                } catch (err) {
                    errorCount++;
                    const name = rowData.Name ? rowData.Name.replace(/\n/g, ' ').trim() : "Bilinmeyen Kayıt";
                    addErrorToReport(rowData.rowNumber, name, err.message);
                    log(`Satır ${rowData.rowNumber} Atlandı: ${err.message}`, 'error');
                } finally {
                    processedCount++;
                    updateProgress(processedCount, totalRows);
                }
            };

            for (let i = 0; i < rowsToProcess.length; i += MAX_CONCURRENT_UPLOADS) {
                const chunk = rowsToProcess.slice(i, i + MAX_CONCURRENT_UPLOADS);
                await Promise.all(chunk.map(row => processRow(row)));
            }

            const resultMsg = `İŞLEM BİTTİ: ${successCount} Aktarıldı, ${errorCount} Başarısız.`;
            log(resultMsg, errorCount > 0 ? 'error' : 'success');
            if (errorCount > 0) alert(resultMsg + "\nLütfen hata raporunu inceleyiniz.");
            
            elements.restartBtn.style.display = 'block';
        }
    </script>
</body>
</html>