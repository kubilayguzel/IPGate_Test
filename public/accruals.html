<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPGATE - Tahakkuk Yönetimi</title>
    <link rel="shortcut icon" href="./evreka-logo.png" type="image/png">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    
    <link rel="stylesheet" href="./css/shared-styles.css">
    <link rel="stylesheet" href="./css/task-management.css">
    
    <style>
        .page-wrapper {
            display: flex; flex-direction: column; height: 100vh; overflow-y: hidden;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .main-container {
            flex-grow: 1; padding: 20px 30px; overflow-y: auto; padding-top: 120px;
            display: flex; flex-direction: column;
        }
        .page-header { 
            background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); 
            flex-shrink: 0;
        }
        .page-title { font-size: 2em; color: #1e3c72; margin-bottom: 10px; }
        .page-subtitle { color: #666; font-size: 1.1em; }

        /* --- YENİ FİLTRE TASARIMI (Marka İzleme Sayfası Stili) --- */
        .filter-section {
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 20px; /* Yuvarlatılmış köşeler */
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            animation: fadeIn 0.3s ease-in;
            display: block; /* Varsayılan görünür */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .filter-controls {
            display: flex;
            gap: 15px;
            align-items: flex-end; /* Alt hizalama */
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-label {
            font-size: 0.85em;
            color: #666;
            font-weight: 600;
            margin-bottom: 0;
        }

        .filter-input, .filter-select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            background-color: #fff;
        }

        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: #1e3c72;
            box-shadow: 0 0 0 3px rgba(30, 60, 114, 0.1);
        }

        .clear-filters-btn {
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            height: 42px; /* Inputlarla aynı yükseklik */
        }

        .clear-filters-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        /* Konteyner */
        .accruals-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            padding-bottom: 20px;
            flex-shrink: 0;
            height: auto;
        }

        .accruals-header {
            padding: 20px 30px;
            border-bottom: 1px solid #e1e8ed;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        /* Statü Rozetleri */
        .status-badge { padding: 5px 10px; border-radius: 12px; font-size: 0.8em; font-weight: 500; text-align: center; color: white;}
        .status-paid { background-color: #28a745; }
        .status-unpaid { background-color: #dc3545; }
        .status-partially-paid { background-color: #ffc107; color: #333 !important; }

        .loading { text-align: center; padding: 50px; display: none; }
        .no-records { text-align: center; padding: 50px; color: #666; display: none; }
        
        .modal { display: none; position: fixed; z-index: 1002; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 30px; border: 1px solid #888; width: 90%; max-width: 1000px; border-radius: 20px; max-height: 90vh; overflow-y: auto; }
        .close-modal-btn { float: right; font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa; }
        
        .form-input, .form-select, .form-control { width: 100%; padding: 12px 15px; border: 2px solid #e1e8ed; border-radius: 10px; font-size: 1em; }
        .form-group { margin-bottom: 15px; }
        
        .accruals-table { width: 100%; border-collapse: collapse; }
        .accruals-table th, .accruals-table td { padding: 15px; text-align: left; border-bottom: 1px solid #f0f0f0; }
        .accruals-table th { background: #f8f9fa; font-weight: 600; cursor: pointer; user-select: none; white-space: nowrap; }
        
        .action-btn { background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; margin-left: 5px; }
        .action-btn.unpaid { background-color: #dc3545; }
        .action-btn:disabled { background-color: #6c757d; cursor: not-allowed; }
        
        .card { border: 1px solid rgba(0,0,0,.125); border-radius: .25rem; background-color: #fff; display: flex; flex-direction: column; }
        .card-body { flex: 1 1 auto; padding: 1.25rem; }
        .bg-light { background-color: #f8f9fa !important; }
        .shadow-sm { box-shadow: 0 .125rem .25rem rgba(0,0,0,.075) !important; }
        .hover-primary:hover { color: #007bff !important; transform: scale(1.1); transition: all 0.2s; }
    </style>
</head>
<body>
    <div id="layout-placeholder"></div>
    <div id="notification-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

    <div class="page-wrapper">
        <main class="main-container">
            <section class="page-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="page-title">Tahakkuk Yönetimi</h1>
                        <p class="page-subtitle">Sistemdeki tüm tahakkuk kayıtlarını görüntüleyin ve yönetin.</p>
                    </div>
                        <div class="d-flex align-items-center gap-2" style="gap: 10px;">
                        <button type="button" class="btn btn-primary font-weight-bold shadow-sm" id="btnCreateFreestyleAccrual">
                            <i class="fas fa-plus-circle mr-2"></i>Serbest Tahakkuk
                        </button>
                        <div class="btn-group">
                            <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown">
                                <i class="fas fa-file-excel mr-1"></i>Excel İşlemleri
                            </button>
                        <div class="dropdown-menu dropdown-menu-right">
                            <a class="dropdown-item" href="#" id="btnExportSelectedAccruals">
                                <i class="fas fa-check-square mr-2"></i>Seçilileri Aktar
                            </a>
                            <a class="dropdown-item" href="#" id="btnExportAllAccruals">
                                <i class="fas fa-list mr-2"></i>Listeyi Aktar
                            </a>
                        </div>
                    </div>
                </div>
            </section>

            <div class="filter-section">
                <div class="filter-controls">
                    <div class="filter-group">
                        <label class="filter-label">Başlangıç Tarihi</label>
                        <input type="text" id="filterStartDate" class="filter-input" placeholder="gg.aa.yyyy" data-datepicker>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Bitiş Tarihi</label>
                        <input type="text" id="filterEndDate" class="filter-input" placeholder="gg.aa.yyyy" data-datepicker>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Durum</label>
                        <select id="filterStatus" class="filter-select" style="min-width: 130px;">
                            <option value="all">Tümü</option>
                            <option value="paid">Ödendi</option>
                            <option value="unpaid">Ödenmedi</option>
                            <option value="partially_paid">Kısmen Ödendi</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Alan</label>
                        <select id="filterField" class="filter-select" style="min-width: 120px;">
                            <option value="">Tümü</option>
                            <option value="Marka">Marka</option>
                            <option value="Patent">Patent</option>
                            <option value="Tasarım">Tasarım</option>
                            <option value="Dava">Dava</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Taraf</label>
                        <input type="text" id="filterParty" class="filter-input" placeholder="Örn: Türk Patent..." style="width: 150px;">
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">İlgili Dosya No</label>
                        <input type="text" id="filterFileNo" class="filter-input" placeholder="Dosya No..." style="width: 140px;">
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Konu</label>
                        <input type="text" id="filterSubject" class="filter-input" placeholder="Marka/Konu adı..." style="width: 150px;">
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">İlgili İş</label>
                        <input type="text" id="filterTask" class="filter-input" placeholder="İş tanımı..." style="width: 150px;">
                    </div>

                    <button type="button" id="btnClearFilters" class="clear-filters-btn">
                        <i class="fas fa-times mr-1"></i>Temizle
                    </button>
                </div>
            </div>

            <div class="accruals-container">
                <div class="accruals-header">
                    <div id="bulkActions" class="d-flex align-items-center ml-auto" style="display: none !important; gap: 10px;">
                        <button id="bulkMarkPaidBtn" class="action-btn">
                            <i class="fas fa-check mr-1"></i> Seçilenleri Ödendi İşaretle
                        </button>
                        <button id="bulkMarkUnpaidBtn" class="action-btn" style="background-color: #dc3545;">
                            <i class="fas fa-times mr-1"></i> Seçilenleri Ödenmedi Yap
                        </button>
                    </div>
                </div>

                <ul class="nav nav-tabs px-4 pt-3 border-bottom-0" id="accrualTabs" role="tablist" style="background: #f8f9fa;">
                    <li class="nav-item">
                        <a class="nav-link active font-weight-bold" id="tab-main" data-toggle="tab" href="#content-main" role="tab" style="color:#1e3c72;">
                            <i class="fas fa-list mr-2"></i>Tüm Tahakkuklar
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link font-weight-bold" id="tab-foreign" data-toggle="tab" href="#content-foreign" role="tab" style="color:#dc3545;">
                            <i class="fas fa-globe-americas mr-2"></i>Yurt Dışı Ödemeler
                        </a>
                    </li>
                </ul>

                <div class="tab-content">
                    <div class="tab-pane fade show active" id="content-main" role="tabpanel">
                        <div class="table-container">
                            <table class="accruals-table">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;"><input type="checkbox" id="selectAllCheckbox"></th>
                                        <th class="sortable" data-sort="id">ID <i class="fas fa-sort sort-icon"></i></th>
                                        <th class="sortable" data-sort="createdAt">Tarih <i class="fas fa-sort sort-icon"></i></th>
                                        <th class="sortable" data-sort="type">Tür <i class="fas fa-sort sort-icon"></i></th> <th>Alan</th>
                                        <th class="sortable" data-sort="status">Durum <i class="fas fa-sort sort-icon"></i></th>
                                        <th>İlgili Dosya</th>
                                        <th class="sortable" data-sort="subject">Konu <i class="fas fa-sort sort-icon"></i></th>
                                        <th class="sortable" data-sort="taskTitle">İlgili İş <i class="fas fa-sort sort-icon"></i></th>
                                        <th class="sortable" data-sort="party">Taraf <i class="fas fa-sort sort-icon"></i></th>
                                        <th>TFN</th>
                                        <th>EFN</th>
                                        <th class="sortable" data-sort="officialFee">Resmi Ü.<i class="fas fa-sort sort-icon"></i></th>
                                        <th class="sortable" data-sort="serviceFee">Hizmet Ü.<i class="fas fa-sort sort-icon"></i></th>
                                        <th class="sortable" data-sort="totalAmount">Toplam <i class="fas fa-sort sort-icon"></i></th>
                                        <th class="sortable" data-sort="remainingAmount">Kalan <i class="fas fa-sort sort-icon"></i></th>
                                        <th>İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody id="accrualsTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="content-foreign" role="tabpanel">
                        <div class="table-container">
                             <table class="accruals-table">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;"><input type="checkbox" id="selectAllCheckboxForeign"></th>
                                        <th class="sortable" data-sort="id">ID <i class="fas fa-sort sort-icon"></i></th>
                                        <th class="sortable" data-sort="status">Durum <i class="fas fa-sort sort-icon"></i></th>
                                        <th class="sortable" data-sort="taskTitle">İlgili İş <i class="fas fa-sort sort-icon"></i></th>
                                        <th>Ödeme Yapılacak Taraf</th>
                                        <th class="sortable" data-sort="officialFee">Toplam Tutar <i class="fas fa-sort sort-icon"></i></th>
                                        <th class="sortable" data-sort="remainingAmount">Kalan Tutar <i class="fas fa-sort sort-icon"></i></th>
                                        <th>Ödeme Belgesi</th>
                                    </tr>
                                 </thead>
                                 <tbody id="foreignTableBody"></tbody>
                             </table>
                        </div>
                    </div>
                </div>

                <div id="loadingIndicator" class="loading">Yükleniyor...</div>
                <div id="noRecordsMessage" class="no-records">Kayıt bulunamadı.</div>
                
                <div id="paginationControls" class="pagination-container" style="display:flex; justify-content:center; padding:20px;"></div>
            </div>
        </main>
    </div>

    <div class="modal" id="editAccrualModal">
        <div class="modal-content">
            <span class="close-modal-btn" id="closeEditAccrualModal">&times;</span>
            <h3 class="modal-title">Tahakkuku Düzenle</h3>
            <form id="editAccrualForm" onsubmit="return false;">
                <input type="hidden" id="editAccrualId">
                <div class="modal-body-content">
                    <div class="form-group">
                        <label for="editAccrualTaskTitleDisplay" class="form-label">İlgili İş</label>
                        <input type="text" id="editAccrualTaskTitleDisplay" class="form-input" readonly style="background-color: #f8f9fa;">
                    </div>
                    <div id="editAccrualFormContainer"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelEditAccrualBtn">İptal</button>
                    <button type="button" class="btn btn-primary" id="saveAccrualChangesBtn">Değişiklikleri Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="markPaidModal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close-modal-btn" id="closeMarkPaidModal">&times;</span>
            <div class="modal-header border-0 pb-0 px-0">
                <h3 class="modal-title text-primary"><i class="fas fa-cash-register mr-2"></i>Ödeme Girişi</h3>
            </div>
            <div class="modal-body-content mt-3">
                <div class="alert alert-info py-2 small">
                    <i class="fas fa-info-circle mr-1"></i> <strong id="paidAccrualCount">0</strong> adet kayıt seçildi.
                </div>
                <div class="form-group">
                    <label class="form-label font-weight-bold text-dark">Ödeme Tarihi</label>
                    <input type="text" id="paymentDate" class="form-input" placeholder="gg.aa.yyyy" data-datepicker>
                </div>

                <div id="detailedPaymentInputs" class="mt-4" style="display: none;">
                    <div class="card mb-3 border bg-light shadow-sm">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="mb-0 font-weight-bold text-secondary">Resmi Ücret</label>
                                <span id="officialFeeBadge" class="badge badge-secondary p-2">0.00 TRY</span>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <input type="checkbox" id="payFullOfficial" checked style="width: 18px; height: 18px; cursor: pointer;">
                                <label for="payFullOfficial" class="mb-0 ml-2 cursor-pointer small">Tamamını Öde</label>
                            </div>
                            <div id="officialAmountInputContainer" style="display: none;">
                                <div class="input-group">
                                    <input type="number" id="manualOfficialAmount" class="form-control" placeholder="Ödenen Tutar" step="0.01">
                                    <div class="input-group-append">
                                        <span class="input-group-text font-weight-bold small" id="manualOfficialCurrencyLabel">TRY</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card mb-3 border bg-light shadow-sm">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="mb-0 font-weight-bold text-secondary">Hizmet Bedeli</label>
                                <span id="serviceFeeBadge" class="badge badge-secondary p-2">0.00 TRY</span>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <input type="checkbox" id="payFullService" checked style="width: 18px; height: 18px; cursor: pointer;">
                                <label for="payFullService" class="mb-0 ml-2 cursor-pointer small">Tamamını Öde</label>
                            </div>
                            <div id="serviceAmountInputContainer" style="display: none;">
                                <div class="input-group">
                                    <input type="number" id="manualServiceAmount" class="form-control" placeholder="Ödenen Tutar" step="0.01">
                                    <div class="input-group-append">
                                        <span class="input-group-text font-weight-bold small" id="manualServiceCurrencyLabel">TRY</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="foreignPaymentInputs" class="mt-4" style="display: none;">
                    <div class="card mb-3 border bg-light shadow-sm">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <label class="mb-0 font-weight-bold text-secondary">Toplam Tutar (Resmi Ücret)</label>
                                <span id="foreignTotalBadge" class="badge badge-primary p-2" style="font-size: 1em;">0.00 EUR</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <input type="checkbox" id="payFullForeign" checked style="width: 18px; height: 18px; cursor: pointer;">
                                <label for="payFullForeign" class="mb-0 ml-2 cursor-pointer font-weight-bold">Tamamını Öde</label>
                            </div>
                        </div>
                    </div>

                    <div id="foreignSplitInputs" style="display: none;">
                        <div class="card mb-3 border bg-light shadow-sm">
                            <div class="card-body p-3">
                                <label class="font-weight-bold text-secondary mb-2">Resmi Ücret Tutarı</label>
                                <div class="input-group">
                                    <input type="number" id="manualForeignOfficial" class="form-control" placeholder="0.00" step="0.01">
                                    <div class="input-group-append">
                                        <span class="input-group-text small foreign-currency-label font-weight-bold">EUR</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card mb-2 border bg-light shadow-sm">
                            <div class="card-body p-3">
                                <label class="font-weight-bold text-secondary mb-2">Yurtdışı Vekil Hizmet Ücreti</label>
                                <div class="input-group">
                                    <input type="number" id="manualForeignService" class="form-control" placeholder="0.00" step="0.01">
                                    <div class="input-group-append">
                                        <span class="input-group-text small foreign-currency-label font-weight-bold">EUR</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <small class="text-danger font-italic">* Girdiğiniz tutarların toplamı ödenen tutar olarak işlenecektir.</small>
                        </div>
                    </div>
                </div>

                <div class="form-group mt-3">
                    <label class="form-label font-weight-bold">Ödeme Dekontu</label>
                    <div class="file-upload-area-modal" id="paymentReceiptFileUploadArea" style="padding: 15px; border-style: dashed; border-color: #ccc; text-align:center; cursor:pointer;">
                        <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                        <div class="small text-muted">Dekont yüklemek için tıklayın</div>
                        <input type="file" id="paymentReceiptFile" multiple hidden accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                    </div>
                    <div class="file-list-modal mt-2" id="paymentReceiptFileList"></div>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-secondary" id="cancelMarkPaidBtn">İptal</button>
                <button type="button" class="btn btn-primary px-4" id="confirmMarkPaidBtn"><i class="fas fa-check mr-2"></i>Onayla</button>
            </div>
        </div>
    </div>

    <div class="modal" id="viewAccrualDetailModal">
        <div class="modal-content">
            <span class="close-modal-btn" id="closeViewAccrualDetailModal">&times;</span>
            <h3 class="modal-title" id="viewAccrualTitle">Tahakkuk Detayı</h3>
            <div class="modal-body-content"></div>
        </div>
    </div>

    <div id="taskDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn" id="closeTaskDetailModal">&times;</span>
            <h3 class="modal-title" id="modalTaskTitle">İş Detayı</h3>
            <div id="modalBody" class="modal-body-content"></div>
        </div>
    </div>
    
    <div class="modal" id="freestyleAccrualModal">
        <div class="modal-content">
            <span class="close-modal-btn" id="closeFreestyleAccrualModal">&times;</span>
            <div class="modal-header border-0 pb-0 px-0 mb-3">
                <h3 class="modal-title text-primary"><i class="fas fa-plus-circle mr-2"></i>Serbest Tahakkuk Oluştur</h3>
            </div>
            <p class="text-muted small mb-4">Bu tahakkuk herhangi bir işe (task) veya dosyaya (IP Record) bağlı olmadan, doğrudan müvekkile (veya karşı tarafa) kesilen bağımsız bir masraf kaydıdır.</p>
            
            <form id="freestyleAccrualForm" onsubmit="return false;">
                <div class="modal-body-content">
                    <div id="freestyleAccrualFormContainer"></div>
                </div>
                <div class="modal-footer mt-4 border-0 pt-0">
                    <button type="button" class="btn btn-secondary" id="cancelFreestyleAccrualBtn">İptal</button>
                    <button type="button" class="btn btn-primary px-4" id="saveFreestyleAccrualBtn"><i class="fas fa-save mr-2"></i>Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="./js/simple-loading.js"></script>
    <script type="module" src="./js/accrual-management/main.js"></script>
</body>
</html>